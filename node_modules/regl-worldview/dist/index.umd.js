var ReglWorldview=function(e,t){"use strict";var n="default"in t?t.default:t;function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){i(e,t,n[t])})}return e}var a="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function s(e,t){return e(t={exports:{}},t.exports),t.exports}var c="object"==typeof a&&a&&a.Object===Object&&a,u="object"==typeof self&&self&&self.Object===Object&&self,f=c||u||Function("return this")(),l=f.Symbol,p=Object.prototype,h=p.hasOwnProperty,d=p.toString,m=l?l.toStringTag:void 0;var v=function(e){var t=h.call(e,m),n=e[m];try{e[m]=void 0}catch(e){}var r=d.call(e);return t?e[m]=n:delete e[m],r},g=Object.prototype.toString;var b=function(e){return g.call(e)},y="[object Null]",x="[object Undefined]",w=l?l.toStringTag:void 0;var _=function(e){return null==e?void 0===e?x:y:w&&w in Object(e)?v(e):b(e)};var C=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},A="[object AsyncFunction]",j="[object Function]",S="[object GeneratorFunction]",k="[object Proxy]";var E,O=function(e){if(!C(e))return!1;var t=_(e);return t==j||t==S||t==A||t==k},M=f["__core-js_shared__"],P=(E=/[^.]+$/.exec(M&&M.keys&&M.keys.IE_PROTO||""))?"Symbol(src)_1."+E:"";var T=function(e){return!!P&&P in e},D=Function.prototype.toString;var z=function(e){if(null!=e){try{return D.call(e)}catch(e){}try{return e+""}catch(e){}}return""},F=/^\[object .+?Constructor\]$/,I=Function.prototype,B=Object.prototype,R=I.toString,L=B.hasOwnProperty,H=RegExp("^"+R.call(L).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var W=function(e){return!(!C(e)||T(e))&&(O(e)?H:F).test(z(e))};var N=function(e,t){return null==e?void 0:e[t]};var U=function(e,t){var n=N(e,t);return W(n)?n:void 0},G=function(){try{var e=U(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();var K=function(e,t,n){"__proto__"==t&&G?G(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n};var V=function(e){return function(t,n,r){for(var i=-1,o=Object(t),a=r(t),s=a.length;s--;){var c=a[e?s:++i];if(!1===n(o[c],c,o))break}return t}}();var q=function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r};var $=function(e){return null!=e&&"object"==typeof e},Y="[object Arguments]";var Z=function(e){return $(e)&&_(e)==Y},X=Object.prototype,Q=X.hasOwnProperty,J=X.propertyIsEnumerable,ee=Z(function(){return arguments}())?Z:function(e){return $(e)&&Q.call(e,"callee")&&!J.call(e,"callee")},te=Array.isArray;var ne=function(){return!1},re=s(function(e,t){var n=t&&!t.nodeType&&t,r=n&&e&&!e.nodeType&&e,i=r&&r.exports===n?f.Buffer:void 0,o=(i?i.isBuffer:void 0)||ne;e.exports=o}),ie=9007199254740991,oe=/^(?:0|[1-9]\d*)$/;var ae=function(e,t){var n=typeof e;return!!(t=null==t?ie:t)&&("number"==n||"symbol"!=n&&oe.test(e))&&e>-1&&e%1==0&&e<t},se=9007199254740991;var ce=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=se},ue={};ue["[object Float32Array]"]=ue["[object Float64Array]"]=ue["[object Int8Array]"]=ue["[object Int16Array]"]=ue["[object Int32Array]"]=ue["[object Uint8Array]"]=ue["[object Uint8ClampedArray]"]=ue["[object Uint16Array]"]=ue["[object Uint32Array]"]=!0,ue["[object Arguments]"]=ue["[object Array]"]=ue["[object ArrayBuffer]"]=ue["[object Boolean]"]=ue["[object DataView]"]=ue["[object Date]"]=ue["[object Error]"]=ue["[object Function]"]=ue["[object Map]"]=ue["[object Number]"]=ue["[object Object]"]=ue["[object RegExp]"]=ue["[object Set]"]=ue["[object String]"]=ue["[object WeakMap]"]=!1;var fe=function(e){return $(e)&&ce(e.length)&&!!ue[_(e)]};var le=function(e){return function(t){return e(t)}},pe=s(function(e,t){var n=t&&!t.nodeType&&t,r=n&&e&&!e.nodeType&&e,i=r&&r.exports===n&&c.process,o=function(){try{var e=r&&r.require&&r.require("util").types;return e||i&&i.binding&&i.binding("util")}catch(e){}}();e.exports=o}),he=pe&&pe.isTypedArray,de=he?le(he):fe,me=Object.prototype.hasOwnProperty;var ve=function(e,t){var n=te(e),r=!n&&ee(e),i=!n&&!r&&re(e),o=!n&&!r&&!i&&de(e),a=n||r||i||o,s=a?q(e.length,String):[],c=s.length;for(var u in e)!t&&!me.call(e,u)||a&&("length"==u||i&&("offset"==u||"parent"==u)||o&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||ae(u,c))||s.push(u);return s},ge=Object.prototype;var be=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||ge)};var ye=function(e,t){return function(n){return e(t(n))}},xe=ye(Object.keys,Object),we=Object.prototype.hasOwnProperty;var _e=function(e){if(!be(e))return xe(e);var t=[];for(var n in Object(e))we.call(e,n)&&"constructor"!=n&&t.push(n);return t};var Ce=function(e){return null!=e&&ce(e.length)&&!O(e)};var Ae=function(e){return Ce(e)?ve(e):_e(e)};var je=function(e,t){return e&&V(e,t,Ae)};var Se=function(){this.__data__=[],this.size=0};var ke=function(e,t){return e===t||e!=e&&t!=t};var Ee=function(e,t){for(var n=e.length;n--;)if(ke(e[n][0],t))return n;return-1},Oe=Array.prototype.splice;var Me=function(e){var t=this.__data__,n=Ee(t,e);return!(n<0||(n==t.length-1?t.pop():Oe.call(t,n,1),--this.size,0))};var Pe=function(e){var t=this.__data__,n=Ee(t,e);return n<0?void 0:t[n][1]};var Te=function(e){return Ee(this.__data__,e)>-1};var De=function(e,t){var n=this.__data__,r=Ee(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this};function ze(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}ze.prototype.clear=Se,ze.prototype.delete=Me,ze.prototype.get=Pe,ze.prototype.has=Te,ze.prototype.set=De;var Fe=ze;var Ie=function(){this.__data__=new Fe,this.size=0};var Be=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n};var Re=function(e){return this.__data__.get(e)};var Le=function(e){return this.__data__.has(e)},He=U(f,"Map"),We=U(Object,"create");var Ne=function(){this.__data__=We?We(null):{},this.size=0};var Ue=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},Ge="__lodash_hash_undefined__",Ke=Object.prototype.hasOwnProperty;var Ve=function(e){var t=this.__data__;if(We){var n=t[e];return n===Ge?void 0:n}return Ke.call(t,e)?t[e]:void 0},qe=Object.prototype.hasOwnProperty;var $e=function(e){var t=this.__data__;return We?void 0!==t[e]:qe.call(t,e)},Ye="__lodash_hash_undefined__";var Ze=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=We&&void 0===t?Ye:t,this};function Xe(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}Xe.prototype.clear=Ne,Xe.prototype.delete=Ue,Xe.prototype.get=Ve,Xe.prototype.has=$e,Xe.prototype.set=Ze;var Qe=Xe;var Je=function(){this.size=0,this.__data__={hash:new Qe,map:new(He||Fe),string:new Qe}};var et=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e};var tt=function(e,t){var n=e.__data__;return et(t)?n["string"==typeof t?"string":"hash"]:n.map};var nt=function(e){var t=tt(this,e).delete(e);return this.size-=t?1:0,t};var rt=function(e){return tt(this,e).get(e)};var it=function(e){return tt(this,e).has(e)};var ot=function(e,t){var n=tt(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this};function at(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}at.prototype.clear=Je,at.prototype.delete=nt,at.prototype.get=rt,at.prototype.has=it,at.prototype.set=ot;var st=at,ct=200;var ut=function(e,t){var n=this.__data__;if(n instanceof Fe){var r=n.__data__;if(!He||r.length<ct-1)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new st(r)}return n.set(e,t),this.size=n.size,this};function ft(e){var t=this.__data__=new Fe(e);this.size=t.size}ft.prototype.clear=Ie,ft.prototype.delete=Be,ft.prototype.get=Re,ft.prototype.has=Le,ft.prototype.set=ut;var lt=ft,pt="__lodash_hash_undefined__";var ht=function(e){return this.__data__.set(e,pt),this};var dt=function(e){return this.__data__.has(e)};function mt(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new st;++t<n;)this.add(e[t])}mt.prototype.add=mt.prototype.push=ht,mt.prototype.has=dt;var vt=mt;var gt=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1};var bt=function(e,t){return e.has(t)},yt=1,xt=2;var wt=function(e,t,n,r,i,o){var a=n&yt,s=e.length,c=t.length;if(s!=c&&!(a&&c>s))return!1;var u=o.get(e);if(u&&o.get(t))return u==t;var f=-1,l=!0,p=n&xt?new vt:void 0;for(o.set(e,t),o.set(t,e);++f<s;){var h=e[f],d=t[f];if(r)var m=a?r(d,h,f,t,e,o):r(h,d,f,e,t,o);if(void 0!==m){if(m)continue;l=!1;break}if(p){if(!gt(t,function(e,t){if(!bt(p,t)&&(h===e||i(h,e,n,r,o)))return p.push(t)})){l=!1;break}}else if(h!==d&&!i(h,d,n,r,o)){l=!1;break}}return o.delete(e),o.delete(t),l},_t=f.Uint8Array;var Ct=function(e){var t=-1,n=Array(e.size);return e.forEach(function(e,r){n[++t]=[r,e]}),n};var At=function(e){var t=-1,n=Array(e.size);return e.forEach(function(e){n[++t]=e}),n},jt=1,St=2,kt="[object Boolean]",Et="[object Date]",Ot="[object Error]",Mt="[object Map]",Pt="[object Number]",Tt="[object RegExp]",Dt="[object Set]",zt="[object String]",Ft="[object Symbol]",It="[object ArrayBuffer]",Bt="[object DataView]",Rt=l?l.prototype:void 0,Lt=Rt?Rt.valueOf:void 0;var Ht=function(e,t,n,r,i,o,a){switch(n){case Bt:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case It:return!(e.byteLength!=t.byteLength||!o(new _t(e),new _t(t)));case kt:case Et:case Pt:return ke(+e,+t);case Ot:return e.name==t.name&&e.message==t.message;case Tt:case zt:return e==t+"";case Mt:var s=Ct;case Dt:var c=r&jt;if(s||(s=At),e.size!=t.size&&!c)return!1;var u=a.get(e);if(u)return u==t;r|=St,a.set(e,t);var f=wt(s(e),s(t),r,i,o,a);return a.delete(e),f;case Ft:if(Lt)return Lt.call(e)==Lt.call(t)}return!1};var Wt=function(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e};var Nt=function(e,t,n){var r=t(e);return te(e)?r:Wt(r,n(e))};var Ut=function(e,t){for(var n=-1,r=null==e?0:e.length,i=0,o=[];++n<r;){var a=e[n];t(a,n,e)&&(o[i++]=a)}return o};var Gt=function(){return[]},Kt=Object.prototype.propertyIsEnumerable,Vt=Object.getOwnPropertySymbols,qt=Vt?function(e){return null==e?[]:(e=Object(e),Ut(Vt(e),function(t){return Kt.call(e,t)}))}:Gt;var $t=function(e){return Nt(e,Ae,qt)},Yt=1,Zt=Object.prototype.hasOwnProperty;var Xt=function(e,t,n,r,i,o){var a=n&Yt,s=$t(e),c=s.length;if(c!=$t(t).length&&!a)return!1;for(var u=c;u--;){var f=s[u];if(!(a?f in t:Zt.call(t,f)))return!1}var l=o.get(e);if(l&&o.get(t))return l==t;var p=!0;o.set(e,t),o.set(t,e);for(var h=a;++u<c;){var d=e[f=s[u]],m=t[f];if(r)var v=a?r(m,d,f,t,e,o):r(d,m,f,e,t,o);if(!(void 0===v?d===m||i(d,m,n,r,o):v)){p=!1;break}h||(h="constructor"==f)}if(p&&!h){var g=e.constructor,b=t.constructor;g!=b&&"constructor"in e&&"constructor"in t&&!("function"==typeof g&&g instanceof g&&"function"==typeof b&&b instanceof b)&&(p=!1)}return o.delete(e),o.delete(t),p},Qt=U(f,"DataView"),Jt=U(f,"Promise"),en=U(f,"Set"),tn=U(f,"WeakMap"),nn=z(Qt),rn=z(He),on=z(Jt),an=z(en),sn=z(tn),cn=_;(Qt&&"[object DataView]"!=cn(new Qt(new ArrayBuffer(1)))||He&&"[object Map]"!=cn(new He)||Jt&&"[object Promise]"!=cn(Jt.resolve())||en&&"[object Set]"!=cn(new en)||tn&&"[object WeakMap]"!=cn(new tn))&&(cn=function(e){var t=_(e),n="[object Object]"==t?e.constructor:void 0,r=n?z(n):"";if(r)switch(r){case nn:return"[object DataView]";case rn:return"[object Map]";case on:return"[object Promise]";case an:return"[object Set]";case sn:return"[object WeakMap]"}return t});var un=cn,fn=1,ln="[object Arguments]",pn="[object Array]",hn="[object Object]",dn=Object.prototype.hasOwnProperty;var mn=function(e,t,n,r,i,o){var a=te(e),s=te(t),c=a?pn:un(e),u=s?pn:un(t),f=(c=c==ln?hn:c)==hn,l=(u=u==ln?hn:u)==hn,p=c==u;if(p&&re(e)){if(!re(t))return!1;a=!0,f=!1}if(p&&!f)return o||(o=new lt),a||de(e)?wt(e,t,n,r,i,o):Ht(e,t,c,n,r,i,o);if(!(n&fn)){var h=f&&dn.call(e,"__wrapped__"),d=l&&dn.call(t,"__wrapped__");if(h||d){var m=h?e.value():e,v=d?t.value():t;return o||(o=new lt),i(m,v,n,r,o)}}return!!p&&(o||(o=new lt),Xt(e,t,n,r,i,o))};var vn=function e(t,n,r,i,o){return t===n||(null==t||null==n||!$(t)&&!$(n)?t!=t&&n!=n:mn(t,n,r,i,e,o))},gn=1,bn=2;var yn=function(e,t,n,r){var i=n.length,o=i,a=!r;if(null==e)return!o;for(e=Object(e);i--;){var s=n[i];if(a&&s[2]?s[1]!==e[s[0]]:!(s[0]in e))return!1}for(;++i<o;){var c=(s=n[i])[0],u=e[c],f=s[1];if(a&&s[2]){if(void 0===u&&!(c in e))return!1}else{var l=new lt;if(r)var p=r(u,f,c,e,t,l);if(!(void 0===p?vn(f,u,gn|bn,r,l):p))return!1}}return!0};var xn=function(e){return e==e&&!C(e)};var wn=function(e){for(var t=Ae(e),n=t.length;n--;){var r=t[n],i=e[r];t[n]=[r,i,xn(i)]}return t};var _n=function(e,t){return function(n){return null!=n&&n[e]===t&&(void 0!==t||e in Object(n))}};var Cn=function(e){var t=wn(e);return 1==t.length&&t[0][2]?_n(t[0][0],t[0][1]):function(n){return n===e||yn(n,e,t)}},An="[object Symbol]";var jn=function(e){return"symbol"==typeof e||$(e)&&_(e)==An},Sn=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,kn=/^\w*$/;var En=function(e,t){if(te(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!jn(e))||kn.test(e)||!Sn.test(e)||null!=t&&e in Object(t)},On="Expected a function";function Mn(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError(On);var n=function(){var r=arguments,i=t?t.apply(this,r):r[0],o=n.cache;if(o.has(i))return o.get(i);var a=e.apply(this,r);return n.cache=o.set(i,a)||o,a};return n.cache=new(Mn.Cache||st),n}Mn.Cache=st;var Pn=Mn,Tn=500;var Dn=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,zn=/\\(\\)?/g,Fn=function(e){var t=Pn(e,function(e){return n.size===Tn&&n.clear(),e}),n=t.cache;return t}(function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(Dn,function(e,n,r,i){t.push(r?i.replace(zn,"$1"):n||e)}),t});var In=function(e,t){for(var n=-1,r=null==e?0:e.length,i=Array(r);++n<r;)i[n]=t(e[n],n,e);return i},Bn=1/0,Rn=l?l.prototype:void 0,Ln=Rn?Rn.toString:void 0;var Hn=function e(t){if("string"==typeof t)return t;if(te(t))return In(t,e)+"";if(jn(t))return Ln?Ln.call(t):"";var n=t+"";return"0"==n&&1/t==-Bn?"-0":n};var Wn=function(e){return null==e?"":Hn(e)};var Nn=function(e,t){return te(e)?e:En(e,t)?[e]:Fn(Wn(e))},Un=1/0;var Gn=function(e){if("string"==typeof e||jn(e))return e;var t=e+"";return"0"==t&&1/e==-Un?"-0":t};var Kn=function(e,t){for(var n=0,r=(t=Nn(t,e)).length;null!=e&&n<r;)e=e[Gn(t[n++])];return n&&n==r?e:void 0};var Vn=function(e,t,n){var r=null==e?void 0:Kn(e,t);return void 0===r?n:r};var qn=function(e,t){return null!=e&&t in Object(e)};var $n=function(e,t,n){for(var r=-1,i=(t=Nn(t,e)).length,o=!1;++r<i;){var a=Gn(t[r]);if(!(o=null!=e&&n(e,a)))break;e=e[a]}return o||++r!=i?o:!!(i=null==e?0:e.length)&&ce(i)&&ae(a,i)&&(te(e)||ee(e))};var Yn=function(e,t){return null!=e&&$n(e,t,qn)},Zn=1,Xn=2;var Qn=function(e,t){return En(e)&&xn(t)?_n(Gn(e),t):function(n){var r=Vn(n,e);return void 0===r&&r===t?Yn(n,e):vn(t,r,Zn|Xn)}};var Jn=function(e){return e};var er=function(e){return function(t){return null==t?void 0:t[e]}};var tr=function(e){return function(t){return Kn(t,e)}};var nr=function(e){return En(e)?er(Gn(e)):tr(e)};var rr=function(e){return"function"==typeof e?e:null==e?Jn:"object"==typeof e?te(e)?Qn(e[0],e[1]):Cn(e):nr(e)};var ir=function(e,t){var n={};return t=rr(t,3),je(e,function(e,r,i){K(n,r,t(e,r,i))}),n},or=Object.prototype.hasOwnProperty;var ar=function(e,t,n){var r=e[t];or.call(e,t)&&ke(r,n)&&(void 0!==n||t in e)||K(e,t,n)};var sr=function(e,t,n,r){if(!C(e))return e;for(var i=-1,o=(t=Nn(t,e)).length,a=o-1,s=e;null!=s&&++i<o;){var c=Gn(t[i]),u=n;if(i!=a){var f=s[c];void 0===(u=r?r(f,c,s):void 0)&&(u=C(f)?f:ae(t[i+1])?[]:{})}ar(s,c,u),s=s[c]}return e};var cr=function(e,t,n){for(var r=-1,i=t.length,o={};++r<i;){var a=t[r],s=Kn(e,a);n(s,a)&&sr(o,Nn(a,e),s)}return o},ur=ye(Object.getPrototypeOf,Object),fr=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)Wt(t,qt(e)),e=ur(e);return t}:Gt;var lr=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t},pr=Object.prototype.hasOwnProperty;var hr=function(e){if(!C(e))return lr(e);var t=be(e),n=[];for(var r in e)("constructor"!=r||!t&&pr.call(e,r))&&n.push(r);return n};var dr=function(e){return Ce(e)?ve(e,!0):hr(e)};var mr=function(e){return Nt(e,dr,fr)};var vr=function(e,t){if(null==e)return{};var n=In(mr(e),function(e){return[e]});return t=rr(t),cr(e,n,function(e,n){return t(e,n[0])})},gr=1e-6,br="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function yr(){var e=new br(16);return br!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function xr(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function wr(e,t){var n=t[0],r=t[1],i=t[2],o=t[3],a=t[4],s=t[5],c=t[6],u=t[7],f=t[8],l=t[9],p=t[10],h=t[11],d=t[12],m=t[13],v=t[14],g=t[15],b=n*s-r*a,y=n*c-i*a,x=n*u-o*a,w=r*c-i*s,_=r*u-o*s,C=i*u-o*c,A=f*m-l*d,j=f*v-p*d,S=f*g-h*d,k=l*v-p*m,E=l*g-h*m,O=p*g-h*v,M=b*O-y*E+x*k+w*S-_*j+C*A;return M?(M=1/M,e[0]=(s*O-c*E+u*k)*M,e[1]=(i*E-r*O-o*k)*M,e[2]=(m*C-v*_+g*w)*M,e[3]=(p*_-l*C-h*w)*M,e[4]=(c*S-a*O-u*j)*M,e[5]=(n*O-i*S+o*j)*M,e[6]=(v*x-d*C-g*y)*M,e[7]=(f*C-p*x+h*y)*M,e[8]=(a*E-s*S+u*A)*M,e[9]=(r*S-n*E-o*A)*M,e[10]=(d*_-m*x+g*b)*M,e[11]=(l*x-f*_-h*b)*M,e[12]=(s*j-a*k-c*A)*M,e[13]=(n*k-r*j+i*A)*M,e[14]=(m*y-d*w-v*b)*M,e[15]=(f*w-l*y+p*b)*M,e):null}function _r(e,t,n){var r=t[0],i=t[1],o=t[2],a=t[3],s=t[4],c=t[5],u=t[6],f=t[7],l=t[8],p=t[9],h=t[10],d=t[11],m=t[12],v=t[13],g=t[14],b=t[15],y=n[0],x=n[1],w=n[2],_=n[3];return e[0]=y*r+x*s+w*l+_*m,e[1]=y*i+x*c+w*p+_*v,e[2]=y*o+x*u+w*h+_*g,e[3]=y*a+x*f+w*d+_*b,y=n[4],x=n[5],w=n[6],_=n[7],e[4]=y*r+x*s+w*l+_*m,e[5]=y*i+x*c+w*p+_*v,e[6]=y*o+x*u+w*h+_*g,e[7]=y*a+x*f+w*d+_*b,y=n[8],x=n[9],w=n[10],_=n[11],e[8]=y*r+x*s+w*l+_*m,e[9]=y*i+x*c+w*p+_*v,e[10]=y*o+x*u+w*h+_*g,e[11]=y*a+x*f+w*d+_*b,y=n[12],x=n[13],w=n[14],_=n[15],e[12]=y*r+x*s+w*l+_*m,e[13]=y*i+x*c+w*p+_*v,e[14]=y*o+x*u+w*h+_*g,e[15]=y*a+x*f+w*d+_*b,e}function Cr(e,t,n){var r=n[0],i=n[1],o=n[2],a=void 0,s=void 0,c=void 0,u=void 0,f=void 0,l=void 0,p=void 0,h=void 0,d=void 0,m=void 0,v=void 0,g=void 0;return t===e?(e[12]=t[0]*r+t[4]*i+t[8]*o+t[12],e[13]=t[1]*r+t[5]*i+t[9]*o+t[13],e[14]=t[2]*r+t[6]*i+t[10]*o+t[14],e[15]=t[3]*r+t[7]*i+t[11]*o+t[15]):(a=t[0],s=t[1],c=t[2],u=t[3],f=t[4],l=t[5],p=t[6],h=t[7],d=t[8],m=t[9],v=t[10],g=t[11],e[0]=a,e[1]=s,e[2]=c,e[3]=u,e[4]=f,e[5]=l,e[6]=p,e[7]=h,e[8]=d,e[9]=m,e[10]=v,e[11]=g,e[12]=a*r+f*i+d*o+t[12],e[13]=s*r+l*i+m*o+t[13],e[14]=c*r+p*i+v*o+t[14],e[15]=u*r+h*i+g*o+t[15]),e}function Ar(e,t,n){var r=Math.sin(n),i=Math.cos(n),o=t[4],a=t[5],s=t[6],c=t[7],u=t[8],f=t[9],l=t[10],p=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*i+u*r,e[5]=a*i+f*r,e[6]=s*i+l*r,e[7]=c*i+p*r,e[8]=u*i-o*r,e[9]=f*i-a*r,e[10]=l*i-s*r,e[11]=p*i-c*r,e}function jr(e,t,n){var r=Math.sin(n),i=Math.cos(n),o=t[0],a=t[1],s=t[2],c=t[3],u=t[8],f=t[9],l=t[10],p=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*i-u*r,e[1]=a*i-f*r,e[2]=s*i-l*r,e[3]=c*i-p*r,e[8]=o*r+u*i,e[9]=a*r+f*i,e[10]=s*r+l*i,e[11]=c*r+p*i,e}function Sr(e,t,n){var r=Math.sin(n),i=Math.cos(n),o=t[0],a=t[1],s=t[2],c=t[3],u=t[4],f=t[5],l=t[6],p=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*i+u*r,e[1]=a*i+f*r,e[2]=s*i+l*r,e[3]=c*i+p*r,e[4]=u*i-o*r,e[5]=f*i-a*r,e[6]=l*i-s*r,e[7]=p*i-c*r,e}function kr(e,t,n,r){var i=t[0],o=t[1],a=t[2],s=t[3],c=i+i,u=o+o,f=a+a,l=i*c,p=i*u,h=i*f,d=o*u,m=o*f,v=a*f,g=s*c,b=s*u,y=s*f,x=r[0],w=r[1],_=r[2];return e[0]=(1-(d+v))*x,e[1]=(p+y)*x,e[2]=(h-b)*x,e[3]=0,e[4]=(p-y)*w,e[5]=(1-(l+v))*w,e[6]=(m+g)*w,e[7]=0,e[8]=(h+b)*_,e[9]=(m-g)*_,e[10]=(1-(l+d))*_,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function Er(e,t){var n=t[0],r=t[1],i=t[2],o=t[3],a=n+n,s=r+r,c=i+i,u=n*a,f=r*a,l=r*s,p=i*a,h=i*s,d=i*c,m=o*a,v=o*s,g=o*c;return e[0]=1-l-d,e[1]=f+g,e[2]=p-v,e[3]=0,e[4]=f-g,e[5]=1-u-d,e[6]=h+m,e[7]=0,e[8]=p+v,e[9]=h-m,e[10]=1-u-l,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var Or=_r;function Mr(){var e=new br(3);return br!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Pr(e,t,n){var r=new br(3);return r[0]=e,r[1]=t,r[2]=n,r}function Tr(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function Dr(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function zr(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}function Fr(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+r*r+i*i)}function Ir(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function Br(e,t){var n=t[0],r=t[1],i=t[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e}function Rr(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Lr(e,t,n){var r=t[0],i=t[1],o=t[2],a=n[0],s=n[1],c=n[2];return e[0]=i*c-o*s,e[1]=o*a-r*c,e[2]=r*s-i*a,e}function Hr(e,t,n){var r=t[0],i=t[1],o=t[2],a=n[3]*r+n[7]*i+n[11]*o+n[15];return a=a||1,e[0]=(n[0]*r+n[4]*i+n[8]*o+n[12])/a,e[1]=(n[1]*r+n[5]*i+n[9]*o+n[13])/a,e[2]=(n[2]*r+n[6]*i+n[10]*o+n[14])/a,e}function Wr(e,t,n){var r=n[0],i=n[1],o=n[2],a=n[3],s=t[0],c=t[1],u=t[2],f=i*u-o*c,l=o*s-r*u,p=r*c-i*s,h=i*p-o*l,d=o*f-r*p,m=r*l-i*f,v=2*a;return f*=v,l*=v,p*=v,h*=2,d*=2,m*=2,e[0]=s+f+h,e[1]=c+l+d,e[2]=u+p+m,e}var Nr,Ur=function(e){var t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)};Nr=Mr();!function(){var e,t=(e=new br(4),br!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();function Gr(){var e=new br(4);return br!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function Kr(e,t,n){n*=.5;var r=Math.sin(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(n),e}function Vr(e,t,n){n*=.5;var r=t[0],i=t[1],o=t[2],a=t[3],s=Math.sin(n),c=Math.cos(n);return e[0]=r*c-o*s,e[1]=i*c+a*s,e[2]=o*c+r*s,e[3]=a*c-i*s,e}function qr(e,t,n,r){var i=t[0],o=t[1],a=t[2],s=t[3],c=n[0],u=n[1],f=n[2],l=n[3],p=void 0,h=void 0,d=void 0,m=void 0,v=void 0;return(h=i*c+o*u+a*f+s*l)<0&&(h=-h,c=-c,u=-u,f=-f,l=-l),1-h>gr?(p=Math.acos(h),d=Math.sin(p),m=Math.sin((1-r)*p)/d,v=Math.sin(r*p)/d):(m=1-r,v=r),e[0]=m*i+v*c,e[1]=m*o+v*u,e[2]=m*a+v*f,e[3]=m*s+v*l,e}var $r,Yr,Zr,Xr,Qr,Jr,ei,ti=function(e,t){var n=t[0],r=t[1],i=t[2],o=t[3],a=n*n+r*r+i*i+o*o;return a>0&&(a=1/Math.sqrt(a),e[0]=n*a,e[1]=r*a,e[2]=i*a,e[3]=o*a),e},ni=($r=Mr(),Yr=Pr(1,0,0),Zr=Pr(0,1,0),function(e,t,n){var r=Rr(t,n);return r<-.999999?(Lr($r,Yr,t),Ur($r)<1e-6&&Lr($r,Zr,t),Br($r,$r),Kr(e,$r,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(Lr($r,t,n),e[0]=$r[0],e[1]=$r[1],e[2]=$r[2],e[3]=1+r,ti(e,e))});Xr=Gr(),Qr=Gr(),Jr=new br(9),br!=Float32Array&&(Jr[1]=0,Jr[2]=0,Jr[3]=0,Jr[5]=0,Jr[6]=0,Jr[7]=0),Jr[0]=1,Jr[4]=1,Jr[8]=1,ei=Jr;!function(){var e,t=(e=new br(2),br!=Float32Array&&(e[0]=0,e[1]=0),e)}();class ri{constructor(e,t){i(this,"left",void 0),i(this,"right",void 0),i(this,"top",void 0),i(this,"bottom",void 0),i(this,"width",void 0),i(this,"height",void 0),this.left=e,this.top=t,this.right=-e,this.bottom=-t,this.width=2*Math.abs(e),this.height=2*Math.abs(t)}}function ii(e,t,n){const r=t/n,i=Math.abs(e);return new ri(-i/2*r,i/2)}const oi=0,ai=1,si=[0,0,0,0];var ci=s(function(e,t){function n(e,t){return e===t}function r(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n,r=null,i=null;return function(){return function(e,t,n){if(null===t||null===n||t.length!==n.length)return!1;for(var r=t.length,i=0;i<r;i++)if(!e(t[i],n[i]))return!1;return!0}(t,r,arguments)||(i=e.apply(null,arguments)),r=arguments,i}}function i(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return function(){for(var t=arguments.length,i=Array(t),o=0;o<t;o++)i[o]=arguments[o];var a=0,s=i.pop(),c=function(e){var t=Array.isArray(e[0])?e[0]:e;if(!t.every(function(e){return"function"==typeof e})){var n=t.map(function(e){return typeof e}).join(", ");throw new Error("Selector creators expect all input-selectors to be functions, instead received the following types: ["+n+"]")}return t}(i),u=e.apply(void 0,[function(){return a++,s.apply(null,arguments)}].concat(n)),f=r(function(){for(var e=[],t=c.length,n=0;n<t;n++)e.push(c[n].apply(null,arguments));return u.apply(null,e)});return f.resultFunc=s,f.recomputations=function(){return a},f.resetRecomputations=function(){return a=0},f}}t.__esModule=!0,t.defaultMemoize=r,t.createSelectorCreator=i,t.createStructuredSelector=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o;if("object"!=typeof e)throw new Error("createStructuredSelector expects first argument to be an object where each property is a selector, instead received a "+typeof e);var n=Object.keys(e);return t(n.map(function(t){return e[t]}),function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.reduce(function(e,t,r){return e[n[r]]=t,e},{})})};var o=t.createSelector=i(r)});!function(e){e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")&&e.default}(ci);ci.defaultMemoize,ci.createSelectorCreator,ci.createStructuredSelector;var ui=ci.createSelector;const fi="\n  uniform vec3 _position;\n  uniform vec4 _rotation;\n\n  // rotate a 3d point v by a rotation quaternion q\n  vec3 rotate(vec3 v, vec4 q) {\n    vec3 temp = cross(q.xyz, v) + q.w * v;\n    return v + (2.0 * cross(q.xyz, temp));\n  }\n\n  vec3 applyPose(vec3 point) {\n    // rotate the point and then add the position of the pose\n    return rotate(point, _rotation) + _position;\n  }\n",li={r:1,g:1,b:1,a:1},pi=({x:e,y:t,z:n})=>[e,t,n],hi=({x:e,y:t,z:n,w:r})=>[e,t,n,r],di=([e,t,n])=>({x:e,y:t,z:n}),mi=([e,t,n,r])=>({x:e,y:t,z:n,w:r}),vi=e=>{const t=new Float32Array(3*e.length);let n=0;for(const r of e){const{x:e,y:i,z:o}=r;t[n++]=e,t[n++]=i,t[n++]=o}return t},gi=e=>[e.r,e.g,e.b,e.a],bi=e=>({r:e[0],g:e[1],b:e[2],a:e[3]}),yi=e=>Array.isArray(e)?bi(e):e;function xi(e=li){const{r:t,g:n,b:r,a:i}=e;return`rgba(${(255*t).toFixed()}, ${(255*n).toFixed()}, ${(255*r).toFixed()}, ${i.toFixed(3)})`}const wi=e=>{const t=new Float32Array(4*e.length);let n=0;for(const r of e){const{r:e,g:i,b:o,a:a}=r;t[n++]=e,t[n++]=i,t[n++]=o,t[n++]=a}return t},_i=(e,{r:t,g:n,b:r,a:i})=>{const o=new Float32Array(4*e);for(let a=0;a<e;a++)o[4*a+0]=t,o[4*a+1]=n,o[4*a+2]=r,o[4*a+3]=i;return o},Ci={enable:!0,func:{src:"src alpha",dst:"one minus src alpha",srcAlpha:1,dstAlpha:"one minus src alpha"},equation:{rgb:"add",alpha:"add"}},Ai={enable:!0,mask:!0},ji={enable:(e,t)=>t.depth&&t.depth.enable||Ai.enable,mask:(e,t)=>t.depth&&t.depth.mask||Ai.mask},Si=o({},Ci,{enable:(e,t)=>t.blend&&t.blend.enable||Ci.enable,func:(e,t)=>t.blend&&t.blend.func||Ci.func}),ki=Si;function Ei(e){const{vert:t,uniforms:n}=e,r=t.replace("#WITH_POSE",fi),i=o({},n,{_position:(e,t)=>{const{position:n}=t.pose;return Array.isArray(n)?n:pi(n)},_rotation:(e,t)=>{const{orientation:n}=t.pose;return Array.isArray(n)?n:[n.x,n.y,n.z,n.w]}});return o({},e,{vert:r,uniforms:i})}function Oi({colors:e,color:t,points:n}){return e&&e.length||!t?e?Pi(e)?wi(e):e:[]:_i(n.length,t)}function Mi(e){const t=e.buffer({usage:"dynamic",data:[]});return function(e,n,r){let i,o;return n&&n.length?(i=Pi(n)?wi(n):n,o=1):(i=Pi(e)?gi(e):e,o=r),{buffer:t({usage:"dynamic",data:i}),divisor:o}}}function Pi(e){return!(!e||(t=e,t.length&&Array.isArray(t[0]))||!isNaN(e[0]));var t}function Ti(e=0){return[(e>>16&255)/255,(e>>8&255)/255,(255&e)/255,1]}function Di(e){const t=e[0],n=e[1];return e[2]|n<<8|t<<16}function zi(e,t,n,r){const i=t*Math.sin(r);return e[0]=i*Math.sin(n),e[1]=t*Math.cos(r),e[2]=i*Math.cos(n),e}const Fi=Object.freeze([1,0,0]),Ii=[0,0,0],Bi=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Ri=[0,0,0,0],Li=e=>e,Hi=ui(Li,({perspective:e})=>e),Wi=ui(Li,({distance:e})=>e),Ni=ui(Li,({phi:e})=>e),Ui=ui(Li,({thetaOffset:e})=>e),Gi=ui(Li,({targetOrientation:e})=>e),Ki=ui(Gi,e=>{const t=Wr(Ii,Fi,e);return-Math.atan2(t[1],t[0])}),Vi=ui(Hi,Ni,Ui,(e,t,n)=>{const r=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}([0,0,0,0]);return function(e,t,n){n*=.5;var r=t[0],i=t[1],o=t[2],a=t[3],s=Math.sin(n),c=Math.cos(n);e[0]=r*c+i*s,e[1]=i*c-r*s,e[2]=o*c+a*s,e[3]=a*c-o*s}(r,r,-n),e&&function(e,t,n){n*=.5;var r=t[0],i=t[1],o=t[2],a=t[3],s=Math.sin(n),c=Math.cos(n);e[0]=r*c+a*s,e[1]=i*c+o*s,e[2]=o*c-i*s,e[3]=a*c-r*s}(r,r,t),r}),qi=ui(Ui,Ni,Wi,(e,t,n)=>{const r=zi([],n,e,t),[i,o,a]=r;return r[0]=-i,r[1]=-a,r[2]=o,r});var $i={orientation:Vi,position:qi,targetHeading:Ki,view:ui(Li,Vi,qi,Ki,({target:e,targetOffset:t,perspective:n},r,i,o)=>{const a=xr([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);return _r(a,a,Er(Bi,function(e,t){var n=t[0],r=t[1],i=t[2],o=t[3],a=n*n+r*r+i*i+o*o,s=a?1/a:0;return e[0]=-n*s,e[1]=-r*s,e[2]=-i*s,e[3]=o*s,e}(Ri,r))),n&&Cr(a,a,Ir(Ii,i)),Cr(a,a,Ir(Ii,t)),Sr(a,a,o),Ir(Ii,e),n||(Ii[2]=-2500),Cr(a,a,Ii),a}),billboardRotation:ui(Vi,Ki,(e,t)=>{const n=xr(yr());return Sr(n,n,-t),_r(n,n,Er(Bi,e)),n})};const Yi=Object.freeze([0,0,1]),Zi=[0,0,0,0],Xi={distance:75,perspective:!0,phi:Math.PI/4,target:[0,0,0],targetOffset:[0,0,0],targetOrientation:[0,0,0,1],thetaOffset:0,fovy:Math.PI/4,near:.01,far:5e3};class Qi{constructor(e=(()=>{}),t=Xi){i(this,"state",void 0),i(this,"_onChange",void 0),i(this,"setCameraState",e=>{for(const[t,n]of Object.entries(Xi))null==e[t]&&(e[t]=n);this.state=e}),i(this,"cameraRotate",([e,t])=>{if(0===e&&0===t)return;const{thetaOffset:n,phi:r}=this.state;this.setCameraState(o({},this.state,{thetaOffset:n-e,phi:Math.max(0,Math.min(r+t,Math.PI))})),this._onChange(this.state)}),i(this,"cameraMove",([e,t])=>{if(0===e&&0===t)return;const{targetOffset:n,thetaOffset:r}=this.state,i=[e,t,0],a=Wr(i,i,Kr(Zi,Yi,-r));this.setCameraState(o({},this.state,{targetOffset:Tr(a,n,a)})),this._onChange(this.state)}),i(this,"cameraZoom",e=>{const{distance:t}=this.state,n=function(e,t){return Math.max(.001,e*(1-t/100))}(t,e);t!==n&&(this.setCameraState(o({},this.state,{distance:n})),this._onChange(this.state))}),this._onChange=e,this.setCameraState(t)}}const Ji=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];var eo,to,no,ro,io,oo,ao,so,co,uo,fo,lo,po,ho,mo,vo=e=>(class{constructor(){i(this,"viewportWidth",0),i(this,"viewportHeight",0),i(this,"cameraState",Xi),i(this,"draw",e({context:{projection(e,t){const{viewportWidth:n,viewportHeight:r}=e;return this.viewportWidth=n,this.viewportHeight=r,this.cameraState=t,this.getProjection()},view(e,t){return this.getView()},billboardRotation(e,t){return $i.billboardRotation(this.cameraState)},isPerspective(e,t){return this.cameraState.perspective},fovy(e,t){return this.cameraState.fovy}},uniforms:{view:e.context("view"),billboardRotation:e.context("billboardRotation"),projection:e.context("projection")}}))}getProjection(){const{near:e,far:t,distance:n,fovy:r}=this.cameraState;if(!this.cameraState.perspective){const r=ii(n,this.viewportWidth,this.viewportHeight),{left:i,right:o,bottom:a,top:s}=r;return function(e,t,n,r,i,o,a){var s=1/(t-n),c=1/(r-i),u=1/(o-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+n)*s,e[13]=(i+r)*c,e[14]=(a+o)*u,e[15]=1,e}([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i,o,a,s,e,t)}return function(e,t,n,r,i){var o=1/Math.tan(t/2),a=void 0;return e[0]=o/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(a=1/(r-i),e[10]=(i+r)*a,e[14]=2*i*r*a):(e[10]=-1,e[14]=-2*r),e}([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r,this.viewportWidth/this.viewportHeight,e,t)}getView(){return $i.view(this.cameraState)}toScreenCoord(e,t){const n=this.getProjection(),r=$i.view(this.cameraState),i=_r(Ji,n,r),[o,a,s,c]=function(e,t,n,r){const i=n[0],o=n[1],a=n[2],s=n[3],c=oi,u=ai;!function(e,t,n,r,i){e[0]=t,e[1]=n,e[2]=r,e[3]=i}(si,t[0],t[1],t[2],1),function(e,t,n){var r=t[0],i=t[1],o=t[2],a=t[3];e[0]=n[0]*r+n[4]*i+n[8]*o+n[12]*a,e[1]=n[1]*r+n[5]*i+n[9]*o+n[13]*a,e[2]=n[2]*r+n[6]*i+n[10]*o+n[14]*a,e[3]=n[3]*r+n[7]*i+n[11]*o+n[15]*a}(si,si,r);const f=si[3];return 0!==f&&(si[0]=si[0]/f,si[1]=si[1]/f,si[2]=si[2]/f),e[0]=i+a/2*si[0]+(0+a/2),e[1]=o+s/2*si[1]+(0+s/2),e[2]=(u-c)/2*si[2]+(u+c)/2,e[3]=0===f?0:1/f,e}([],t,e,i);if(s<0||s>1||c<0)return;const u=e[3]+e[1];return[o-e[0],u-a,s]}}),go=!1;function bo(){if(!go){go=!0;var e=navigator.userAgent,t=/(?:MSIE.(\d+\.\d+))|(?:(?:Firefox|GranParadiso|Iceweasel).(\d+\.\d+))|(?:Opera(?:.+Version.|.)(\d+\.\d+))|(?:AppleWebKit.(\d+(?:\.\d+)?))|(?:Trident\/\d+\.\d+.*rv:(\d+\.\d+))/.exec(e),n=/(Mac OS X)|(Windows)|(Linux)/.exec(e);if(lo=/\b(iPhone|iP[ao]d)/.exec(e),po=/\b(iP[ao]d)/.exec(e),uo=/Android/i.exec(e),ho=/FBAN\/\w+;/i.exec(e),mo=/Mobile/i.exec(e),fo=!!/Win64/.exec(e),t){(eo=t[1]?parseFloat(t[1]):t[5]?parseFloat(t[5]):NaN)&&document&&document.documentMode&&(eo=document.documentMode);var r=/(?:Trident\/(\d+.\d+))/.exec(e);oo=r?parseFloat(r[1])+4:eo,to=t[2]?parseFloat(t[2]):NaN,no=t[3]?parseFloat(t[3]):NaN,(ro=t[4]?parseFloat(t[4]):NaN)?(t=/(?:Chrome\/(\d+\.\d+))/.exec(e),io=t&&t[1]?parseFloat(t[1]):NaN):io=NaN}else eo=to=no=io=ro=NaN;if(n){if(n[1]){var i=/(?:Mac OS X (\d+(?:[._]\d+)?))/.exec(e);ao=!i||parseFloat(i[1].replace("_","."))}else ao=!1;so=!!n[2],co=!!n[3]}else ao=so=co=!1}}var yo,xo={ie:function(){return bo()||eo},ieCompatibilityMode:function(){return bo()||oo>eo},ie64:function(){return xo.ie()&&fo},firefox:function(){return bo()||to},opera:function(){return bo()||no},webkit:function(){return bo()||ro},safari:function(){return xo.webkit()},chrome:function(){return bo()||io},windows:function(){return bo()||so},osx:function(){return bo()||ao},linux:function(){return bo()||co},iphone:function(){return bo()||lo},mobile:function(){return bo()||lo||po||uo||mo},nativeApp:function(){return bo()||ho},android:function(){return bo()||uo},ipad:function(){return bo()||po}},wo=xo,_o=!("undefined"==typeof window||!window.document||!window.document.createElement),Co={canUseDOM:_o,canUseWorkers:"undefined"!=typeof Worker,canUseEventListeners:_o&&!(!window.addEventListener&&!window.attachEvent),canUseViewport:_o&&!!window.screen,isInWorker:!_o};Co.canUseDOM&&(yo=document.implementation&&document.implementation.hasFeature&&!0!==document.implementation.hasFeature("",""));var Ao=function(e,t){if(!Co.canUseDOM||t&&!("addEventListener"in document))return!1;var n="on"+e,r=n in document;if(!r){var i=document.createElement("div");i.setAttribute(n,"return;"),r="function"==typeof i[n]}return!r&&yo&&"wheel"===e&&(r=document.implementation.hasFeature("Events.wheel","3.0")),r},jo=10,So=40,ko=800;function Eo(e){var t=0,n=0,r=0,i=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),"axis"in e&&e.axis===e.HORIZONTAL_AXIS&&(t=n,n=0),r=t*jo,i=n*jo,"deltaY"in e&&(i=e.deltaY),"deltaX"in e&&(r=e.deltaX),(r||i)&&e.deltaMode&&(1==e.deltaMode?(r*=So,i*=So):(r*=ko,i*=ko)),r&&!t&&(t=r<1?-1:1),i&&!n&&(n=i<1?-1:1),{spinX:t,spinY:n,pixelX:r,pixelY:i}}Eo.getEventType=function(){return wo.firefox()?"DOMMouseScroll":Ao("wheel")?"wheel":"mousewheel"};var Oo=Eo;const Mo=4,Po=.3,To=.3,Do=150,zo=1.5,Fo={KeyA:"moveLeft",KeyD:"moveRight",KeyE:"rotateRight",KeyF:"tiltUp",KeyQ:"rotateLeft",KeyR:"tiltDown",KeyS:"moveDown",KeyW:"moveUp",KeyX:"zoomOut",KeyZ:"zoomIn"};class Io extends t.Component{constructor(...e){super(...e),i(this,"_keyTimer",void 0),i(this,"_keys",new Set),i(this,"_buttons",new Set),i(this,"_listeners",[]),i(this,"_shiftKey",!1),i(this,"_metaKey",!1),i(this,"_ctrlKey",!1),i(this,"_el",void 0),i(this,"_rect",void 0),i(this,"_initialMouse",void 0),i(this,"_getMouseOnScreen",e=>{const{clientX:t,clientY:n}=e,{top:r,left:i,width:o,height:a}=this._rect;return[(t-i)/o,(n-r)/a]}),i(this,"_onMouseDown",e=>{const{_el:t}=this;t&&(e.preventDefault(),this._buttons.add(e.button),t.focus(),this._rect=t.getBoundingClientRect(),this._initialMouse=this._getMouseOnScreen(e),this.startDragging(e))}),i(this,"_onWindowMouseMove",e=>{if(!this._buttons.size)return;this._shiftKey=e.shiftKey;const{cameraStore:{cameraMove:t,cameraRotate:n,state:{perspective:r}}}=this.props;let i,o;const a=this._getMouseOnScreen(e);if(document.pointerLockElement&&(e.movementX||e.movementY)?(i=-e.movementX/this._rect.width,o=-e.movementY/this._rect.height):(i=this._initialMouse[0]-a[0],o=this._initialMouse[1]-a[1]),this._initialMouse=a,this._isRightMouseDown()){const e=this._getMagnitude(Mo);n([(r?i:-i)*e,r?o*e:0])}if(this._isLeftMouseDown()){const{x:e,y:n}=this._getMoveMagnitude();t([this._getMagnitude(i*e),this._getMagnitude(-o*n)])}}),i(this,"_onMouseUp",e=>{this._buttons.delete(e.button),this._endDragging()}),i(this,"_onWindowMouseUp",e=>{const{_el:t}=this;t&&(t.contains(e.target)||e.target===t||(this._buttons.clear(),this._endDragging()))}),i(this,"_getKeyMotion",e=>{const t=this._getMagnitude(To),n=this._getMagnitude(Do),r=this._getMagnitude(zo),{keyMap:i,shiftKeys:o}=this.props,a=i&&i[e]||Fo[e]||!1;if(this._shiftKey&&!o)return null;switch(a){case"moveRight":return{x:t};case"moveLeft":return{x:-t};case"moveUp":return{y:t};case"moveDown":return{y:-t};case"zoomIn":return{zoom:n};case"zoomOut":return{zoom:-n};case"rotateLeft":return{yaw:-r};case"rotateRight":return{yaw:r};case"tiltUp":return{tilt:-r};case"tiltDown":return{tilt:r};case!1:return null;default:return console.warn("Unrecognized key action:",a),null}}),i(this,"_onKeyDown",e=>{const{keyMap:t}=this.props;this._shiftKey=e.shiftKey,this._metaKey=e.metaKey,this._ctrlKey=e.ctrlKey;const n=e.nativeEvent.code;return e.repeat||this._keys.has(n)?(e.stopPropagation(),void e.preventDefault()):e.altKey||e.ctrlKey||e.metaKey?void 0:!(t&&n in t&&!t[n])&&void(this._getKeyMotion(n)&&(this._keys.add(n),this._startKeyTimer(),e.stopPropagation(),e.preventDefault()))}),i(this,"_onKeyUp",e=>{this._shiftKey=e.shiftKey,this._metaKey=e.metaKey,this._ctrlKey=e.ctrlKey,this._keys.delete(e.nativeEvent.code)}),i(this,"_onWheel",e=>{e.preventDefault(),e.stopPropagation(),this._shiftKey=e.shiftKey;const{pixelX:t,pixelY:n}=Oo(e),r=n||t,i=-1*Math.sign(r),o=Math.abs(r),a=Math.max(1,Math.min(o,50)),s=this._getMagnitude(a*i*Po);this.props.cameraStore.cameraZoom(s)}),i(this,"_onBlur",e=>{this._keys=new Set,this._ctrlKey=!1,this._shiftKey=!1,this._metaKey=!1,this._stopKeyTimer()}),i(this,"_onContextMenu",e=>{e.preventDefault(),e.stopPropagation()})}componentDidMount(){const{_el:e}=this;if(!e)return;this._rect=e.getBoundingClientRect();const t=(e,t,n)=>{e.addEventListener(t,n),this._listeners.push({target:e,name:t,fn:n})};t(document,"blur",this._onBlur),t(window,"mouseup",this._onWindowMouseUp),e.addEventListener("wheel",this._onWheel,{passive:!1})}componentWillUnmount(){this._listeners.forEach(e=>{e.target.removeEventListener(e.name,e.fn)}),this._endDragging();const{_el:e}=this;e&&e.removeEventListener("wheel",this._onWheel,{passive:!1})}focus(){this._el&&this._el.focus()}_isLeftMouseDown(){return this._buttons.has(0)}_isRightMouseDown(){return this._buttons.has(2)}_getMagnitude(e=1){return this._shiftKey?e/10:e}_getMoveMagnitude(){if(this._ctrlKey)return{x:0,y:0};const{cameraStore:{state:{distance:e,perspective:t}}}=this.props;if(t)return{x:e,y:e};const{width:n,height:r}=this._rect,i=ii(e,n,r);return{x:i.width,y:i.height}}startDragging(e){0!==e.button&&this._el&&"function"==typeof this._el.requestPointerLock&&this._el.requestPointerLock(),window.addEventListener("mousemove",this._onWindowMouseMove)}_endDragging(){window.removeEventListener("mousemove",this._onWindowMouseMove),"function"==typeof document.exitPointerLock&&document.exitPointerLock()}_moveKeyboard(e){const t={x:0,y:0,zoom:0,yaw:0,tilt:0};this._keys.forEach(e=>{const{x:n=0,y:r=0,zoom:i=0,yaw:o=0,tilt:a=0}=this._getKeyMotion(e)||{};t.x+=n,t.y+=r,t.zoom+=i,t.yaw+=o,t.tilt+=a});const{cameraStore:{cameraMove:n,cameraRotate:r,cameraZoom:i,state:{perspective:o}}}=this.props;if(t.x||t.y){const{x:r,y:i}=this._getMoveMagnitude();n([t.x*r*e,t.y*i*e])}(t.yaw||o&&t.tilt)&&r([t.yaw*e,o?t.tilt*e:0]),t.zoom&&i(t.zoom*e)}_startKeyTimer(e){this._keyTimer||(this._keyTimer=requestAnimationFrame(t=>{this._moveKeyboard((e?t-e:0)/1e3),this._keyTimer=void 0,this._keys.size&&this._startKeyTimer(t)}))}_stopKeyTimer(){this._keyTimer&&cancelAnimationFrame(this._keyTimer),this._keyTimer=void 0}render(){const{children:e}=this.props;return t.createElement("div",{tabIndex:0,style:{outline:"none"},draggable:!0,ref:e=>this._el=e,onMouseDown:this._onMouseDown,onMouseUp:this._onMouseUp,onBlur:this._onBlur,onContextMenu:this._onContextMenu,onKeyDown:this._onKeyDown,onKeyUp:this._onKeyUp},e)}}function Bo(){return process&&process.env&&"development"}const Ro=[0,0,0],Lo=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class Ho{constructor(e,t,n){i(this,"origin",void 0),i(this,"dir",void 0),i(this,"point",void 0),this.origin=e,this.dir=t,this.point=n}distanceToPoint(e){return Fr(this.origin,e)}planeIntersection(e,t){const n=Rr(t,e),r=Rr(t,this.dir);if(0===r)return null;const i=(n-Rr(t,this.origin))/r;var o,a,s;return Tr([0,0,0],this.origin,(o=Ro,a=this.dir,s=i,o[0]=a[0]*s,o[1]=a[1]*s,o[2]=a[2]*s,o))}}function Wo(e,{clientX:t,clientY:n,width:r,height:i}){const o=e.getProjection(),a=e.getView(),s=_r(Lo,o,a),c=Hr([0,0,0],[2*t/r-1,-2*n/i+1,0],wr(Lo,s)),u=Hr([0,0,0],[0,0,0],wr(Lo,a)),f=Br([0,0,0],Dr(Ro,c,u));return new Ho(u,f,c)}var No=n.createContext(void 0);class Uo extends t.Component{constructor(e){super(e),i(this,"context",void 0),"production"!==Bo()&&(this.shouldComponentUpdate=(e=>(e.reglCommand!==this.props.reglCommand&&console.error("Changing the regl command prop on a <Command /> is not supported."),!0)))}componentDidMount(){const e=this.context;e&&(e.onMount(this,this.props.reglCommand),this._updateContext())}componentDidUpdate(){this._updateContext()}componentWillUnmount(){const e=this.context;e&&e.onUnmount(this)}_updateContext(){const e=this.context;if(!e)return;const{reglCommand:t,layerIndex:n,getChildrenForHitmap:r}=this.props,i=this.props.children||this.props.drawProps;null!=i&&e.registerDrawCall({instance:this,reglCommand:t,children:i,layerIndex:n,getChildrenForHitmap:r})}handleMouseEvent(e,t,n,r){const i=this.props[r];i&&e.length&&i(n,{ray:t,objects:e})}render(){return t.createElement(No.Consumer,null,e=>(e&&(this.context=e),null))}}i(Uo,"displayName","Command");const Go=(()=>global.postMessage&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope)()?class{constructor(e){i(this,"_callback",void 0),this._callback=e}observe(){this._callback([{contentRect:{width:150,height:150}}])}unobserve(){}}:ResizeObserver;function Ko({children:e}){const[r,i]=t.useState(void 0),[o,a]=t.useState(),[s]=t.useState(()=>new Go(e=>{if(!e||!e.length)return;const t=Math.round(e[0].contentRect.width),n=Math.round(e[0].contentRect.height),r=Math.round(e[0].contentRect.left),i=Math.round(e[0].contentRect.top);a({width:t,height:n,top:i,left:r})})),c=t.useCallback(e=>{e&&i(e.parentElement)},[]);return t.useEffect(()=>{if(r)return s.observe(r),()=>s.unobserve(r)},[r,s]),null==o?n.createElement("div",{ref:c}):e(o)}var Vo=s(function(e,t){e.exports=function(){var e=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray},t=function(e,t){for(var n=Object.keys(t),r=0;r<n.length;++r)e[n[r]]=t[n[r]];return e},n="\n";function r(e){var t=new Error("(regl) "+e);throw console.error(t),t}function i(e,t){e||r(t)}function o(e){return e?": "+e:""}function a(e,t,n){t.indexOf(e)<0&&r("invalid value"+o(n)+". must be one of: "+t)}var s=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function c(e,t){for(e+="";e.length<t;)e=" "+e;return e}function u(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function f(e,t){this.number=e,this.line=t,this.errors=[]}function l(e,t,n){this.file=e,this.line=t,this.message=n}function p(){var e=new Error,t=(e.stack||e).toString(),n=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(t);if(n)return n[1];var r=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(t);return r?r[1]:"unknown"}function h(){var e=new Error,t=(e.stack||e).toString(),n=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(t);if(n)return n[1];var r=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(t);return r?r[1]:"unknown"}function d(e,t){var n,r=e.split("\n"),i=1,o=0,a={unknown:new u,0:new u};a.unknown.name=a[0].name=t||p(),a.unknown.lines.push(new f(0,""));for(var s=0;s<r.length;++s){var c=r[s],l=/^\s*\#\s*(\w+)\s+(.+)\s*$/.exec(c);if(l)switch(l[1]){case"line":var h=/(\d+)(\s+\d+)?/.exec(l[2]);h&&(i=0|h[1],h[2]&&((o=0|h[2])in a||(a[o]=new u)));break;case"define":var d=/SHADER_NAME(_B64)?\s+(.*)$/.exec(l[2]);d&&(a[o].name=d[1]?(n=d[2],"undefined"!=typeof atob?atob(n):"base64:"+n):d[2])}a[o].lines.push(new f(i++,c))}return Object.keys(a).forEach(function(e){var t=a[e];t.lines.forEach(function(e){t.index[e.number]=e})}),a}function m(e){e._commandRef=p()}function v(e,t){var n=h();r(e+" in command "+(t||p())+("unknown"===n?"":" called from "+n))}function g(e,t,n,r){typeof e!==t&&v("invalid parameter type"+o(n)+". expected "+t+", got "+typeof e,r||p())}var b=33071,y=9728,x=9984,w=9985,_=9986,C=9987,A=5126,j=32819,S=32820,k=33635,E=34042,O={};function M(e,t){return e===S||e===j||e===k?2:e===E?4:O[e]*t}function P(e){return!(e&e-1||!e)}O[5120]=O[5121]=1,O[5122]=O[5123]=O[36193]=O[k]=O[j]=O[S]=2,O[5124]=O[5125]=O[A]=O[E]=4;var T=t(i,{optional:function(e){e()},raise:r,commandRaise:v,command:function(e,t,n){e||v(t,n||p())},parameter:function(e,t,n){e in t||r("unknown parameter ("+e+")"+o(n)+". possible values: "+Object.keys(t).join())},commandParameter:function(e,t,n,r){e in t||v("unknown parameter ("+e+")"+o(n)+". possible values: "+Object.keys(t).join(),r||p())},constructor:function(e){Object.keys(e).forEach(function(e){s.indexOf(e)<0&&r('invalid regl constructor argument "'+e+'". must be one of '+s)})},type:function(e,t,n){typeof e!==t&&r("invalid parameter type"+o(n)+". expected "+t+", got "+typeof e)},commandType:g,isTypedArray:function(t,n){e(t)||r("invalid parameter type"+o(n)+". must be a typed array")},nni:function(e,t){e>=0&&(0|e)===e||r("invalid parameter type, ("+e+")"+o(t)+". must be a nonnegative integer")},oneOf:a,shaderError:function(e,t,r,o,a){if(!e.getShaderParameter(t,e.COMPILE_STATUS)){var s=e.getShaderInfoLog(t),u=o===e.FRAGMENT_SHADER?"fragment":"vertex";g(r,"string",u+" shader source must be a string",a);var f=d(r,a),p=function(e){var t=[];return e.split("\n").forEach(function(e){if(!(e.length<5)){var n=/^ERROR\:\s+(\d+)\:(\d+)\:\s*(.*)$/.exec(e);n?t.push(new l(0|n[1],0|n[2],n[3].trim())):e.length>0&&t.push(new l("unknown",0,e))}}),t}(s);!function(e,t){t.forEach(function(t){var n=e[t.file];if(n){var r=n.index[t.line];if(r)return r.errors.push(t),void(n.hasErrors=!0)}e.unknown.hasErrors=!0,e.unknown.lines[0].errors.push(t)})}(f,p),Object.keys(f).forEach(function(e){var t=f[e];if(t.hasErrors){var r=[""],i=[""];o("file number "+e+": "+t.name+"\n","color:red;text-decoration:underline;font-weight:bold"),t.lines.forEach(function(e){if(e.errors.length>0){o(c(e.number,4)+"|  ","background-color:yellow; font-weight:bold"),o(e.line+n,"color:red; background-color:yellow; font-weight:bold");var t=0;e.errors.forEach(function(r){var i=r.message,a=/^\s*\'(.*)\'\s*\:\s*(.*)$/.exec(i);if(a){var s=a[1];switch(i=a[2],s){case"assign":s="="}t=Math.max(e.line.indexOf(s,t),0)}else t=0;o(c("| ",6)),o(c("^^^",t+3)+n,"font-weight:bold"),o(c("| ",6)),o(i+n,"font-weight:bold")}),o(c("| ",6)+n)}else o(c(e.number,4)+"|  "),o(e.line+n,"color:red")}),"undefined"==typeof document||window.chrome?console.log(r.join("")):(i[0]=r.join("%c"),console.log.apply(console,i))}function o(e,t){r.push(e),i.push(t||"")}}),i.raise("Error compiling "+u+" shader, "+f[0].name)}},linkError:function(e,t,r,o,a){if(!e.getProgramParameter(t,e.LINK_STATUS)){var s=e.getProgramInfoLog(t),c=d(r,a),u=d(o,a),f='Error linking program with vertex shader, "'+u[0].name+'", and fragment shader "'+c[0].name+'"';"undefined"!=typeof document?console.log("%c"+f+n+"%c"+s,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(f+n+s),i.raise(f)}},callSite:h,saveCommandRef:m,saveDrawInfo:function(e,t,n,r){function i(e){return e?r.id(e):0}function o(e,t){Object.keys(t).forEach(function(t){e[r.id(t)]=!0})}m(e),e._fragId=i(e.static.frag),e._vertId=i(e.static.vert);var a=e._uniformSet={};o(a,t.static),o(a,t.dynamic);var s=e._attributeSet={};o(s,n.static),o(s,n.dynamic),e._hasCount="count"in e.static||"count"in e.dynamic||"elements"in e.static||"elements"in e.dynamic},framebufferFormat:function(e,t,n){e.texture?a(e.texture._texture.internalformat,t,"unsupported texture format for attachment"):a(e.renderbuffer._renderbuffer.format,n,"unsupported renderbuffer format for attachment")},guessCommand:p,texture2D:function(e,t,n){var r,o=t.width,a=t.height,s=t.channels;i(o>0&&o<=n.maxTextureSize&&a>0&&a<=n.maxTextureSize,"invalid texture shape"),(e.wrapS!==b||e.wrapT!==b)&&i(P(o)&&P(a),"incompatible wrap mode for texture, both width and height must be power of 2"),1===t.mipmask?1!==o&&1!==a&&i(e.minFilter!==x&&e.minFilter!==_&&e.minFilter!==w&&e.minFilter!==C,"min filter requires mipmap"):(i(P(o)&&P(a),"texture must be a square power of 2 to support mipmapping"),i(t.mipmask===(o<<1)-1,"missing or incomplete mipmap data")),t.type===A&&(n.extensions.indexOf("oes_texture_float_linear")<0&&i(e.minFilter===y&&e.magFilter===y,"filter not supported, must enable oes_texture_float_linear"),i(!e.genMipmaps,"mipmap generation not supported with float textures"));var c=t.images;for(r=0;r<16;++r)if(c[r]){var u=o>>r,f=a>>r;i(t.mipmask&1<<r,"missing mipmap data");var l=c[r];if(i(l.width===u&&l.height===f,"invalid shape for mip images"),i(l.format===t.format&&l.internalformat===t.internalformat&&l.type===t.type,"incompatible type for mip image"),l.compressed);else if(l.data){var p=Math.ceil(M(l.type,s)*u/l.unpackAlignment)*l.unpackAlignment;i(l.data.byteLength===p*f,"invalid data for image, buffer size is inconsistent with image format")}else l.element||l.copy}else e.genMipmaps||i(0==(t.mipmask&1<<r),"extra mipmap data");t.compressed&&i(!e.genMipmaps,"mipmap generation for compressed images not supported")},textureCube:function(e,t,n,r){var o=e.width,a=e.height,s=e.channels;i(o>0&&o<=r.maxTextureSize&&a>0&&a<=r.maxTextureSize,"invalid texture shape"),i(o===a,"cube map must be square"),i(t.wrapS===b&&t.wrapT===b,"wrap mode not supported by cube map");for(var c=0;c<n.length;++c){var u=n[c];i(u.width===o&&u.height===a,"inconsistent cube map face shape"),t.genMipmaps&&(i(!u.compressed,"can not generate mipmap for compressed textures"),i(1===u.mipmask,"can not specify mipmaps and generate mipmaps"));for(var f=u.images,l=0;l<16;++l){var p=f[l];if(p){var h=o>>l,d=a>>l;i(u.mipmask&1<<l,"missing mipmap data"),i(p.width===h&&p.height===d,"invalid shape for mip images"),i(p.format===e.format&&p.internalformat===e.internalformat&&p.type===e.type,"incompatible type for mip image"),p.compressed||(p.data?i(p.data.byteLength===h*d*Math.max(M(p.type,s),p.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):p.element||p.copy)}}}}}),D=0,z=0;function F(e,t){this.id=D++,this.type=e,this.data=t}function I(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function B(e){return"["+function e(t){if(0===t.length)return[];var n=t.charAt(0),r=t.charAt(t.length-1);if(t.length>1&&n===r&&('"'===n||"'"===n))return['"'+I(t.substr(1,t.length-2))+'"'];var i=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(t);if(i)return e(t.substr(0,i.index)).concat(e(i[1])).concat(e(t.substr(i.index+i[0].length)));var o=t.split(".");if(1===o.length)return['"'+I(t)+'"'];for(var a=[],s=0;s<o.length;++s)a=a.concat(e(o[s]));return a}(e).join("][")+"]"}var R={DynamicVariable:F,define:function(e,t){return new F(e,B(t+""))},isDynamic:function(e){return"function"==typeof e&&!e._reglType||e instanceof F},unbox:function(e,t){return"function"==typeof e?new F(z,e):e},accessor:B},L={next:"function"==typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"==typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},H="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function W(e){return"string"==typeof e?e.split():(T(Array.isArray(e),"invalid extension array"),e)}function N(e){return"string"==typeof e?(T("undefined"!=typeof document,"not supported outside of DOM"),document.querySelector(e)):e}function U(e){var n,r,i,o,a,s=e||{},c={},u=[],f=[],l="undefined"==typeof window?1:window.devicePixelRatio,p=!1,h=function(e){e&&T.raise(e)},d=function(){};if("string"==typeof s?(T("undefined"!=typeof document,"selector queries only supported in DOM enviroments"),n=document.querySelector(s),T(n,"invalid query string for element")):"object"==typeof s?"string"==typeof(a=s).nodeName&&"function"==typeof a.appendChild&&"function"==typeof a.getBoundingClientRect?n=s:function(e){return"function"==typeof e.drawArrays||"function"==typeof e.drawElements}(s)?i=(o=s).canvas:(T.constructor(s),"gl"in s?o=s.gl:"canvas"in s?i=N(s.canvas):"container"in s&&(r=N(s.container)),"attributes"in s&&(c=s.attributes,T.type(c,"object","invalid context attributes")),"extensions"in s&&(u=W(s.extensions)),"optionalExtensions"in s&&(f=W(s.optionalExtensions)),"onDone"in s&&(T.type(s.onDone,"function","invalid or missing onDone callback"),h=s.onDone),"profile"in s&&(p=!!s.profile),"pixelRatio"in s&&(l=+s.pixelRatio,T(l>0,"invalid pixel ratio"))):T.raise("invalid arguments to regl"),n&&("canvas"===n.nodeName.toLowerCase()?i=n:r=n),!o){if(!i){T("undefined"!=typeof document,"must manually specify webgl context outside of DOM environments");var m=function(e,n,r){var i=document.createElement("canvas");function o(){var n=window.innerWidth,o=window.innerHeight;if(e!==document.body){var a=e.getBoundingClientRect();n=a.right-a.left,o=a.bottom-a.top}i.width=r*n,i.height=r*o,t(i.style,{width:n+"px",height:o+"px"})}return t(i.style,{border:0,margin:0,padding:0,top:0,left:0}),e.appendChild(i),e===document.body&&(i.style.position="absolute",t(e.style,{margin:0,padding:0})),window.addEventListener("resize",o,!1),o(),{canvas:i,onDestroy:function(){window.removeEventListener("resize",o),e.removeChild(i)}}}(r||document.body,0,l);if(!m)return null;i=m.canvas,d=m.onDestroy}o=function(e,t){function n(n){try{return e.getContext(n,t)}catch(e){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}(i,c)}return o?{gl:o,canvas:i,container:r,extensions:u,optionalExtensions:f,pixelRatio:l,profile:p,onDone:h,onDestroy:d}:(d(),h("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function G(e,t){for(var n=Array(e),r=0;r<e;++r)n[r]=t(r);return n}var K=5120,V=5121,q=5122,$=5123,Y=5124,Z=5125,X=5126;function Q(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function J(){var e=G(8,function(){return[]});function t(t){var n=function(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}(t),r=e[Q(n)>>2];return r.length>0?r.pop():new ArrayBuffer(n)}function n(t){e[Q(t.byteLength)>>2].push(t)}return{alloc:t,free:n,allocType:function(e,n){var r=null;switch(e){case K:r=new Int8Array(t(n),0,n);break;case V:r=new Uint8Array(t(n),0,n);break;case q:r=new Int16Array(t(2*n),0,n);break;case $:r=new Uint16Array(t(2*n),0,n);break;case Y:r=new Int32Array(t(4*n),0,n);break;case Z:r=new Uint32Array(t(4*n),0,n);break;case X:r=new Float32Array(t(4*n),0,n);break;default:return null}return r.length!==n?r.subarray(0,n):r},freeType:function(e){n(e.buffer)}}}var ee=J();ee.zero=J();var te=function(e,t){var n=1;t.ext_texture_filter_anisotropic&&(n=e.getParameter(34047));var r=1,i=1;t.webgl_draw_buffers&&(r=e.getParameter(34852),i=e.getParameter(36063));var o=!!t.oes_texture_float;if(o){var a=e.createTexture();e.bindTexture(3553,a),e.texImage2D(3553,0,6408,1,1,0,6408,5126,null);var s=e.createFramebuffer();if(e.bindFramebuffer(36160,s),e.framebufferTexture2D(36160,36064,3553,a,0),e.bindTexture(3553,null),36053!==e.checkFramebufferStatus(36160))o=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(16384);var c=ee.allocType(5126,4);e.readPixels(0,0,1,1,6408,5126,c),e.getError()?o=!1:(e.deleteFramebuffer(s),e.deleteTexture(a),o=1===c[0]),ee.freeType(c)}}var u="undefined"!=typeof navigator&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent)),f=!0;if(!u){var l=e.createTexture(),p=ee.allocType(5121,36);e.activeTexture(33984),e.bindTexture(34067,l),e.texImage2D(34069,0,6408,3,3,0,6408,5121,p),ee.freeType(p),e.bindTexture(34067,null),e.deleteTexture(l),f=!e.getError()}return{colorBits:[e.getParameter(3410),e.getParameter(3411),e.getParameter(3412),e.getParameter(3413)],depthBits:e.getParameter(3414),stencilBits:e.getParameter(3415),subpixelBits:e.getParameter(3408),extensions:Object.keys(t).filter(function(e){return!!t[e]}),maxAnisotropic:n,maxDrawbuffers:r,maxColorAttachments:i,pointSizeDims:e.getParameter(33901),lineWidthDims:e.getParameter(33902),maxViewportDims:e.getParameter(3386),maxCombinedTextureUnits:e.getParameter(35661),maxCubeMapSize:e.getParameter(34076),maxRenderbufferSize:e.getParameter(34024),maxTextureUnits:e.getParameter(34930),maxTextureSize:e.getParameter(3379),maxAttributes:e.getParameter(34921),maxVertexUniforms:e.getParameter(36347),maxVertexTextureUnits:e.getParameter(35660),maxVaryingVectors:e.getParameter(36348),maxFragmentUniforms:e.getParameter(36349),glsl:e.getParameter(35724),renderer:e.getParameter(7937),vendor:e.getParameter(7936),version:e.getParameter(7938),readFloat:o,npotTextureCube:f}};function ne(t){return!!t&&"object"==typeof t&&Array.isArray(t.shape)&&Array.isArray(t.stride)&&"number"==typeof t.offset&&t.shape.length===t.stride.length&&(Array.isArray(t.data)||e(t.data))}var re=function(e){return Object.keys(e).map(function(t){return e[t]})},ie={shape:function(e){for(var t=[],n=e;n.length;n=n[0])t.push(n.length);return t},flatten:function(e,t,n,r){var i=1;if(t.length)for(var o=0;o<t.length;++o)i*=t[o];else i=0;var a=r||ee.allocType(n,i);switch(t.length){case 0:break;case 1:!function(e,t,n){for(var r=0;r<t;++r)n[r]=e[r]}(e,t[0],a);break;case 2:!function(e,t,n,r){for(var i=0,o=0;o<t;++o)for(var a=e[o],s=0;s<n;++s)r[i++]=a[s]}(e,t[0],t[1],a);break;case 3:oe(e,t[0],t[1],t[2],a,0);break;default:!function e(t,n,r,i,o){for(var a=1,s=r+1;s<n.length;++s)a*=n[s];var c=n[r];if(n.length-r==4){var u=n[r+1],f=n[r+2],l=n[r+3];for(s=0;s<c;++s)oe(t[s],u,f,l,i,o),o+=a}else for(s=0;s<c;++s)e(t[s],n,r+1,i,o),o+=a}(e,t,0,a,0)}return a}};function oe(e,t,n,r,i,o){for(var a=o,s=0;s<t;++s)for(var c=e[s],u=0;u<n;++u)for(var f=c[u],l=0;l<r;++l)i[a++]=f[l]}var ae={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},se={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},ce={dynamic:35048,stream:35040,static:35044},ue=ie.flatten,fe=ie.shape,le=35044,pe=35040,he=5121,de=5126,me=[];function ve(e){return 0|ae[Object.prototype.toString.call(e)]}function ge(e,t){for(var n=0;n<t.length;++n)e[n]=t[n]}function be(e,t,n,r,i,o,a){for(var s=0,c=0;c<n;++c)for(var u=0;u<r;++u)e[s++]=t[i*c+o*u+a]}me[5120]=1,me[5122]=2,me[5124]=4,me[5121]=1,me[5123]=2,me[5125]=4,me[5126]=4;var ye={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},xe=0,we=1,_e=4,Ce=5120,Ae=5121,je=5122,Se=5123,ke=5124,Ee=5125,Oe=34963,Me=35040,Pe=35044,Te=new Float32Array(1),De=new Uint32Array(Te.buffer),ze=5123;function Fe(e){for(var t=ee.allocType(ze,e.length),n=0;n<e.length;++n)if(isNaN(e[n]))t[n]=65535;else if(e[n]===1/0)t[n]=31744;else if(e[n]===-1/0)t[n]=64512;else{Te[0]=e[n];var r=De[0],i=r>>>31<<15,o=(r<<1>>>24)-127,a=r>>13&1023;if(o<-24)t[n]=i;else if(o<-14){var s=-14-o;t[n]=i+(a+1024>>s)}else t[n]=o>15?i+31744:i+(o+15<<10)+a}return t}function Ie(t){return Array.isArray(t)||e(t)}var Be=function(e){return!(e&e-1||!e)},Re=34467,Le=3553,He=34067,We=34069,Ne=6408,Ue=6406,Ge=6407,Ke=6409,Ve=6410,qe=32854,$e=32855,Ye=36194,Ze=32819,Xe=32820,Qe=33635,Je=34042,et=6402,tt=34041,nt=35904,rt=35906,it=36193,ot=33776,at=33777,st=33778,ct=33779,ut=35986,ft=35987,lt=34798,pt=35840,ht=35841,dt=35842,mt=35843,vt=36196,gt=5121,bt=5123,yt=5125,xt=5126,wt=10242,_t=10243,Ct=10497,At=33071,jt=33648,St=10240,kt=10241,Et=9728,Ot=9729,Mt=9984,Pt=9985,Tt=9986,Dt=9987,zt=33170,Ft=4352,It=4353,Bt=4354,Rt=34046,Lt=3317,Ht=37440,Wt=37441,Nt=37443,Ut=37444,Gt=33984,Kt=[Mt,Tt,Pt,Dt],Vt=[0,Ke,Ve,Ge,Ne],qt={};function $t(e){return"[object "+e+"]"}qt[Ke]=qt[Ue]=qt[et]=1,qt[tt]=qt[Ve]=2,qt[Ge]=qt[nt]=3,qt[Ne]=qt[rt]=4;var Yt=$t("HTMLCanvasElement"),Zt=$t("CanvasRenderingContext2D"),Xt=$t("ImageBitmap"),Qt=$t("HTMLImageElement"),Jt=$t("HTMLVideoElement"),en=Object.keys(ae).concat([Yt,Zt,Xt,Qt,Jt]),tn=[];tn[gt]=1,tn[xt]=4,tn[it]=2,tn[bt]=2,tn[yt]=4;var nn=[];function rn(e){return Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function on(e){if(!Array.isArray(e))return!1;var t=e.length;return!(0===t||!Ie(e[0]))}function an(e){return Object.prototype.toString.call(e)}function sn(e){return an(e)===Yt}function cn(e){if(!e)return!1;var t=an(e);return en.indexOf(t)>=0||rn(e)||on(e)||ne(e)}function un(e){return 0|ae[Object.prototype.toString.call(e)]}function fn(e,t){return ee.allocType(e.type===it?xt:e.type,t)}function ln(e,t){e.type===it?(e.data=Fe(t),ee.freeType(t)):e.data=t}function pn(e,t,n,r,i,o){var a;if(a=void 0!==nn[e]?nn[e]:qt[e]*tn[t],o&&(a*=6),i){for(var s=0,c=n;c>=1;)s+=a*c*c,c/=2;return s}return a*n*r}function hn(n,r,i,o,a,s,c){var u={"don't care":Ft,"dont care":Ft,nice:Bt,fast:It},f={repeat:Ct,clamp:At,mirror:jt},l={nearest:Et,linear:Ot},p=t({mipmap:Dt,"nearest mipmap nearest":Mt,"linear mipmap nearest":Pt,"nearest mipmap linear":Tt,"linear mipmap linear":Dt},l),h={none:0,browser:Ut},d={uint8:gt,rgba4:Ze,rgb565:Qe,"rgb5 a1":Xe},m={alpha:Ue,luminance:Ke,"luminance alpha":Ve,rgb:Ge,rgba:Ne,rgba4:qe,"rgb5 a1":$e,rgb565:Ye},v={};r.ext_srgb&&(m.srgb=nt,m.srgba=rt),r.oes_texture_float&&(d.float32=d.float=xt),r.oes_texture_half_float&&(d.float16=d["half float"]=it),r.webgl_depth_texture&&(t(m,{depth:et,"depth stencil":tt}),t(d,{uint16:bt,uint32:yt,"depth stencil":Je})),r.webgl_compressed_texture_s3tc&&t(v,{"rgb s3tc dxt1":ot,"rgba s3tc dxt1":at,"rgba s3tc dxt3":st,"rgba s3tc dxt5":ct}),r.webgl_compressed_texture_atc&&t(v,{"rgb atc":ut,"rgba atc explicit alpha":ft,"rgba atc interpolated alpha":lt}),r.webgl_compressed_texture_pvrtc&&t(v,{"rgb pvrtc 4bppv1":pt,"rgb pvrtc 2bppv1":ht,"rgba pvrtc 4bppv1":dt,"rgba pvrtc 2bppv1":mt}),r.webgl_compressed_texture_etc1&&(v["rgb etc1"]=vt);var g=Array.prototype.slice.call(n.getParameter(Re));Object.keys(v).forEach(function(e){var t=v[e];g.indexOf(t)>=0&&(m[e]=t)});var b=Object.keys(m);i.textureFormats=b;var y=[];Object.keys(m).forEach(function(e){var t=m[e];y[t]=e});var x=[];Object.keys(d).forEach(function(e){var t=d[e];x[t]=e});var w=[];Object.keys(l).forEach(function(e){var t=l[e];w[t]=e});var _=[];Object.keys(p).forEach(function(e){var t=p[e];_[t]=e});var C=[];Object.keys(f).forEach(function(e){var t=f[e];C[t]=e});var A=b.reduce(function(e,t){var n=m[t];return n===Ke||n===Ue||n===Ke||n===Ve||n===et||n===tt?e[n]=n:n===$e||t.indexOf("rgba")>=0?e[n]=Ne:e[n]=Ge,e},{});function j(){this.internalformat=Ne,this.format=Ne,this.type=gt,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=Ut,this.width=0,this.height=0,this.channels=0}function S(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function k(e,t){if("object"==typeof t&&t){if("premultiplyAlpha"in t&&(T.type(t.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(T.type(t.flipY,"boolean","invalid texture flip"),e.flipY=t.flipY),"alignment"in t&&(T.oneOf(t.alignment,[1,2,4,8],"invalid texture unpack alignment"),e.unpackAlignment=t.alignment),"colorSpace"in t&&(T.parameter(t.colorSpace,h,"invalid colorSpace"),e.colorSpace=h[t.colorSpace]),"type"in t){var n=t.type;T(r.oes_texture_float||!("float"===n||"float32"===n),"you must enable the OES_texture_float extension in order to use floating point textures."),T(r.oes_texture_half_float||!("half float"===n||"float16"===n),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),T(r.webgl_depth_texture||!("uint16"===n||"uint32"===n||"depth stencil"===n),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),T.parameter(n,d,"invalid texture type"),e.type=d[n]}var o=e.width,a=e.height,s=e.channels,c=!1;"shape"in t?(T(Array.isArray(t.shape)&&t.shape.length>=2,"shape must be an array"),o=t.shape[0],a=t.shape[1],3===t.shape.length&&(s=t.shape[2],T(s>0&&s<=4,"invalid number of channels"),c=!0),T(o>=0&&o<=i.maxTextureSize,"invalid width"),T(a>=0&&a<=i.maxTextureSize,"invalid height")):("radius"in t&&(o=a=t.radius,T(o>=0&&o<=i.maxTextureSize,"invalid radius")),"width"in t&&(o=t.width,T(o>=0&&o<=i.maxTextureSize,"invalid width")),"height"in t&&(a=t.height,T(a>=0&&a<=i.maxTextureSize,"invalid height")),"channels"in t&&(s=t.channels,T(s>0&&s<=4,"invalid number of channels"),c=!0)),e.width=0|o,e.height=0|a,e.channels=0|s;var u=!1;if("format"in t){var f=t.format;T(r.webgl_depth_texture||!("depth"===f||"depth stencil"===f),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),T.parameter(f,m,"invalid texture format");var l=e.internalformat=m[f];e.format=A[l],f in d&&("type"in t||(e.type=d[f])),f in v&&(e.compressed=!0),u=!0}!c&&u?e.channels=qt[e.format]:c&&!u?e.channels!==Vt[e.format]&&(e.format=e.internalformat=Vt[e.channels]):u&&c&&T(e.channels===qt[e.format],"number of channels inconsistent with specified format")}}function E(e){n.pixelStorei(Ht,e.flipY),n.pixelStorei(Wt,e.premultiplyAlpha),n.pixelStorei(Nt,e.colorSpace),n.pixelStorei(Lt,e.unpackAlignment)}function O(){j.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function M(t,n){var r=null;if(cn(n)?r=n:n&&(T.type(n,"object","invalid pixel data type"),k(t,n),"x"in n&&(t.xOffset=0|n.x),"y"in n&&(t.yOffset=0|n.y),cn(n.data)&&(r=n.data)),T(!t.compressed||r instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),n.copy){T(!r,"can not specify copy and data field for the same texture");var o=a.viewportWidth,s=a.viewportHeight;t.width=t.width||o-t.xOffset,t.height=t.height||s-t.yOffset,t.needsCopy=!0,T(t.xOffset>=0&&t.xOffset<o&&t.yOffset>=0&&t.yOffset<s&&t.width>0&&t.width<=o&&t.height>0&&t.height<=s,"copy texture read out of bounds")}else if(r){if(e(r))t.channels=t.channels||4,t.data=r,"type"in n||t.type!==gt||(t.type=un(r));else if(rn(r))t.channels=t.channels||4,function(e,t){var n=t.length;switch(e.type){case gt:case bt:case yt:case xt:var r=ee.allocType(e.type,n);r.set(t),e.data=r;break;case it:e.data=Fe(t);break;default:T.raise("unsupported texture type, must specify a typed array")}}(t,r),t.alignment=1,t.needsFree=!0;else if(ne(r)){var c=r.data;Array.isArray(c)||t.type!==gt||(t.type=un(c));var u,f,l,p,h,d,m=r.shape,v=r.stride;3===m.length?(l=m[2],d=v[2]):(T(2===m.length,"invalid ndarray pixel data, must be 2 or 3D"),l=1,d=1),u=m[0],f=m[1],p=v[0],h=v[1],t.alignment=1,t.width=u,t.height=f,t.channels=l,t.format=t.internalformat=Vt[l],t.needsFree=!0,function(e,t,n,r,i,o){for(var a=e.width,s=e.height,c=e.channels,u=fn(e,a*s*c),f=0,l=0;l<s;++l)for(var p=0;p<a;++p)for(var h=0;h<c;++h)u[f++]=t[n*p+r*l+i*h+o];ln(e,u)}(t,c,p,h,d,r.offset)}else if(sn(r)||an(r)===Zt)sn(r)?t.element=r:t.element=r.canvas,t.width=t.element.width,t.height=t.element.height,t.channels=4;else if(function(e){return an(e)===Xt}(r))t.element=r,t.width=r.width,t.height=r.height,t.channels=4;else if(function(e){return an(e)===Qt}(r))t.element=r,t.width=r.naturalWidth,t.height=r.naturalHeight,t.channels=4;else if(function(e){return an(e)===Jt}(r))t.element=r,t.width=r.videoWidth,t.height=r.videoHeight,t.channels=4;else if(on(r)){var g=t.width||r[0].length,b=t.height||r.length,y=t.channels;y=Ie(r[0][0])?y||r[0][0].length:y||1;for(var x=ie.shape(r),w=1,_=0;_<x.length;++_)w*=x[_];var C=fn(t,w);ie.flatten(r,x,"",C),ln(t,C),t.alignment=1,t.width=g,t.height=b,t.channels=y,t.format=t.internalformat=Vt[y],t.needsFree=!0}}else t.width=t.width||1,t.height=t.height||1,t.channels=t.channels||4;t.type===xt?T(i.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):t.type===it&&T(i.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function P(e,t,r){var i=e.element,a=e.data,s=e.internalformat,c=e.format,u=e.type,f=e.width,l=e.height,p=e.channels;if(E(e),i)n.texImage2D(t,r,c,c,u,i);else if(e.compressed)n.compressedTexImage2D(t,r,s,f,l,0,a);else if(e.needsCopy)o(),n.copyTexImage2D(t,r,c,e.xOffset,e.yOffset,f,l,0);else{var h=!a;h&&(a=ee.zero.allocType(u,f*l*p)),n.texImage2D(t,r,c,f,l,0,c,u,a),h&&a&&ee.zero.freeType(a)}}function D(e,t,r,i,a){var s=e.element,c=e.data,u=e.internalformat,f=e.format,l=e.type,p=e.width,h=e.height;E(e),s?n.texSubImage2D(t,a,r,i,f,l,s):e.compressed?n.compressedTexSubImage2D(t,a,r,i,u,p,h,c):e.needsCopy?(o(),n.copyTexSubImage2D(t,a,r,i,e.xOffset,e.yOffset,p,h)):n.texSubImage2D(t,a,r,i,p,h,f,l,c)}var z=[];function F(){return z.pop()||new O}function I(e){e.needsFree&&ee.freeType(e.data),O.call(e),z.push(e)}function B(){j.call(this),this.genMipmaps=!1,this.mipmapHint=Ft,this.mipmask=0,this.images=Array(16)}function R(e,t,n){var r=e.images[0]=F();e.mipmask=1,r.width=e.width=t,r.height=e.height=n,r.channels=e.channels=4}function L(e,t){var n=null;if(cn(t))S(n=e.images[0]=F(),e),M(n,t),e.mipmask=1;else if(k(e,t),Array.isArray(t.mipmap))for(var r=t.mipmap,i=0;i<r.length;++i)S(n=e.images[i]=F(),e),n.width>>=i,n.height>>=i,M(n,r[i]),e.mipmask|=1<<i;else S(n=e.images[0]=F(),e),M(n,t),e.mipmask=1;S(e,e.images[0]),(e.compressed&&e.internalformat===ot||e.internalformat===at||e.internalformat===st||e.internalformat===ct)&&T(e.width%4==0&&e.height%4==0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function H(e,t){for(var n=e.images,r=0;r<n.length;++r){if(!n[r])return;P(n[r],t,r)}}var W=[];function N(){var e=W.pop()||new B;j.call(e),e.mipmask=0;for(var t=0;t<16;++t)e.images[t]=null;return e}function U(e){for(var t=e.images,n=0;n<t.length;++n)t[n]&&I(t[n]),t[n]=null;W.push(e)}function G(){this.minFilter=Et,this.magFilter=Et,this.wrapS=At,this.wrapT=At,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=Ft}function K(e,t){if("min"in t){var n=t.min;T.parameter(n,p),e.minFilter=p[n],Kt.indexOf(e.minFilter)>=0&&!("faces"in t)&&(e.genMipmaps=!0)}if("mag"in t){var r=t.mag;T.parameter(r,l),e.magFilter=l[r]}var o=e.wrapS,a=e.wrapT;if("wrap"in t){var s=t.wrap;"string"==typeof s?(T.parameter(s,f),o=a=f[s]):Array.isArray(s)&&(T.parameter(s[0],f),T.parameter(s[1],f),o=f[s[0]],a=f[s[1]])}else{if("wrapS"in t){var c=t.wrapS;T.parameter(c,f),o=f[c]}if("wrapT"in t){var h=t.wrapT;T.parameter(h,f),a=f[h]}}if(e.wrapS=o,e.wrapT=a,"anisotropic"in t){var d=t.anisotropic;T("number"==typeof d&&d>=1&&d<=i.maxAnisotropic,"aniso samples must be between 1 and "),e.anisotropic=t.anisotropic}if("mipmap"in t){var m=!1;switch(typeof t.mipmap){case"string":T.parameter(t.mipmap,u,"invalid mipmap hint"),e.mipmapHint=u[t.mipmap],e.genMipmaps=!0,m=!0;break;case"boolean":m=e.genMipmaps=t.mipmap;break;case"object":T(Array.isArray(t.mipmap),"invalid mipmap type"),e.genMipmaps=!1,m=!0;break;default:T.raise("invalid mipmap type")}!m||"min"in t||(e.minFilter=Mt)}}function V(e,t){n.texParameteri(t,kt,e.minFilter),n.texParameteri(t,St,e.magFilter),n.texParameteri(t,wt,e.wrapS),n.texParameteri(t,_t,e.wrapT),r.ext_texture_filter_anisotropic&&n.texParameteri(t,Rt,e.anisotropic),e.genMipmaps&&(n.hint(zt,e.mipmapHint),n.generateMipmap(t))}var q=0,$={},Y=i.maxTextureUnits,Z=Array(Y).map(function(){return null});function X(e){j.call(this),this.mipmask=0,this.internalformat=Ne,this.id=q++,this.refCount=1,this.target=e,this.texture=n.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new G,c.profile&&(this.stats={size:0})}function Q(e){n.activeTexture(Gt),n.bindTexture(e.target,e.texture)}function J(){var e=Z[0];e?n.bindTexture(e.target,e.texture):n.bindTexture(Le,null)}function te(e){var t=e.texture;T(t,"must not double destroy texture");var r=e.unit,i=e.target;r>=0&&(n.activeTexture(Gt+r),n.bindTexture(i,null),Z[r]=null),n.deleteTexture(t),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete $[e.id],s.textureCount--}return t(X.prototype,{bind:function(){this.bindCount+=1;var e=this.unit;if(e<0){for(var t=0;t<Y;++t){var r=Z[t];if(r){if(r.bindCount>0)continue;r.unit=-1}Z[t]=this,e=t;break}e>=Y&&T.raise("insufficient number of texture units"),c.profile&&s.maxTextureUnits<e+1&&(s.maxTextureUnits=e+1),this.unit=e,n.activeTexture(Gt+e),n.bindTexture(this.target,this.texture)}return e},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&te(this)}}),c.profile&&(s.getTotalTextureSize=function(){var e=0;return Object.keys($).forEach(function(t){e+=$[t].stats.size}),e}),{create2D:function(e,t){var r=new X(Le);function o(e,t){var n=r.texInfo;G.call(n);var a=N();return"number"==typeof e?R(a,0|e,"number"==typeof t?0|t:0|e):e?(T.type(e,"object","invalid arguments to regl.texture"),K(n,e),L(a,e)):R(a,1,1),n.genMipmaps&&(a.mipmask=(a.width<<1)-1),r.mipmask=a.mipmask,S(r,a),T.texture2D(n,a,i),r.internalformat=a.internalformat,o.width=a.width,o.height=a.height,Q(r),H(a,Le),V(n,Le),J(),U(a),c.profile&&(r.stats.size=pn(r.internalformat,r.type,a.width,a.height,n.genMipmaps,!1)),o.format=y[r.internalformat],o.type=x[r.type],o.mag=w[n.magFilter],o.min=_[n.minFilter],o.wrapS=C[n.wrapS],o.wrapT=C[n.wrapT],o}return $[r.id]=r,s.textureCount++,o(e,t),o.subimage=function(e,t,n,i){T(!!e,"must specify image data");var a=0|t,s=0|n,c=0|i,u=F();return S(u,r),u.width=0,u.height=0,M(u,e),u.width=u.width||(r.width>>c)-a,u.height=u.height||(r.height>>c)-s,T(r.type===u.type&&r.format===u.format&&r.internalformat===u.internalformat,"incompatible format for texture.subimage"),T(a>=0&&s>=0&&a+u.width<=r.width&&s+u.height<=r.height,"texture.subimage write out of bounds"),T(r.mipmask&1<<c,"missing mipmap data"),T(u.data||u.element||u.needsCopy,"missing image data"),Q(r),D(u,Le,a,s,c),J(),I(u),o},o.resize=function(e,t){var i,a=0|e,s=0|t||a;if(a===r.width&&s===r.height)return o;o.width=r.width=a,o.height=r.height=s,Q(r);for(var u=r.channels,f=r.type,l=0;r.mipmask>>l;++l){var p=a>>l,h=s>>l;if(!p||!h)break;i=ee.zero.allocType(f,p*h*u),n.texImage2D(Le,l,r.format,p,h,0,r.format,r.type,i),i&&ee.zero.freeType(i)}return J(),c.profile&&(r.stats.size=pn(r.internalformat,r.type,a,s,!1,!1)),o},o._reglType="texture2d",o._texture=r,c.profile&&(o.stats=r.stats),o.destroy=function(){r.decRef()},o},createCube:function(e,t,r,o,a,u){var f=new X(He);$[f.id]=f,s.cubeCount++;var l=new Array(6);function p(e,t,n,r,o,a){var s,u=f.texInfo;for(G.call(u),s=0;s<6;++s)l[s]=N();if("number"!=typeof e&&e)if("object"==typeof e)if(t)L(l[0],e),L(l[1],t),L(l[2],n),L(l[3],r),L(l[4],o),L(l[5],a);else if(K(u,e),k(f,e),"faces"in e){var h=e.faces;for(T(Array.isArray(h)&&6===h.length,"cube faces must be a length 6 array"),s=0;s<6;++s)T("object"==typeof h[s]&&!!h[s],"invalid input for cube map face"),S(l[s],f),L(l[s],h[s])}else for(s=0;s<6;++s)L(l[s],e);else T.raise("invalid arguments to cube map");else{var d=0|e||1;for(s=0;s<6;++s)R(l[s],d,d)}for(S(f,l[0]),i.npotTextureCube||T(Be(f.width)&&Be(f.height),"your browser does not support non power or two texture dimensions"),u.genMipmaps?f.mipmask=(l[0].width<<1)-1:f.mipmask=l[0].mipmask,T.textureCube(f,u,l,i),f.internalformat=l[0].internalformat,p.width=l[0].width,p.height=l[0].height,Q(f),s=0;s<6;++s)H(l[s],We+s);for(V(u,He),J(),c.profile&&(f.stats.size=pn(f.internalformat,f.type,p.width,p.height,u.genMipmaps,!0)),p.format=y[f.internalformat],p.type=x[f.type],p.mag=w[u.magFilter],p.min=_[u.minFilter],p.wrapS=C[u.wrapS],p.wrapT=C[u.wrapT],s=0;s<6;++s)U(l[s]);return p}return p(e,t,r,o,a,u),p.subimage=function(e,t,n,r,i){T(!!t,"must specify image data"),T("number"==typeof e&&e===(0|e)&&e>=0&&e<6,"invalid face");var o=0|n,a=0|r,s=0|i,c=F();return S(c,f),c.width=0,c.height=0,M(c,t),c.width=c.width||(f.width>>s)-o,c.height=c.height||(f.height>>s)-a,T(f.type===c.type&&f.format===c.format&&f.internalformat===c.internalformat,"incompatible format for texture.subimage"),T(o>=0&&a>=0&&o+c.width<=f.width&&a+c.height<=f.height,"texture.subimage write out of bounds"),T(f.mipmask&1<<s,"missing mipmap data"),T(c.data||c.element||c.needsCopy,"missing image data"),Q(f),D(c,We+e,o,a,s),J(),I(c),p},p.resize=function(e){var t=0|e;if(t!==f.width){p.width=f.width=t,p.height=f.height=t,Q(f);for(var r=0;r<6;++r)for(var i=0;f.mipmask>>i;++i)n.texImage2D(We+r,i,f.format,t>>i,t>>i,0,f.format,f.type,null);return J(),c.profile&&(f.stats.size=pn(f.internalformat,f.type,p.width,p.height,!1,!0)),p}},p._reglType="textureCube",p._texture=f,c.profile&&(p.stats=f.stats),p.destroy=function(){f.decRef()},p},clear:function(){for(var e=0;e<Y;++e)n.activeTexture(Gt+e),n.bindTexture(Le,null),Z[e]=null;re($).forEach(te),s.cubeCount=0,s.textureCount=0},getTexture:function(e){return null},restore:function(){for(var e=0;e<Y;++e){var t=Z[e];t&&(t.bindCount=0,t.unit=-1,Z[e]=null)}re($).forEach(function(e){e.texture=n.createTexture(),n.bindTexture(e.target,e.texture);for(var t=0;t<32;++t)if(0!=(e.mipmask&1<<t))if(e.target===Le)n.texImage2D(Le,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);else for(var r=0;r<6;++r)n.texImage2D(We+r,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);V(e.texInfo,e.target)})}}}nn[qe]=2,nn[$e]=2,nn[Ye]=2,nn[tt]=4,nn[ot]=.5,nn[at]=.5,nn[st]=1,nn[ct]=1,nn[ut]=.5,nn[ft]=1,nn[lt]=1,nn[pt]=.5,nn[ht]=.25,nn[dt]=.5,nn[mt]=.25,nn[vt]=.5;var dn=36161,mn=32854,vn=[];function gn(e,t,n){return vn[e]*t*n}vn[mn]=2,vn[32855]=2,vn[36194]=2,vn[33189]=2,vn[36168]=1,vn[34041]=4,vn[35907]=4,vn[34836]=16,vn[34842]=8,vn[34843]=6;var bn=function(e,t,n,r,i){var o={rgba4:mn,rgb565:36194,"rgb5 a1":32855,depth:33189,stencil:36168,"depth stencil":34041};t.ext_srgb&&(o.srgba=35907),t.ext_color_buffer_half_float&&(o.rgba16f=34842,o.rgb16f=34843),t.webgl_color_buffer_float&&(o.rgba32f=34836);var a=[];Object.keys(o).forEach(function(e){var t=o[e];a[t]=e});var s=0,c={};function u(e){this.id=s++,this.refCount=1,this.renderbuffer=e,this.format=mn,this.width=0,this.height=0,i.profile&&(this.stats={size:0})}function f(t){var n=t.renderbuffer;T(n,"must not double destroy renderbuffer"),e.bindRenderbuffer(dn,null),e.deleteRenderbuffer(n),t.renderbuffer=null,t.refCount=0,delete c[t.id],r.renderbufferCount--}return u.prototype.decRef=function(){--this.refCount<=0&&f(this)},i.profile&&(r.getTotalRenderbufferSize=function(){var e=0;return Object.keys(c).forEach(function(t){e+=c[t].stats.size}),e}),{create:function(t,s){var f=new u(e.createRenderbuffer());function l(t,r){var s=0,c=0,u=mn;if("object"==typeof t&&t){var p=t;if("shape"in p){var h=p.shape;T(Array.isArray(h)&&h.length>=2,"invalid renderbuffer shape"),s=0|h[0],c=0|h[1]}else"radius"in p&&(s=c=0|p.radius),"width"in p&&(s=0|p.width),"height"in p&&(c=0|p.height);"format"in p&&(T.parameter(p.format,o,"invalid renderbuffer format"),u=o[p.format])}else"number"==typeof t?(s=0|t,c="number"==typeof r?0|r:s):t?T.raise("invalid arguments to renderbuffer constructor"):s=c=1;if(T(s>0&&c>0&&s<=n.maxRenderbufferSize&&c<=n.maxRenderbufferSize,"invalid renderbuffer size"),s!==f.width||c!==f.height||u!==f.format)return l.width=f.width=s,l.height=f.height=c,f.format=u,e.bindRenderbuffer(dn,f.renderbuffer),e.renderbufferStorage(dn,u,s,c),T(0===e.getError(),"invalid render buffer format"),i.profile&&(f.stats.size=gn(f.format,f.width,f.height)),l.format=a[f.format],l}return c[f.id]=f,r.renderbufferCount++,l(t,s),l.resize=function(t,r){var o=0|t,a=0|r||o;return o===f.width&&a===f.height?l:(T(o>0&&a>0&&o<=n.maxRenderbufferSize&&a<=n.maxRenderbufferSize,"invalid renderbuffer size"),l.width=f.width=o,l.height=f.height=a,e.bindRenderbuffer(dn,f.renderbuffer),e.renderbufferStorage(dn,f.format,o,a),T(0===e.getError(),"invalid render buffer format"),i.profile&&(f.stats.size=gn(f.format,f.width,f.height)),l)},l._reglType="renderbuffer",l._renderbuffer=f,i.profile&&(l.stats=f.stats),l.destroy=function(){f.decRef()},l},clear:function(){re(c).forEach(f)},restore:function(){re(c).forEach(function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(dn,t.renderbuffer),e.renderbufferStorage(dn,t.format,t.width,t.height)}),e.bindRenderbuffer(dn,null)}}},yn=36160,xn=36161,wn=3553,_n=34069,Cn=36064,An=36096,jn=36128,Sn=33306,kn=36053,En=6402,On=[6407,6408],Mn=[];Mn[6408]=4,Mn[6407]=3;var Pn=[];Pn[5121]=1,Pn[5126]=4,Pn[36193]=2;var Tn=33189,Dn=36168,zn=34041,Fn=[32854,32855,36194,35907,34842,34843,34836],In={};In[kn]="complete",In[36054]="incomplete attachment",In[36057]="incomplete dimensions",In[36055]="incomplete, missing attachment",In[36061]="unsupported";var Bn=5126;function Rn(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=Bn,this.offset=0,this.stride=0,this.divisor=0}var Ln=35632,Hn=35633,Wn=35718,Nn=35721,Un=6408,Gn=5121,Kn=3333,Vn=5126;function qn(t,n,r,i,o,a,s){function c(c){var u;null===n.next?(T(o.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),u=Gn):(T(null!==n.next.colorAttachments[0].texture,"You cannot read from a renderbuffer"),u=n.next.colorAttachments[0].texture._texture.type,a.oes_texture_float?(T(u===Gn||u===Vn,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),u===Vn&&T(s.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):T(u===Gn,"Reading from a framebuffer is only allowed for the type 'uint8'"));var f=0,l=0,p=i.framebufferWidth,h=i.framebufferHeight,d=null;e(c)?d=c:c&&(T.type(c,"object","invalid arguments to regl.read()"),f=0|c.x,l=0|c.y,T(f>=0&&f<i.framebufferWidth,"invalid x offset for regl.read"),T(l>=0&&l<i.framebufferHeight,"invalid y offset for regl.read"),p=0|(c.width||i.framebufferWidth-f),h=0|(c.height||i.framebufferHeight-l),d=c.data||null),d&&(u===Gn?T(d instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):u===Vn&&T(d instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),T(p>0&&p+f<=i.framebufferWidth,"invalid width for read pixels"),T(h>0&&h+l<=i.framebufferHeight,"invalid height for read pixels"),r();var m=p*h*4;return d||(u===Gn?d=new Uint8Array(m):u===Vn&&(d=d||new Float32Array(m))),T.isTypedArray(d,"data buffer for regl.read() must be a typedarray"),T(d.byteLength>=m,"data buffer for regl.read() too small"),t.pixelStorei(Kn,4),t.readPixels(f,l,p,h,Un,u,d),d}return function(e){return e&&"framebuffer"in e?function(e){var t;return n.setFBO({framebuffer:e.framebuffer},function(){t=c(e)}),t}(e):c(e)}}function $n(e){return Array.prototype.slice.call(e)}function Yn(e){return $n(e).join("")}var Zn="xyzw".split(""),Xn=5121,Qn=1,Jn=2,er=0,tr=1,nr=2,rr=3,ir=4,or="dither",ar="blend.enable",sr="blend.color",cr="blend.equation",ur="blend.func",fr="depth.enable",lr="depth.func",pr="depth.range",hr="depth.mask",dr="colorMask",mr="cull.enable",vr="cull.face",gr="frontFace",br="lineWidth",yr="polygonOffset.enable",xr="polygonOffset.offset",wr="sample.alpha",_r="sample.enable",Cr="sample.coverage",Ar="stencil.enable",jr="stencil.mask",Sr="stencil.func",kr="stencil.opFront",Er="stencil.opBack",Or="scissor.enable",Mr="scissor.box",Pr="viewport",Tr="profile",Dr="framebuffer",zr="vert",Fr="frag",Ir="elements",Br="primitive",Rr="count",Lr="offset",Hr="instances",Wr=Dr+"Width",Nr=Dr+"Height",Ur=Pr+"Width",Gr=Pr+"Height",Kr="drawingBufferWidth",Vr="drawingBufferHeight",qr=[ur,cr,Sr,kr,Er,Cr,Pr,Mr,xr],$r=34962,Yr=34963,Zr=3553,Xr=34067,Qr=2884,Jr=3042,ei=3024,ti=2960,ni=2929,ri=3089,ii=32823,oi=32926,ai=32928,si=5126,ci=35664,ui=35665,fi=35666,li=5124,pi=35667,hi=35668,di=35669,mi=35670,vi=35671,gi=35672,bi=35673,yi=35674,xi=35675,wi=35676,_i=35678,Ci=35680,Ai=4,ji=1028,Si=1029,ki=2304,Ei=2305,Oi=32775,Mi=32776,Pi=519,Ti=7680,Di=0,zi=1,Fi=32774,Ii=513,Bi=36160,Ri=36064,Li={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Hi=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],Wi={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},Ni={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},Ui={frag:35632,vert:35633},Gi={cw:ki,ccw:Ei};function Ki(t){return Array.isArray(t)||e(t)||ne(t)}function Vi(e){return e.sort(function(e,t){return e===Pr?-1:t===Pr?1:e<t?-1:1})}function qi(e,t,n,r){this.thisDep=e,this.contextDep=t,this.propDep=n,this.append=r}function $i(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function Yi(e){return new qi(!1,!1,!1,e)}function Zi(e,t){var n=e.type;if(n===er){var r=e.data.length;return new qi(!0,r>=1,r>=2,t)}if(n===ir){var i=e.data;return new qi(i.thisDep,i.contextDep,i.propDep,t)}return new qi(n===rr,n===nr,n===tr,t)}var Xi=new qi(!1,!1,!1,function(){});function Qi(e,n,r,i,o,a,s,c,u,f,l,p,h,d,m){var v=f.Record,g={add:32774,subtract:32778,"reverse subtract":32779};r.ext_blend_minmax&&(g.min=Oi,g.max=Mi);var b=r.angle_instanced_arrays,y=r.webgl_draw_buffers,x={dirty:!0,profile:m.profile},w={},_=[],C={},A={};function j(e){return e.replace(".","_")}function S(e,t,n){var r=j(e);_.push(e),w[r]=x[r]=!!n,C[r]=t}function k(e,t,n){var r=j(e);_.push(e),Array.isArray(n)?(x[r]=n.slice(),w[r]=n.slice()):x[r]=w[r]=n,A[r]=t}S(or,ei),S(ar,Jr),k(sr,"blendColor",[0,0,0,0]),k(cr,"blendEquationSeparate",[Fi,Fi]),k(ur,"blendFuncSeparate",[zi,Di,zi,Di]),S(fr,ni,!0),k(lr,"depthFunc",Ii),k(pr,"depthRange",[0,1]),k(hr,"depthMask",!0),k(dr,dr,[!0,!0,!0,!0]),S(mr,Qr),k(vr,"cullFace",Si),k(gr,gr,Ei),k(br,br,1),S(yr,ii),k(xr,"polygonOffset",[0,0]),S(wr,oi),S(_r,ai),k(Cr,"sampleCoverage",[1,!1]),S(Ar,ti),k(jr,"stencilMask",-1),k(Sr,"stencilFunc",[Pi,0,-1]),k(kr,"stencilOpSeparate",[ji,Ti,Ti,Ti]),k(Er,"stencilOpSeparate",[Si,Ti,Ti,Ti]),S(Or,ri),k(Mr,"scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),k(Pr,Pr,[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var E={gl:e,context:h,strings:n,next:w,current:x,draw:p,elements:a,buffer:o,shader:l,attributes:f.state,uniforms:u,framebuffer:c,extensions:r,timer:d,isBufferArgs:Ki},O={primTypes:ye,compareFuncs:Wi,blendFuncs:Li,blendEquations:g,stencilOps:Ni,glTypes:se,orientationType:Gi};T.optional(function(){E.isArrayLike=Ie}),y&&(O.backBuffer=[Si],O.drawBuffer=G(i.maxDrawbuffers,function(e){return 0===e?[0]:G(e,function(e){return Ri+e})}));var M=0;function P(){var e=function(){var e=0,n=[],r=[];function i(){var n=[],r=[];return t(function(){n.push.apply(n,$n(arguments))},{def:function(){var t="v"+e++;return r.push(t),arguments.length>0&&(n.push(t,"="),n.push.apply(n,$n(arguments)),n.push(";")),t},toString:function(){return Yn([r.length>0?"var "+r+";":"",Yn(n)])}})}function o(){var e=i(),n=i(),r=e.toString,o=n.toString;function a(t,r){n(t,r,"=",e.def(t,r),";")}return t(function(){e.apply(e,$n(arguments))},{def:e.def,entry:e,exit:n,save:a,set:function(t,n,r){a(t,n),e(t,n,"=",r,";")},toString:function(){return r()+o()}})}var a=i(),s={};return{global:a,link:function(t){for(var i=0;i<r.length;++i)if(r[i]===t)return n[i];var o="g"+e++;return n.push(o),r.push(t),o},block:i,proc:function(e,n){var r=[];function i(){var e="a"+r.length;return r.push(e),e}n=n||0;for(var a=0;a<n;++a)i();var c=o(),u=c.toString;return s[e]=t(c,{arg:i,toString:function(){return Yn(["function(",r.join(),"){",u(),"}"])}})},scope:o,cond:function(){var e=Yn(arguments),n=o(),r=o(),i=n.toString,a=r.toString;return t(n,{then:function(){return n.apply(n,$n(arguments)),this},else:function(){return r.apply(r,$n(arguments)),this},toString:function(){var t=a();return t&&(t="else{"+t+"}"),Yn(["if(",e,"){",i(),"}",t])}})},compile:function(){var e=['"use strict";',a,"return {"];Object.keys(s).forEach(function(t){e.push('"',t,'":',s[t].toString(),",")}),e.push("}");var t=Yn(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,n.concat(t)).apply(null,r)}}}(),r=e.link,i=e.global;e.id=M++,e.batchId="0";var o=r(E),a=e.shared={props:"a0"};Object.keys(E).forEach(function(e){a[e]=i.def(o,".",e)}),T.optional(function(){e.CHECK=r(T),e.commandStr=T.guessCommand(),e.command=r(e.commandStr),e.assert=function(e,t,n){e("if(!(",t,"))",this.CHECK,".commandRaise(",r(n),",",this.command,");")},O.invalidBlendCombinations=Hi});var s=e.next={},c=e.current={};Object.keys(A).forEach(function(e){Array.isArray(x[e])&&(s[e]=i.def(a.next,".",e),c[e]=i.def(a.current,".",e))});var u=e.constants={};Object.keys(O).forEach(function(e){u[e]=i.def(JSON.stringify(O[e]))}),e.invoke=function(t,n){switch(n.type){case er:var i=["this",a.context,a.props,e.batchId];return t.def(r(n.data),".call(",i.slice(0,Math.max(n.data.length+1,4)),")");case tr:return t.def(a.props,n.data);case nr:return t.def(a.context,n.data);case rr:return t.def("this",n.data);case ir:return n.data.append(e,t),n.data.ref}},e.attribCache={};var l={};return e.scopeAttrib=function(e){var t=n.id(e);if(t in l)return l[t];var i=f.scope[t];i||(i=f.scope[t]=new v);var o=l[t]=r(i);return o},e}function D(e,t,r,s,u){var f=e.static,p=e.dynamic;T.optional(function(){var e=[Dr,zr,Fr,Ir,Br,Lr,Rr,Hr,Tr].concat(_);function t(t){Object.keys(t).forEach(function(t){T.command(e.indexOf(t)>=0,'unknown parameter "'+t+'"',u.commandStr)})}t(f),t(p)});var h=function(e,t){var n=e.static,r=e.dynamic;if(Dr in n){var i=n[Dr];return i?(i=c.getFramebuffer(i),T.command(i,"invalid framebuffer object"),Yi(function(e,t){var n=e.link(i),r=e.shared;t.set(r.framebuffer,".next",n);var o=r.context;return t.set(o,"."+Wr,n+".width"),t.set(o,"."+Nr,n+".height"),n})):Yi(function(e,t){var n=e.shared;t.set(n.framebuffer,".next","null");var r=n.context;return t.set(r,"."+Wr,r+"."+Kr),t.set(r,"."+Nr,r+"."+Vr),"null"})}if(Dr in r){var o=r[Dr];return Zi(o,function(e,t){var n=e.invoke(t,o),r=e.shared,i=r.framebuffer,a=t.def(i,".getFramebuffer(",n,")");T.optional(function(){e.assert(t,"!"+n+"||"+a,"invalid framebuffer object")}),t.set(i,".next",a);var s=r.context;return t.set(s,"."+Wr,a+"?"+a+".width:"+s+"."+Kr),t.set(s,"."+Nr,a+"?"+a+".height:"+s+"."+Vr),a})}return null}(e),d=function(e,t,n){var r=e.static,i=e.dynamic;function o(e){if(e in r){var o=r[e];T.commandType(o,"object","invalid "+e,n.commandStr);var a,s,c=!0,u=0|o.x,f=0|o.y;return"width"in o?(a=0|o.width,T.command(a>=0,"invalid "+e,n.commandStr)):c=!1,"height"in o?(s=0|o.height,T.command(s>=0,"invalid "+e,n.commandStr)):c=!1,new qi(!c&&t&&t.thisDep,!c&&t&&t.contextDep,!c&&t&&t.propDep,function(e,t){var n=e.shared.context,r=a;"width"in o||(r=t.def(n,".",Wr,"-",u));var i=s;return"height"in o||(i=t.def(n,".",Nr,"-",f)),[u,f,r,i]})}if(e in i){var l=i[e],p=Zi(l,function(t,n){var r=t.invoke(n,l);T.optional(function(){t.assert(n,r+"&&typeof "+r+'==="object"',"invalid "+e)});var i=t.shared.context,o=n.def(r,".x|0"),a=n.def(r,".y|0"),s=n.def('"width" in ',r,"?",r,".width|0:","(",i,".",Wr,"-",o,")"),c=n.def('"height" in ',r,"?",r,".height|0:","(",i,".",Nr,"-",a,")");return T.optional(function(){t.assert(n,s+">=0&&"+c+">=0","invalid "+e)}),[o,a,s,c]});return t&&(p.thisDep=p.thisDep||t.thisDep,p.contextDep=p.contextDep||t.contextDep,p.propDep=p.propDep||t.propDep),p}return t?new qi(t.thisDep,t.contextDep,t.propDep,function(e,t){var n=e.shared.context;return[0,0,t.def(n,".",Wr),t.def(n,".",Nr)]}):null}var a=o(Pr);if(a){var s=a;a=new qi(a.thisDep,a.contextDep,a.propDep,function(e,t){var n=s.append(e,t),r=e.shared.context;return t.set(r,"."+Ur,n[2]),t.set(r,"."+Gr,n[3]),n})}return{viewport:a,scissor_box:o(Mr)}}(e,h,u),m=function(e,t){var n=e.static,r=e.dynamic,i=function(){if(Ir in n){var e=n[Ir];Ki(e)?e=a.getElements(a.create(e,!0)):e&&(e=a.getElements(e),T.command(e,"invalid elements",t.commandStr));var i=Yi(function(t,n){if(e){var r=t.link(e);return t.ELEMENTS=r,r}return t.ELEMENTS=null,null});return i.value=e,i}if(Ir in r){var o=r[Ir];return Zi(o,function(e,t){var n=e.shared,r=n.isBufferArgs,i=n.elements,a=e.invoke(t,o),s=t.def("null"),c=t.def(r,"(",a,")"),u=e.cond(c).then(s,"=",i,".createStream(",a,");").else(s,"=",i,".getElements(",a,");");return T.optional(function(){e.assert(u.else,"!"+a+"||"+s,"invalid elements")}),t.entry(u),t.exit(e.cond(c).then(i,".destroyStream(",s,");")),e.ELEMENTS=s,s})}return null}();function o(e,o){if(e in n){var a=0|n[e];return T.command(!o||a>=0,"invalid "+e,t.commandStr),Yi(function(e,t){return o&&(e.OFFSET=a),a})}if(e in r){var s=r[e];return Zi(s,function(t,n){var r=t.invoke(n,s);return o&&(t.OFFSET=r,T.optional(function(){t.assert(n,r+">=0","invalid "+e)})),r})}return o&&i?Yi(function(e,t){return e.OFFSET="0",0}):null}var s=o(Lr,!0);return{elements:i,primitive:function(){if(Br in n){var e=n[Br];return T.commandParameter(e,ye,"invalid primitve",t.commandStr),Yi(function(t,n){return ye[e]})}if(Br in r){var o=r[Br];return Zi(o,function(e,t){var n=e.constants.primTypes,r=e.invoke(t,o);return T.optional(function(){e.assert(t,r+" in "+n,"invalid primitive, must be one of "+Object.keys(ye))}),t.def(n,"[",r,"]")})}return i?$i(i)?i.value?Yi(function(e,t){return t.def(e.ELEMENTS,".primType")}):Yi(function(){return Ai}):new qi(i.thisDep,i.contextDep,i.propDep,function(e,t){var n=e.ELEMENTS;return t.def(n,"?",n,".primType:",Ai)}):null}(),count:function(){if(Rr in n){var e=0|n[Rr];return T.command("number"==typeof e&&e>=0,"invalid vertex count",t.commandStr),Yi(function(){return e})}if(Rr in r){var o=r[Rr];return Zi(o,function(e,t){var n=e.invoke(t,o);return T.optional(function(){e.assert(t,"typeof "+n+'==="number"&&'+n+">=0&&"+n+"===("+n+"|0)","invalid vertex count")}),n})}if(i){if($i(i)){if(i)return s?new qi(s.thisDep,s.contextDep,s.propDep,function(e,t){var n=t.def(e.ELEMENTS,".vertCount-",e.OFFSET);return T.optional(function(){e.assert(t,n+">=0","invalid vertex offset/element buffer too small")}),n}):Yi(function(e,t){return t.def(e.ELEMENTS,".vertCount")});var a=Yi(function(){return-1});return T.optional(function(){a.MISSING=!0}),a}var c=new qi(i.thisDep||s.thisDep,i.contextDep||s.contextDep,i.propDep||s.propDep,function(e,t){var n=e.ELEMENTS;return e.OFFSET?t.def(n,"?",n,".vertCount-",e.OFFSET,":-1"):t.def(n,"?",n,".vertCount:-1")});return T.optional(function(){c.DYNAMIC=!0}),c}return null}(),instances:o(Hr,!1),offset:s}}(e,u),y=function(e,t){var n=e.static,r=e.dynamic,o={};return _.forEach(function(e){var a=j(e);function s(t,i){if(e in n){var s=t(n[e]);o[a]=Yi(function(){return s})}else if(e in r){var c=r[e];o[a]=Zi(c,function(e,t){return i(e,t,e.invoke(t,c))})}}switch(e){case mr:case ar:case or:case Ar:case fr:case Or:case yr:case wr:case _r:case hr:return s(function(n){return T.commandType(n,"boolean",e,t.commandStr),n},function(t,n,r){return T.optional(function(){t.assert(n,"typeof "+r+'==="boolean"',"invalid flag "+e,t.commandStr)}),r});case lr:return s(function(n){return T.commandParameter(n,Wi,"invalid "+e,t.commandStr),Wi[n]},function(t,n,r){var i=t.constants.compareFuncs;return T.optional(function(){t.assert(n,r+" in "+i,"invalid "+e+", must be one of "+Object.keys(Wi))}),n.def(i,"[",r,"]")});case pr:return s(function(e){return T.command(Ie(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&e[0]<=e[1],"depth range is 2d array",t.commandStr),e},function(e,t,n){return T.optional(function(){e.assert(t,e.shared.isArrayLike+"("+n+")&&"+n+".length===2&&typeof "+n+'[0]==="number"&&typeof '+n+'[1]==="number"&&'+n+"[0]<="+n+"[1]","depth range must be a 2d array")}),[t.def("+",n,"[0]"),t.def("+",n,"[1]")]});case ur:return s(function(e){T.commandType(e,"object","blend.func",t.commandStr);var n="srcRGB"in e?e.srcRGB:e.src,r="srcAlpha"in e?e.srcAlpha:e.src,i="dstRGB"in e?e.dstRGB:e.dst,o="dstAlpha"in e?e.dstAlpha:e.dst;return T.commandParameter(n,Li,a+".srcRGB",t.commandStr),T.commandParameter(r,Li,a+".srcAlpha",t.commandStr),T.commandParameter(i,Li,a+".dstRGB",t.commandStr),T.commandParameter(o,Li,a+".dstAlpha",t.commandStr),T.command(-1===Hi.indexOf(n+", "+i),"unallowed blending combination (srcRGB, dstRGB) = ("+n+", "+i+")",t.commandStr),[Li[n],Li[i],Li[r],Li[o]]},function(t,n,r){var i=t.constants.blendFuncs;function o(o,a){var s=n.def('"',o,a,'" in ',r,"?",r,".",o,a,":",r,".",o);return T.optional(function(){t.assert(n,s+" in "+i,"invalid "+e+"."+o+a+", must be one of "+Object.keys(Li))}),s}T.optional(function(){t.assert(n,r+"&&typeof "+r+'==="object"',"invalid blend func, must be an object")});var a=o("src","RGB"),s=o("dst","RGB");T.optional(function(){var e=t.constants.invalidBlendCombinations;t.assert(n,e+".indexOf("+a+'+", "+'+s+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")});var c=n.def(i,"[",a,"]"),u=n.def(i,"[",o("src","Alpha"),"]");return[c,n.def(i,"[",s,"]"),u,n.def(i,"[",o("dst","Alpha"),"]")]});case cr:return s(function(n){return"string"==typeof n?(T.commandParameter(n,g,"invalid "+e,t.commandStr),[g[n],g[n]]):"object"==typeof n?(T.commandParameter(n.rgb,g,e+".rgb",t.commandStr),T.commandParameter(n.alpha,g,e+".alpha",t.commandStr),[g[n.rgb],g[n.alpha]]):void T.commandRaise("invalid blend.equation",t.commandStr)},function(t,n,r){var i=t.constants.blendEquations,o=n.def(),a=n.def(),s=t.cond("typeof ",r,'==="string"');return T.optional(function(){function n(e,n,r){t.assert(e,r+" in "+i,"invalid "+n+", must be one of "+Object.keys(g))}n(s.then,e,r),t.assert(s.else,r+"&&typeof "+r+'==="object"',"invalid "+e),n(s.else,e+".rgb",r+".rgb"),n(s.else,e+".alpha",r+".alpha")}),s.then(o,"=",a,"=",i,"[",r,"];"),s.else(o,"=",i,"[",r,".rgb];",a,"=",i,"[",r,".alpha];"),n(s),[o,a]});case sr:return s(function(e){return T.command(Ie(e)&&4===e.length,"blend.color must be a 4d array",t.commandStr),G(4,function(t){return+e[t]})},function(e,t,n){return T.optional(function(){e.assert(t,e.shared.isArrayLike+"("+n+")&&"+n+".length===4","blend.color must be a 4d array")}),G(4,function(e){return t.def("+",n,"[",e,"]")})});case jr:return s(function(e){return T.commandType(e,"number",a,t.commandStr),0|e},function(e,t,n){return T.optional(function(){e.assert(t,"typeof "+n+'==="number"',"invalid stencil.mask")}),t.def(n,"|0")});case Sr:return s(function(n){T.commandType(n,"object",a,t.commandStr);var r=n.cmp||"keep",i=n.ref||0,o="mask"in n?n.mask:-1;return T.commandParameter(r,Wi,e+".cmp",t.commandStr),T.commandType(i,"number",e+".ref",t.commandStr),T.commandType(o,"number",e+".mask",t.commandStr),[Wi[r],i,o]},function(e,t,n){var r=e.constants.compareFuncs;return T.optional(function(){function i(){e.assert(t,Array.prototype.join.call(arguments,""),"invalid stencil.func")}i(n+"&&typeof ",n,'==="object"'),i('!("cmp" in ',n,")||(",n,".cmp in ",r,")")}),[t.def('"cmp" in ',n,"?",r,"[",n,".cmp]",":",Ti),t.def(n,".ref|0"),t.def('"mask" in ',n,"?",n,".mask|0:-1")]});case kr:case Er:return s(function(n){T.commandType(n,"object",a,t.commandStr);var r=n.fail||"keep",i=n.zfail||"keep",o=n.zpass||"keep";return T.commandParameter(r,Ni,e+".fail",t.commandStr),T.commandParameter(i,Ni,e+".zfail",t.commandStr),T.commandParameter(o,Ni,e+".zpass",t.commandStr),[e===Er?Si:ji,Ni[r],Ni[i],Ni[o]]},function(t,n,r){var i=t.constants.stencilOps;function o(o){return T.optional(function(){t.assert(n,'!("'+o+'" in '+r+")||("+r+"."+o+" in "+i+")","invalid "+e+"."+o+", must be one of "+Object.keys(Ni))}),n.def('"',o,'" in ',r,"?",i,"[",r,".",o,"]:",Ti)}return T.optional(function(){t.assert(n,r+"&&typeof "+r+'==="object"',"invalid "+e)}),[e===Er?Si:ji,o("fail"),o("zfail"),o("zpass")]});case xr:return s(function(e){T.commandType(e,"object",a,t.commandStr);var n=0|e.factor,r=0|e.units;return T.commandType(n,"number",a+".factor",t.commandStr),T.commandType(r,"number",a+".units",t.commandStr),[n,r]},function(t,n,r){return T.optional(function(){t.assert(n,r+"&&typeof "+r+'==="object"',"invalid "+e)}),[n.def(r,".factor|0"),n.def(r,".units|0")]});case vr:return s(function(e){var n=0;return"front"===e?n=ji:"back"===e&&(n=Si),T.command(!!n,a,t.commandStr),n},function(e,t,n){return T.optional(function(){e.assert(t,n+'==="front"||'+n+'==="back"',"invalid cull.face")}),t.def(n,'==="front"?',ji,":",Si)});case br:return s(function(e){return T.command("number"==typeof e&&e>=i.lineWidthDims[0]&&e<=i.lineWidthDims[1],"invalid line width, must be a positive number between "+i.lineWidthDims[0]+" and "+i.lineWidthDims[1],t.commandStr),e},function(e,t,n){return T.optional(function(){e.assert(t,"typeof "+n+'==="number"&&'+n+">="+i.lineWidthDims[0]+"&&"+n+"<="+i.lineWidthDims[1],"invalid line width")}),n});case gr:return s(function(e){return T.commandParameter(e,Gi,a,t.commandStr),Gi[e]},function(e,t,n){return T.optional(function(){e.assert(t,n+'==="cw"||'+n+'==="ccw"',"invalid frontFace, must be one of cw,ccw")}),t.def(n+'==="cw"?'+ki+":"+Ei)});case dr:return s(function(e){return T.command(Ie(e)&&4===e.length,"color.mask must be length 4 array",t.commandStr),e.map(function(e){return!!e})},function(e,t,n){return T.optional(function(){e.assert(t,e.shared.isArrayLike+"("+n+")&&"+n+".length===4","invalid color.mask")}),G(4,function(e){return"!!"+n+"["+e+"]"})});case Cr:return s(function(e){T.command("object"==typeof e&&e,a,t.commandStr);var n="value"in e?e.value:1,r=!!e.invert;return T.command("number"==typeof n&&n>=0&&n<=1,"sample.coverage.value must be a number between 0 and 1",t.commandStr),[n,r]},function(e,t,n){return T.optional(function(){e.assert(t,n+"&&typeof "+n+'==="object"',"invalid sample.coverage")}),[t.def('"value" in ',n,"?+",n,".value:1"),t.def("!!",n,".invert")]})}}),o}(e,u),x=function(e){var t=e.static,r=e.dynamic;function i(e){if(e in t){var i=n.id(t[e]);T.optional(function(){l.shader(Ui[e],i,T.guessCommand())});var o=Yi(function(){return i});return o.id=i,o}if(e in r){var a=r[e];return Zi(a,function(t,n){var r=t.invoke(n,a),i=n.def(t.shared.strings,".id(",r,")");return T.optional(function(){n(t.shared.shader,".shader(",Ui[e],",",i,",",t.command,");")}),i})}return null}var o,a=i(Fr),s=i(zr),c=null;return $i(a)&&$i(s)?(c=l.program(s.id,a.id),o=Yi(function(e,t){return e.link(c)})):o=new qi(a&&a.thisDep||s&&s.thisDep,a&&a.contextDep||s&&s.contextDep,a&&a.propDep||s&&s.propDep,function(e,t){var n,r,i=e.shared.shader;n=a?a.append(e,t):t.def(i,".",Fr),r=s?s.append(e,t):t.def(i,".",zr);var o=i+".program("+r+","+n;return T.optional(function(){o+=","+e.command}),t.def(o+")")}),{frag:a,vert:s,progVar:o,program:c}}(e);function w(e){var t=d[e];t&&(y[e]=t)}w(Pr),w(j(Mr));var C=Object.keys(y).length>0,A={framebuffer:h,draw:m,shader:x,state:y,dirty:C};return A.profile=function(e){var t,n=e.static,r=e.dynamic;if(Tr in n){var i=!!n[Tr];(t=Yi(function(e,t){return i})).enable=i}else if(Tr in r){var o=r[Tr];t=Zi(o,function(e,t){return e.invoke(t,o)})}return t}(e),A.uniforms=function(e,t){var n=e.static,r=e.dynamic,i={};return Object.keys(n).forEach(function(e){var r,o=n[e];if("number"==typeof o||"boolean"==typeof o)r=Yi(function(){return o});else if("function"==typeof o){var a=o._reglType;"texture2d"===a||"textureCube"===a?r=Yi(function(e){return e.link(o)}):"framebuffer"===a||"framebufferCube"===a?(T.command(o.color.length>0,'missing color attachment for framebuffer sent to uniform "'+e+'"',t.commandStr),r=Yi(function(e){return e.link(o.color[0])})):T.commandRaise('invalid data for uniform "'+e+'"',t.commandStr)}else Ie(o)?r=Yi(function(t){return t.global.def("[",G(o.length,function(n){return T.command("number"==typeof o[n]||"boolean"==typeof o[n],"invalid uniform "+e,t.commandStr),o[n]}),"]")}):T.commandRaise('invalid or missing data for uniform "'+e+'"',t.commandStr);r.value=o,i[e]=r}),Object.keys(r).forEach(function(e){var t=r[e];i[e]=Zi(t,function(e,n){return e.invoke(n,t)})}),i}(r,u),A.attributes=function(e,t){var r=e.static,i=e.dynamic,a={};return Object.keys(r).forEach(function(e){var i=r[e],s=n.id(e),c=new v;if(Ki(i))c.state=Qn,c.buffer=o.getBuffer(o.create(i,$r,!1,!0)),c.type=0;else{var u=o.getBuffer(i);if(u)c.state=Qn,c.buffer=u,c.type=0;else if(T.command("object"==typeof i&&i,"invalid data for attribute "+e,t.commandStr),"constant"in i){var f=i.constant;c.buffer="null",c.state=Jn,"number"==typeof f?c.x=f:(T.command(Ie(f)&&f.length>0&&f.length<=4,"invalid constant for attribute "+e,t.commandStr),Zn.forEach(function(e,t){t<f.length&&(c[e]=f[t])}))}else{u=Ki(i.buffer)?o.getBuffer(o.create(i.buffer,$r,!1,!0)):o.getBuffer(i.buffer),T.command(!!u,'missing buffer for attribute "'+e+'"',t.commandStr);var l=0|i.offset;T.command(l>=0,'invalid offset for attribute "'+e+'"',t.commandStr);var p=0|i.stride;T.command(p>=0&&p<256,'invalid stride for attribute "'+e+'", must be integer betweeen [0, 255]',t.commandStr);var h=0|i.size;T.command(!("size"in i)||h>0&&h<=4,'invalid size for attribute "'+e+'", must be 1,2,3,4',t.commandStr);var d=!!i.normalized,m=0;"type"in i&&(T.commandParameter(i.type,se,"invalid type for attribute "+e,t.commandStr),m=se[i.type]);var g=0|i.divisor;"divisor"in i&&(T.command(0===g||b,'cannot specify divisor for attribute "'+e+'", instancing not supported',t.commandStr),T.command(g>=0,'invalid divisor for attribute "'+e+'"',t.commandStr)),T.optional(function(){var n=t.commandStr,r=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(i).forEach(function(t){T.command(r.indexOf(t)>=0,'unknown parameter "'+t+'" for attribute pointer "'+e+'" (valid parameters are '+r+")",n)})}),c.buffer=u,c.state=Qn,c.size=h,c.normalized=d,c.type=m||u.dtype,c.offset=l,c.stride=p,c.divisor=g}}a[e]=Yi(function(e,t){var n=e.attribCache;if(s in n)return n[s];var r={isStream:!1};return Object.keys(c).forEach(function(e){r[e]=c[e]}),c.buffer&&(r.buffer=e.link(c.buffer),r.type=r.type||r.buffer+".dtype"),n[s]=r,r})}),Object.keys(i).forEach(function(e){var t=i[e];a[e]=Zi(t,function(n,r){var i=n.invoke(r,t),o=n.shared,a=o.isBufferArgs,s=o.buffer;T.optional(function(){n.assert(r,i+"&&(typeof "+i+'==="object"||typeof '+i+'==="function")&&('+a+"("+i+")||"+s+".getBuffer("+i+")||"+s+".getBuffer("+i+".buffer)||"+a+"("+i+'.buffer)||("constant" in '+i+"&&(typeof "+i+'.constant==="number"||'+o.isArrayLike+"("+i+".constant))))",'invalid dynamic attribute "'+e+'"')});var c={isStream:r.def(!1)},u=new v;u.state=Qn,Object.keys(u).forEach(function(e){c[e]=r.def(""+u[e])});var f=c.buffer,l=c.type;function p(e){r(c[e],"=",i,".",e,"|0;")}return r("if(",a,"(",i,")){",c.isStream,"=true;",f,"=",s,".createStream(",$r,",",i,");",l,"=",f,".dtype;","}else{",f,"=",s,".getBuffer(",i,");","if(",f,"){",l,"=",f,".dtype;",'}else if("constant" in ',i,"){",c.state,"=",Jn,";","if(typeof "+i+'.constant === "number"){',c[Zn[0]],"=",i,".constant;",Zn.slice(1).map(function(e){return c[e]}).join("="),"=0;","}else{",Zn.map(function(e,t){return c[e]+"="+i+".constant.length>"+t+"?"+i+".constant["+t+"]:0;"}).join(""),"}}else{","if(",a,"(",i,".buffer)){",f,"=",s,".createStream(",$r,",",i,".buffer);","}else{",f,"=",s,".getBuffer(",i,".buffer);","}",l,'="type" in ',i,"?",o.glTypes,"[",i,".type]:",f,".dtype;",c.normalized,"=!!",i,".normalized;"),p("size"),p("offset"),p("stride"),p("divisor"),r("}}"),r.exit("if(",c.isStream,"){",s,".destroyStream(",f,");","}"),c})}),a}(t,u),A.context=function(e){var t=e.static,n=e.dynamic,r={};return Object.keys(t).forEach(function(e){var n=t[e];r[e]=Yi(function(e,t){return"number"==typeof n||"boolean"==typeof n?""+n:e.link(n)})}),Object.keys(n).forEach(function(e){var t=n[e];r[e]=Zi(t,function(e,n){return e.invoke(n,t)})}),r}(s),A}function z(e,t,n){var r=e.shared,i=r.context,o=e.scope();Object.keys(n).forEach(function(r){t.save(i,"."+r);var a=n[r];o(i,".",r,"=",a.append(e,t),";")}),t(o)}function F(e,t,n,r){var i,o=e.shared,a=o.gl,s=o.framebuffer;y&&(i=t.def(o.extensions,".webgl_draw_buffers"));var c,u=e.constants,f=u.drawBuffer,l=u.backBuffer;c=n?n.append(e,t):t.def(s,".next"),r||t("if(",c,"!==",s,".cur){"),t("if(",c,"){",a,".bindFramebuffer(",Bi,",",c,".framebuffer);"),y&&t(i,".drawBuffersWEBGL(",f,"[",c,".colorAttachments.length]);"),t("}else{",a,".bindFramebuffer(",Bi,",null);"),y&&t(i,".drawBuffersWEBGL(",l,");"),t("}",s,".cur=",c,";"),r||t("}")}function I(e,t,n){var r=e.shared,i=r.gl,o=e.current,a=e.next,s=r.current,c=r.next,u=e.cond(s,".dirty");_.forEach(function(t){var r,f,l=j(t);if(!(l in n.state))if(l in a){r=a[l],f=o[l];var p=G(x[l].length,function(e){return u.def(r,"[",e,"]")});u(e.cond(p.map(function(e,t){return e+"!=="+f+"["+t+"]"}).join("||")).then(i,".",A[l],"(",p,");",p.map(function(e,t){return f+"["+t+"]="+e}).join(";"),";"))}else{r=u.def(c,".",l);var h=e.cond(r,"!==",s,".",l);u(h),l in C?h(e.cond(r).then(i,".enable(",C[l],");").else(i,".disable(",C[l],");"),s,".",l,"=",r,";"):h(i,".",A[l],"(",r,");",s,".",l,"=",r,";")}}),0===Object.keys(n.state).length&&u(s,".dirty=false;"),t(u)}function B(e,t,n,r){var i=e.shared,o=e.current,a=i.current,s=i.gl;Vi(Object.keys(n)).forEach(function(i){var c=n[i];if(!r||r(c)){var u=c.append(e,t);if(C[i]){var f=C[i];$i(c)?t(s,u?".enable(":".disable(",f,");"):t(e.cond(u).then(s,".enable(",f,");").else(s,".disable(",f,");")),t(a,".",i,"=",u,";")}else if(Ie(u)){var l=o[i];t(s,".",A[i],"(",u,");",u.map(function(e,t){return l+"["+t+"]="+e}).join(";"),";")}else t(s,".",A[i],"(",u,");",a,".",i,"=",u,";")}})}function L(e,t){b&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function H(e,t,n,r,i){var o,a,s,c=e.shared,u=e.stats,f=c.current,l=c.timer,p=n.profile;function h(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function m(e){o=t.def(),e(o,"=",h(),";"),"string"==typeof i?e(u,".count+=",i,";"):e(u,".count++;"),d&&(r?(a=t.def(),e(a,"=",l,".getNumPendingQueries();")):e(l,".beginQuery(",u,");"))}function v(e){e(u,".cpuTime+=",h(),"-",o,";"),d&&(r?e(l,".pushScopeStats(",a,",",l,".getNumPendingQueries(),",u,");"):e(l,".endQuery();"))}function g(e){var n=t.def(f,".profile");t(f,".profile=",e,";"),t.exit(f,".profile=",n,";")}if(p){if($i(p))return void(p.enable?(m(t),v(t.exit),g("true")):g("false"));g(s=p.append(e,t))}else s=t.def(f,".profile");var b=e.block();m(b),t("if(",s,"){",b,"}");var y=e.block();v(y),t.exit("if(",s,"){",y,"}")}function W(e,t,n,r,i){var o=e.shared;r.forEach(function(r){var a,s=r.name,c=n.attributes[s];if(c){if(!i(c))return;a=c.append(e,t)}else{if(!i(Xi))return;var u=e.scopeAttrib(s);T.optional(function(){e.assert(t,u+".state","missing attribute "+s)}),a={},Object.keys(new v).forEach(function(e){a[e]=t.def(u,".",e)})}!function(n,r,i){var a=o.gl,s=t.def(n,".location"),c=t.def(o.attributes,"[",s,"]"),u=i.state,f=i.buffer,l=[i.x,i.y,i.z,i.w],p=["buffer","normalized","offset","stride"];function h(){t("if(!",c,".buffer){",a,".enableVertexAttribArray(",s,");}");var n,o=i.type;if(n=i.size?t.def(i.size,"||",r):r,t("if(",c,".type!==",o,"||",c,".size!==",n,"||",p.map(function(e){return c+"."+e+"!=="+i[e]}).join("||"),"){",a,".bindBuffer(",$r,",",f,".buffer);",a,".vertexAttribPointer(",[s,n,o,i.normalized,i.stride,i.offset],");",c,".type=",o,";",c,".size=",n,";",p.map(function(e){return c+"."+e+"="+i[e]+";"}).join(""),"}"),b){var u=i.divisor;t("if(",c,".divisor!==",u,"){",e.instancing,".vertexAttribDivisorANGLE(",[s,u],");",c,".divisor=",u,";}")}}function d(){t("if(",c,".buffer){",a,".disableVertexAttribArray(",s,");","}if(",Zn.map(function(e,t){return c+"."+e+"!=="+l[t]}).join("||"),"){",a,".vertexAttrib4f(",s,",",l,");",Zn.map(function(e,t){return c+"."+e+"="+l[t]+";"}).join(""),"}")}u===Qn?h():u===Jn?d():(t("if(",u,"===",Qn,"){"),h(),t("}else{"),d(),t("}"))}(e.link(r),function(e){switch(e){case ci:case pi:case vi:return 2;case ui:case hi:case gi:return 3;case fi:case di:case bi:return 4;default:return 1}}(r.info.type),a)})}function N(e,t,r,i,o){for(var a,s=e.shared,c=s.gl,u=0;u<i.length;++u){var f,l=i[u],p=l.name,h=l.info.type,d=r.uniforms[p],m=e.link(l),v=m+".location";if(d){if(!o(d))continue;if($i(d)){var g=d.value;if(T.command(null!=g,'missing uniform "'+p+'"',e.commandStr),h===_i||h===Ci){T.command("function"==typeof g&&(h===_i&&("texture2d"===g._reglType||"framebuffer"===g._reglType)||h===Ci&&("textureCube"===g._reglType||"framebufferCube"===g._reglType)),"invalid texture for uniform "+p,e.commandStr);var b=e.link(g._texture||g.color[0]._texture);t(c,".uniform1i(",v,",",b+".bind());"),t.exit(b,".unbind();")}else if(h===yi||h===xi||h===wi){T.optional(function(){T.command(Ie(g),"invalid matrix for uniform "+p,e.commandStr),T.command(h===yi&&4===g.length||h===xi&&9===g.length||h===wi&&16===g.length,"invalid length for matrix uniform "+p,e.commandStr)});var y=e.global.def("new Float32Array(["+Array.prototype.slice.call(g)+"])"),x=2;h===xi?x=3:h===wi&&(x=4),t(c,".uniformMatrix",x,"fv(",v,",false,",y,");")}else{switch(h){case si:T.commandType(g,"number","uniform "+p,e.commandStr),a="1f";break;case ci:T.command(Ie(g)&&2===g.length,"uniform "+p,e.commandStr),a="2f";break;case ui:T.command(Ie(g)&&3===g.length,"uniform "+p,e.commandStr),a="3f";break;case fi:T.command(Ie(g)&&4===g.length,"uniform "+p,e.commandStr),a="4f";break;case mi:T.commandType(g,"boolean","uniform "+p,e.commandStr),a="1i";break;case li:T.commandType(g,"number","uniform "+p,e.commandStr),a="1i";break;case vi:case pi:T.command(Ie(g)&&2===g.length,"uniform "+p,e.commandStr),a="2i";break;case gi:case hi:T.command(Ie(g)&&3===g.length,"uniform "+p,e.commandStr),a="3i";break;case bi:case di:T.command(Ie(g)&&4===g.length,"uniform "+p,e.commandStr),a="4i"}t(c,".uniform",a,"(",v,",",Ie(g)?Array.prototype.slice.call(g):g,");")}continue}f=d.append(e,t)}else{if(!o(Xi))continue;f=t.def(s.uniforms,"[",n.id(p),"]")}h===_i?t("if(",f,"&&",f,'._reglType==="framebuffer"){',f,"=",f,".color[0];","}"):h===Ci&&t("if(",f,"&&",f,'._reglType==="framebufferCube"){',f,"=",f,".color[0];","}"),T.optional(function(){function n(n,r){e.assert(t,n,'bad data or missing for uniform "'+p+'".  '+r)}function r(e){n("typeof "+f+'==="'+e+'"',"invalid type, expected "+e)}function i(t,r){n(s.isArrayLike+"("+f+")&&"+f+".length==="+t,"invalid vector, should have length "+t,e.commandStr)}function o(t){n("typeof "+f+'==="function"&&'+f+'._reglType==="texture'+(t===Zr?"2d":"Cube")+'"',"invalid texture type",e.commandStr)}switch(h){case li:r("number");break;case pi:i(2);break;case hi:i(3);break;case di:i(4);break;case si:r("number");break;case ci:i(2);break;case ui:i(3);break;case fi:i(4);break;case mi:r("boolean");break;case vi:i(2);break;case gi:i(3);break;case bi:case yi:i(4);break;case xi:i(9);break;case wi:i(16);break;case _i:o(Zr);break;case Ci:o(Xr)}});var w=1;switch(h){case _i:case Ci:var _=t.def(f,"._texture");t(c,".uniform1i(",v,",",_,".bind());"),t.exit(_,".unbind();");continue;case li:case mi:a="1i";break;case pi:case vi:a="2i",w=2;break;case hi:case gi:a="3i",w=3;break;case di:case bi:a="4i",w=4;break;case si:a="1f";break;case ci:a="2f",w=2;break;case ui:a="3f",w=3;break;case fi:a="4f",w=4;break;case yi:a="Matrix2fv";break;case xi:a="Matrix3fv";break;case wi:a="Matrix4fv"}if(t(c,".uniform",a,"(",v,","),"M"===a.charAt(0)){var C=Math.pow(h-yi+2,2),A=e.global.def("new Float32Array(",C,")");t("false,(Array.isArray(",f,")||",f," instanceof Float32Array)?",f,":(",G(C,function(e){return A+"["+e+"]="+f+"["+e+"]"}),",",A,")")}else t(w>1?G(w,function(e){return f+"["+e+"]"}):f);t(");")}}function U(e,t,n,r){var i=e.shared,o=i.gl,a=i.draw,s=r.draw,c=function(){var i,c=s.elements,u=t;return c?((c.contextDep&&r.contextDynamic||c.propDep)&&(u=n),i=c.append(e,u)):i=u.def(a,".",Ir),i&&u("if("+i+")"+o+".bindBuffer("+Yr+","+i+".buffer.buffer);"),i}();function u(i){var o=s[i];return o?o.contextDep&&r.contextDynamic||o.propDep?o.append(e,n):o.append(e,t):t.def(a,".",i)}var f,l,p=u(Br),h=u(Lr),d=function(){var i,o=s.count,c=t;return o?((o.contextDep&&r.contextDynamic||o.propDep)&&(c=n),i=o.append(e,c),T.optional(function(){o.MISSING&&e.assert(t,"false","missing vertex count"),o.DYNAMIC&&e.assert(c,i+">=0","missing vertex count")})):(i=c.def(a,".",Rr),T.optional(function(){e.assert(c,i+">=0","missing vertex count")})),i}();if("number"==typeof d){if(0===d)return}else n("if(",d,"){"),n.exit("}");b&&(f=u(Hr),l=e.instancing);var m=c+".type",v=s.elements&&$i(s.elements);function g(){function e(){n(l,".drawElementsInstancedANGLE(",[p,d,m,h+"<<(("+m+"-"+Xn+")>>1)",f],");")}function t(){n(l,".drawArraysInstancedANGLE(",[p,h,d,f],");")}c?v?e():(n("if(",c,"){"),e(),n("}else{"),t(),n("}")):t()}function y(){function e(){n(o+".drawElements("+[p,d,m,h+"<<(("+m+"-"+Xn+")>>1)"]+");")}function t(){n(o+".drawArrays("+[p,h,d]+");")}c?v?e():(n("if(",c,"){"),e(),n("}else{"),t(),n("}")):t()}b&&("number"!=typeof f||f>=0)?"string"==typeof f?(n("if(",f,">0){"),g(),n("}else if(",f,"<0){"),y(),n("}")):g():y()}function K(e,t,n,r,i){var o=P(),a=o.proc("body",i);return T.optional(function(){o.commandStr=t.commandStr,o.command=o.link(t.commandStr)}),b&&(o.instancing=a.def(o.shared.extensions,".angle_instanced_arrays")),e(o,a,n,r),o.compile().body}function V(e,t,n,r){L(e,t),W(e,t,n,r.attributes,function(){return!0}),N(e,t,n,r.uniforms,function(){return!0}),U(e,t,t,n)}function q(e,t,n,r){function i(){return!0}e.batchId="a1",L(e,t),W(e,t,n,r.attributes,i),N(e,t,n,r.uniforms,i),U(e,t,t,n)}function $(e,t,n,r){L(e,t);var i=n.contextDep,o=t.def(),a=t.def();e.shared.props=a,e.batchId=o;var s=e.scope(),c=e.scope();function u(e){return e.contextDep&&i||e.propDep}function f(e){return!u(e)}if(t(s.entry,"for(",o,"=0;",o,"<","a1",";++",o,"){",a,"=","a0","[",o,"];",c,"}",s.exit),n.needsContext&&z(e,c,n.context),n.needsFramebuffer&&F(e,c,n.framebuffer),B(e,c,n.state,u),n.profile&&u(n.profile)&&H(e,c,n,!1,!0),r)W(e,s,n,r.attributes,f),W(e,c,n,r.attributes,u),N(e,s,n,r.uniforms,f),N(e,c,n,r.uniforms,u),U(e,s,c,n);else{var l=e.global.def("{}"),p=n.shader.progVar.append(e,c),h=c.def(p,".id"),d=c.def(l,"[",h,"]");c(e.shared.gl,".useProgram(",p,".program);","if(!",d,"){",d,"=",l,"[",h,"]=",e.link(function(t){return K(q,e,n,t,2)}),"(",p,");}",d,".call(this,a0[",o,"],",o,");")}}function Y(e,t,n){var r=t.static[n];if(r&&function(e){if("object"==typeof e&&!Ie(e)){for(var t=Object.keys(e),n=0;n<t.length;++n)if(R.isDynamic(e[t[n]]))return!0;return!1}}(r)){var i=e.global,o=Object.keys(r),a=!1,s=!1,c=!1,u=e.global.def("{}");o.forEach(function(t){var n=r[t];if(R.isDynamic(n)){"function"==typeof n&&(n=r[t]=R.unbox(n));var o=Zi(n,null);a=a||o.thisDep,c=c||o.propDep,s=s||o.contextDep}else{switch(i(u,".",t,"="),typeof n){case"number":i(n);break;case"string":i('"',n,'"');break;case"object":Array.isArray(n)&&i("[",n.join(),"]");break;default:i(e.link(n))}i(";")}}),t.dynamic[n]=new R.DynamicVariable(ir,{thisDep:a,contextDep:s,propDep:c,ref:u,append:function(e,t){o.forEach(function(n){var i=r[n];if(R.isDynamic(i)){var o=e.invoke(t,i);t(u,".",n,"=",o,";")}})}}),delete t.static[n]}}return{next:w,current:x,procs:function(){var e=P(),t=e.proc("poll"),n=e.proc("refresh"),r=e.block();t(r),n(r);var o,a=e.shared,s=a.gl,c=a.next,u=a.current;r(u,".dirty=false;"),F(e,t),F(e,n,null,!0),b&&(o=e.link(b));for(var f=0;f<i.maxAttributes;++f){var l=n.def(a.attributes,"[",f,"]"),p=e.cond(l,".buffer");p.then(s,".enableVertexAttribArray(",f,");",s,".bindBuffer(",$r,",",l,".buffer.buffer);",s,".vertexAttribPointer(",f,",",l,".size,",l,".type,",l,".normalized,",l,".stride,",l,".offset);").else(s,".disableVertexAttribArray(",f,");",s,".vertexAttrib4f(",f,",",l,".x,",l,".y,",l,".z,",l,".w);",l,".buffer=null;"),n(p),b&&n(o,".vertexAttribDivisorANGLE(",f,",",l,".divisor);")}return Object.keys(C).forEach(function(i){var o=C[i],a=r.def(c,".",i),f=e.block();f("if(",a,"){",s,".enable(",o,")}else{",s,".disable(",o,")}",u,".",i,"=",a,";"),n(f),t("if(",a,"!==",u,".",i,"){",f,"}")}),Object.keys(A).forEach(function(i){var o,a,f=A[i],l=x[i],p=e.block();if(p(s,".",f,"("),Ie(l)){var h=l.length;o=e.global.def(c,".",i),a=e.global.def(u,".",i),p(G(h,function(e){return o+"["+e+"]"}),");",G(h,function(e){return a+"["+e+"]="+o+"["+e+"];"}).join("")),t("if(",G(h,function(e){return o+"["+e+"]!=="+a+"["+e+"]"}).join("||"),"){",p,"}")}else o=r.def(c,".",i),a=r.def(u,".",i),p(o,");",u,".",i,"=",o,";"),t("if(",o,"!==",a,"){",p,"}");n(p)}),e.compile()}(),compile:function(e,t,r,i,o){var a=P();a.stats=a.link(o),Object.keys(t.static).forEach(function(e){Y(a,t,e)}),qr.forEach(function(t){Y(a,e,t)});var s=D(e,t,r,i,a);return function(e,t){var n=e.proc("draw",1);L(e,n),z(e,n,t.context),F(e,n,t.framebuffer),I(e,n,t),B(e,n,t.state),H(e,n,t,!1,!0);var r=t.shader.progVar.append(e,n);if(n(e.shared.gl,".useProgram(",r,".program);"),t.shader.program)V(e,n,t,t.shader.program);else{var i=e.global.def("{}"),o=n.def(r,".id"),a=n.def(i,"[",o,"]");n(e.cond(a).then(a,".call(this,a0);").else(a,"=",i,"[",o,"]=",e.link(function(n){return K(V,e,t,n,1)}),"(",r,");",a,".call(this,a0);"))}Object.keys(t.state).length>0&&n(e.shared.current,".dirty=true;")}(a,s),function(e,t){var r=e.proc("scope",3);e.batchId="a2";var i=e.shared,o=i.current;function a(n){var o=t.shader[n];o&&r.set(i.shader,"."+n,o.append(e,r))}z(e,r,t.context),t.framebuffer&&t.framebuffer.append(e,r),Vi(Object.keys(t.state)).forEach(function(n){var o=t.state[n].append(e,r);Ie(o)?o.forEach(function(t,i){r.set(e.next[n],"["+i+"]",t)}):r.set(i.next,"."+n,o)}),H(e,r,t,!0,!0),[Ir,Lr,Rr,Hr,Br].forEach(function(n){var o=t.draw[n];o&&r.set(i.draw,"."+n,""+o.append(e,r))}),Object.keys(t.uniforms).forEach(function(o){r.set(i.uniforms,"["+n.id(o)+"]",t.uniforms[o].append(e,r))}),Object.keys(t.attributes).forEach(function(n){var i=t.attributes[n].append(e,r),o=e.scopeAttrib(n);Object.keys(new v).forEach(function(e){r.set(o,"."+e,i[e])})}),a(zr),a(Fr),Object.keys(t.state).length>0&&(r(o,".dirty=true;"),r.exit(o,".dirty=true;")),r("a1(",e.shared.context,",a0,",e.batchId,");")}(a,s),function(e,t){var n=e.proc("batch",2);e.batchId="0",L(e,n);var r=!1,i=!0;Object.keys(t.context).forEach(function(e){r=r||t.context[e].propDep}),r||(z(e,n,t.context),i=!1);var o=t.framebuffer,a=!1;function s(e){return e.contextDep&&r||e.propDep}o?(o.propDep?r=a=!0:o.contextDep&&r&&(a=!0),a||F(e,n,o)):F(e,n,null),t.state.viewport&&t.state.viewport.propDep&&(r=!0),I(e,n,t),B(e,n,t.state,function(e){return!s(e)}),t.profile&&s(t.profile)||H(e,n,t,!1,"a1"),t.contextDep=r,t.needsContext=i,t.needsFramebuffer=a;var c=t.shader.progVar;if(c.contextDep&&r||c.propDep)$(e,n,t,null);else{var u=c.append(e,n);if(n(e.shared.gl,".useProgram(",u,".program);"),t.shader.program)$(e,n,t,t.shader.program);else{var f=e.global.def("{}"),l=n.def(u,".id"),p=n.def(f,"[",l,"]");n(e.cond(p).then(p,".call(this,a0,a1);").else(p,"=",f,"[",l,"]=",e.link(function(n){return K($,e,t,n,2)}),"(",u,");",p,".call(this,a0,a1);"))}}Object.keys(t.state).length>0&&n(e.shared.current,".dirty=true;")}(a,s),a.compile()}}}var Ji=34918,eo=34919,to=35007,no=function(e,t){if(!t.ext_disjoint_timer_query)return null;var n=[];function r(e){n.push(e)}var i=[];function o(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var a=[];function s(e){a.push(e)}var c=[];function u(e,t,n){var r=a.pop()||new o;r.startQueryIndex=e,r.endQueryIndex=t,r.sum=0,r.stats=n,c.push(r)}var f=[],l=[];return{beginQuery:function(e){var r=n.pop()||t.ext_disjoint_timer_query.createQueryEXT();t.ext_disjoint_timer_query.beginQueryEXT(to,r),i.push(r),u(i.length-1,i.length,e)},endQuery:function(){t.ext_disjoint_timer_query.endQueryEXT(to)},pushScopeStats:u,update:function(){var e,n,o=i.length;if(0!==o){l.length=Math.max(l.length,o+1),f.length=Math.max(f.length,o+1),f[0]=0,l[0]=0;var a=0;for(e=0,n=0;n<i.length;++n){var u=i[n];t.ext_disjoint_timer_query.getQueryObjectEXT(u,eo)?(a+=t.ext_disjoint_timer_query.getQueryObjectEXT(u,Ji),r(u)):i[e++]=u,f[n+1]=a,l[n+1]=e}for(i.length=e,e=0,n=0;n<c.length;++n){var p=c[n],h=p.startQueryIndex,d=p.endQueryIndex;p.sum+=f[d]-f[h];var m=l[h],v=l[d];v===m?(p.stats.gpuTime+=p.sum/1e6,s(p)):(p.startQueryIndex=m,p.endQueryIndex=v,c[e++]=p)}c.length=e}},getNumPendingQueries:function(){return i.length},clear:function(){n.push.apply(n,i);for(var e=0;e<n.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(n[e]);i.length=0,n.length=0},restore:function(){i.length=0,n.length=0}}},ro=16384,io=256,oo=1024,ao=34962,so="webglcontextlost",co="webglcontextrestored",uo=1,fo=2,lo=3;function po(e,t){for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}return function(n){var r=U(n);if(!r)return null;var i=r.gl,o=i.getContextAttributes(),a=i.isContextLost(),s=function(e,t){var n={};function r(t){T.type(t,"string","extension name must be string");var r,i=t.toLowerCase();try{r=n[i]=e.getExtension(i)}catch(e){}return!!r}for(var i=0;i<t.extensions.length;++i){var o=t.extensions[i];if(!r(o))return t.onDestroy(),t.onDone('"'+o+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return t.optionalExtensions.forEach(r),{extensions:n,restore:function(){Object.keys(n).forEach(function(e){if(n[e]&&!r(e))throw new Error("(regl): error restoring extension "+e)})}}}(i,r);if(!s)return null;var c,u,f=(c={"":0},u=[""],{id:function(e){var t=c[e];return t||(t=c[e]=u.length,u.push(e),t)},str:function(e){return u[e]}}),l={bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0},p=s.extensions,h=no(i,p),d=H(),m=i.drawingBufferWidth,v=i.drawingBufferHeight,g={tick:0,time:0,viewportWidth:m,viewportHeight:v,framebufferWidth:m,framebufferHeight:v,drawingBufferWidth:m,drawingBufferHeight:v,pixelRatio:r.pixelRatio},b=te(i,p),y=function(e,t,n,r){for(var i=n.maxAttributes,o=new Array(i),a=0;a<i;++a)o[a]=new Rn;return{Record:Rn,scope:{},state:o}}(0,0,b),x=function(t,n,r,i){var o=0,a={};function s(e){this.id=o++,this.buffer=t.createBuffer(),this.type=e,this.usage=le,this.byteLength=0,this.dimension=1,this.dtype=he,this.persistentData=null,r.profile&&(this.stats={size:0})}s.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},s.prototype.destroy=function(){l(this)};var c=[];function u(e,n,r){e.byteLength=n.byteLength,t.bufferData(e.type,n,r)}function f(t,n,r,i,o,a){var s,c;if(t.usage=r,Array.isArray(n)){if(t.dtype=i||de,n.length>0)if(Array.isArray(n[0])){s=fe(n);for(var f=1,l=1;l<s.length;++l)f*=s[l];t.dimension=f,c=ue(n,s,t.dtype),u(t,c,r),a?t.persistentData=c:ee.freeType(c)}else if("number"==typeof n[0]){t.dimension=o;var p=ee.allocType(t.dtype,n.length);ge(p,n),u(t,p,r),a?t.persistentData=p:ee.freeType(p)}else e(n[0])?(t.dimension=n[0].length,t.dtype=i||ve(n[0])||de,c=ue(n,[n.length,n[0].length],t.dtype),u(t,c,r),a?t.persistentData=c:ee.freeType(c)):T.raise("invalid buffer data")}else if(e(n))t.dtype=i||ve(n),t.dimension=o,u(t,n,r),a&&(t.persistentData=new Uint8Array(new Uint8Array(n.buffer)));else if(ne(n)){s=n.shape;var h=n.stride,d=n.offset,m=0,v=0,g=0,b=0;1===s.length?(m=s[0],v=1,g=h[0],b=0):2===s.length?(m=s[0],v=s[1],g=h[0],b=h[1]):T.raise("invalid shape"),t.dtype=i||ve(n.data)||de,t.dimension=v;var y=ee.allocType(t.dtype,m*v);be(y,n.data,m,v,g,b,d),u(t,y,r),a?t.persistentData=y:ee.freeType(y)}else T.raise("invalid buffer data")}function l(e){n.bufferCount--;for(var r=0;r<i.state.length;++r){var o=i.state[r];o.buffer===e&&(t.disableVertexAttribArray(r),o.buffer=null)}var s=e.buffer;T(s,"buffer must not be deleted already"),t.deleteBuffer(s),e.buffer=null,delete a[e.id]}return r.profile&&(n.getTotalBufferSize=function(){var e=0;return Object.keys(a).forEach(function(t){e+=a[t].stats.size}),e}),{create:function(i,o,c,u){n.bufferCount++;var p=new s(o);function h(n){var i=le,o=null,a=0,s=0,c=1;return Array.isArray(n)||e(n)||ne(n)?o=n:"number"==typeof n?a=0|n:n&&(T.type(n,"object","buffer arguments must be an object, a number or an array"),"data"in n&&(T(null===o||Array.isArray(o)||e(o)||ne(o),"invalid data for buffer"),o=n.data),"usage"in n&&(T.parameter(n.usage,ce,"invalid buffer usage"),i=ce[n.usage]),"type"in n&&(T.parameter(n.type,se,"invalid buffer type"),s=se[n.type]),"dimension"in n&&(T.type(n.dimension,"number","invalid dimension"),c=0|n.dimension),"length"in n&&(T.nni(a,"buffer length must be a nonnegative integer"),a=0|n.length)),p.bind(),o?f(p,o,i,s,c,u):(a&&t.bufferData(p.type,a,i),p.dtype=s||he,p.usage=i,p.dimension=c,p.byteLength=a),r.profile&&(p.stats.size=p.byteLength*me[p.dtype]),h}function d(e,n){T(n+e.byteLength<=p.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+e.byteLength+" starting from offset "+n+" to a buffer of size "+p.byteLength),t.bufferSubData(p.type,n,e)}return a[p.id]=p,c||h(i),h._reglType="buffer",h._buffer=p,h.subdata=function(t,n){var r,i=0|(n||0);if(p.bind(),e(t))d(t,i);else if(Array.isArray(t)){if(t.length>0)if("number"==typeof t[0]){var o=ee.allocType(p.dtype,t.length);ge(o,t),d(o,i),ee.freeType(o)}else if(Array.isArray(t[0])||e(t[0])){r=fe(t);var a=ue(t,r,p.dtype);d(a,i),ee.freeType(a)}else T.raise("invalid buffer data")}else if(ne(t)){r=t.shape;var s=t.stride,c=0,u=0,f=0,l=0;1===r.length?(c=r[0],u=1,f=s[0],l=0):2===r.length?(c=r[0],u=r[1],f=s[0],l=s[1]):T.raise("invalid shape");var m=Array.isArray(t.data)?p.dtype:ve(t.data),v=ee.allocType(m,c*u);be(v,t.data,c,u,f,l,t.offset),d(v,i),ee.freeType(v)}else T.raise("invalid data for buffer subdata");return h},r.profile&&(h.stats=p.stats),h.destroy=function(){l(p)},h},createStream:function(e,t){var n=c.pop();return n||(n=new s(e)),n.bind(),f(n,t,pe,0,1,!1),n},destroyStream:function(e){c.push(e)},clear:function(){re(a).forEach(l),c.forEach(l)},getBuffer:function(e){return e&&e._buffer instanceof s?e._buffer:null},restore:function(){re(a).forEach(function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)})},_initBuffer:f}}(i,l,r,y),w=function(t,n,r,i){var o={},a=0,s={uint8:Ae,uint16:Se};function c(e){this.id=a++,o[this.id]=this,this.buffer=e,this.primType=_e,this.vertCount=0,this.type=0}n.oes_element_index_uint&&(s.uint32=Ee),c.prototype.bind=function(){this.buffer.bind()};var u=[];function f(i,o,a,s,c,u,f){if(i.buffer.bind(),o){var l=f;f||e(o)&&(!ne(o)||e(o.data))||(l=n.oes_element_index_uint?Ee:Se),r._initBuffer(i.buffer,o,a,l,3)}else t.bufferData(Oe,u,a),i.buffer.dtype=p||Ae,i.buffer.usage=a,i.buffer.dimension=3,i.buffer.byteLength=u;var p=f;if(!f){switch(i.buffer.dtype){case Ae:case Ce:p=Ae;break;case Se:case je:p=Se;break;case Ee:case ke:p=Ee;break;default:T.raise("unsupported type for element array")}i.buffer.dtype=p}i.type=p,T(p!==Ee||!!n.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var h=c;h<0&&(h=i.buffer.byteLength,p===Se?h>>=1:p===Ee&&(h>>=2)),i.vertCount=h;var d=s;if(s<0){d=_e;var m=i.buffer.dimension;1===m&&(d=xe),2===m&&(d=we),3===m&&(d=_e)}i.primType=d}function l(e){i.elementsCount--,T(null!==e.buffer,"must not double destroy elements"),delete o[e.id],e.buffer.destroy(),e.buffer=null}return{create:function(t,n){var o=r.create(null,Oe,!0),a=new c(o._buffer);function u(t){if(t)if("number"==typeof t)o(t),a.primType=_e,a.vertCount=0|t,a.type=Ae;else{var n=null,r=Pe,i=-1,c=-1,l=0,p=0;Array.isArray(t)||e(t)||ne(t)?n=t:(T.type(t,"object","invalid arguments for elements"),"data"in t&&(n=t.data,T(Array.isArray(n)||e(n)||ne(n),"invalid data for element buffer")),"usage"in t&&(T.parameter(t.usage,ce,"invalid element buffer usage"),r=ce[t.usage]),"primitive"in t&&(T.parameter(t.primitive,ye,"invalid element buffer primitive"),i=ye[t.primitive]),"count"in t&&(T("number"==typeof t.count&&t.count>=0,"invalid vertex count for elements"),c=0|t.count),"type"in t&&(T.parameter(t.type,s,"invalid buffer type"),p=s[t.type]),"length"in t?l=0|t.length:(l=c,p===Se||p===je?l*=2:p!==Ee&&p!==ke||(l*=4))),f(a,n,r,i,c,l,p)}else o(),a.primType=_e,a.vertCount=0,a.type=Ae;return u}return i.elementsCount++,u(t),u._reglType="elements",u._elements=a,u.subdata=function(e,t){return o.subdata(e,t),u},u.destroy=function(){l(a)},u},createStream:function(e){var t=u.pop();return t||(t=new c(r.create(null,Oe,!0,!1)._buffer)),f(t,e,Me,-1,-1,0,0),t},destroyStream:function(e){u.push(e)},getElements:function(e){return"function"==typeof e&&e._elements instanceof c?e._elements:null},clear:function(){re(o).forEach(l)}}}(i,p,x,l),_=function(e,t,n,r){var i={},o={};function a(e,t,n,r){this.name=e,this.id=t,this.location=n,this.info=r}function s(e,t){for(var n=0;n<e.length;++n)if(e[n].id===t.id)return void(e[n].location=t.location);e.push(t)}function c(n,r,a){var s=n===Ln?i:o,c=s[r];if(!c){var u=t.str(r);c=e.createShader(n),e.shaderSource(c,u),e.compileShader(c),T.shaderError(e,c,u,n,a),s[r]=c}return c}var u={},f=[],l=0;function p(e,t){this.id=l++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],r.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function h(n,i){var o,u,f=c(Ln,n.fragId),l=c(Hn,n.vertId),p=n.program=e.createProgram();e.attachShader(p,f),e.attachShader(p,l),e.linkProgram(p),T.linkError(e,p,t.str(n.fragId),t.str(n.vertId),i);var h=e.getProgramParameter(p,Wn);r.profile&&(n.stats.uniformsCount=h);var d=n.uniforms;for(o=0;o<h;++o)if(u=e.getActiveUniform(p,o))if(u.size>1)for(var m=0;m<u.size;++m){var v=u.name.replace("[0]","["+m+"]");s(d,new a(v,t.id(v),e.getUniformLocation(p,v),u))}else s(d,new a(u.name,t.id(u.name),e.getUniformLocation(p,u.name),u));var g=e.getProgramParameter(p,Nn);r.profile&&(n.stats.attributesCount=g);var b=n.attributes;for(o=0;o<g;++o)(u=e.getActiveAttrib(p,o))&&s(b,new a(u.name,t.id(u.name),e.getAttribLocation(p,u.name),u))}return r.profile&&(n.getMaxUniformsCount=function(){var e=0;return f.forEach(function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)}),e},n.getMaxAttributesCount=function(){var e=0;return f.forEach(function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)}),e}),{clear:function(){var t=e.deleteShader.bind(e);re(i).forEach(t),i={},re(o).forEach(t),o={},f.forEach(function(t){e.deleteProgram(t.program)}),f.length=0,u={},n.shaderCount=0},program:function(e,t,r){T.command(e>=0,"missing vertex shader",r),T.command(t>=0,"missing fragment shader",r);var i=u[t];i||(i=u[t]={});var o=i[e];return o||(o=new p(t,e),n.shaderCount++,h(o,r),i[e]=o,f.push(o)),o},restore:function(){i={},o={};for(var e=0;e<f.length;++e)h(f[e])},shader:c,frag:-1,vert:-1}}(i,f,l,r),C=hn(i,p,b,function(){S.procs.poll()},g,l,r),A=bn(i,p,b,l,r),j=function(e,n,r,i,o,a){var s={cur:null,next:null,dirty:!1,setFBO:null},c=["rgba"],u=["rgba4","rgb565","rgb5 a1"];n.ext_srgb&&u.push("srgba"),n.ext_color_buffer_half_float&&u.push("rgba16f","rgb16f"),n.webgl_color_buffer_float&&u.push("rgba32f");var f=["uint8"];function l(e,t,n){this.target=e,this.texture=t,this.renderbuffer=n;var r=0,i=0;t?(r=t.width,i=t.height):n&&(r=n.width,i=n.height),this.width=r,this.height=i}function p(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function h(e,t,n){if(e)if(e.texture){var r=e.texture._texture,i=Math.max(1,r.width),o=Math.max(1,r.height);T(i===t&&o===n,"inconsistent width/height for supplied texture"),r.refCount+=1}else{var a=e.renderbuffer._renderbuffer;T(a.width===t&&a.height===n,"inconsistent width/height for renderbuffer"),a.refCount+=1}}function d(t,n){n&&(n.texture?e.framebufferTexture2D(yn,t,n.target,n.texture._texture.texture,0):e.framebufferRenderbuffer(yn,t,xn,n.renderbuffer._renderbuffer.renderbuffer))}function m(e){var t=wn,n=null,r=null,i=e;"object"==typeof e&&(i=e.data,"target"in e&&(t=0|e.target)),T.type(i,"function","invalid attachment data");var o=i._reglType;return"texture2d"===o?(n=i,T(t===wn)):"textureCube"===o?(n=i,T(t>=_n&&t<_n+6,"invalid cube map target")):"renderbuffer"===o?(r=i,t=xn):T.raise("invalid regl object for attachment"),new l(t,n,r)}function v(e,t,n,r,a){if(n){var s=i.create2D({width:e,height:t,format:r,type:a});return s._texture.refCount=0,new l(wn,s,null)}var c=o.create({width:e,height:t,format:r});return c._renderbuffer.refCount=0,new l(xn,null,c)}function g(e){return e&&(e.texture||e.renderbuffer)}function b(e,t,n){e&&(e.texture?e.texture.resize(t,n):e.renderbuffer&&e.renderbuffer.resize(t,n),e.width=t,e.height=n)}n.oes_texture_half_float&&f.push("half float","float16"),n.oes_texture_float&&f.push("float","float32");var y=0,x={};function w(){this.id=y++,x[this.id]=this,this.framebuffer=e.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function _(e){e.colorAttachments.forEach(p),p(e.depthAttachment),p(e.stencilAttachment),p(e.depthStencilAttachment)}function C(t){var n=t.framebuffer;T(n,"must not double destroy framebuffer"),e.deleteFramebuffer(n),t.framebuffer=null,a.framebufferCount--,delete x[t.id]}function A(t){var n;e.bindFramebuffer(yn,t.framebuffer);var i=t.colorAttachments;for(n=0;n<i.length;++n)d(Cn+n,i[n]);for(n=i.length;n<r.maxColorAttachments;++n)e.framebufferTexture2D(yn,Cn+n,wn,null,0);e.framebufferTexture2D(yn,Sn,wn,null,0),e.framebufferTexture2D(yn,An,wn,null,0),e.framebufferTexture2D(yn,jn,wn,null,0),d(An,t.depthAttachment),d(jn,t.stencilAttachment),d(Sn,t.depthStencilAttachment);var o=e.checkFramebufferStatus(yn);e.isContextLost()||o===kn||T.raise("framebuffer configuration not supported, status = "+In[o]),e.bindFramebuffer(yn,s.next?s.next.framebuffer:null),s.cur=s.next,e.getError()}function j(e,i){var o=new w;function l(e,t){var i;T(s.next!==o,"can not update framebuffer which is currently in use");var a=0,p=0,d=!0,b=!0,y=null,x=!0,w="rgba",C="uint8",j=1,S=null,k=null,E=null,O=!1;if("number"==typeof e)a=0|e,p=0|t||a;else if(e){T.type(e,"object","invalid arguments for framebuffer");var M=e;if("shape"in M){var P=M.shape;T(Array.isArray(P)&&P.length>=2,"invalid shape for framebuffer"),a=P[0],p=P[1]}else"radius"in M&&(a=p=M.radius),"width"in M&&(a=M.width),"height"in M&&(p=M.height);("color"in M||"colors"in M)&&(y=M.color||M.colors,Array.isArray(y)&&T(1===y.length||n.webgl_draw_buffers,"multiple render targets not supported")),y||("colorCount"in M&&(j=0|M.colorCount,T(j>0,"invalid color buffer count")),"colorTexture"in M&&(x=!!M.colorTexture,w="rgba4"),"colorType"in M&&(C=M.colorType,x?(T(n.oes_texture_float||!("float"===C||"float32"===C),"you must enable OES_texture_float in order to use floating point framebuffer objects"),T(n.oes_texture_half_float||!("half float"===C||"float16"===C),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):"half float"===C||"float16"===C?(T(n.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),w="rgba16f"):"float"!==C&&"float32"!==C||(T(n.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),w="rgba32f"),T.oneOf(C,f,"invalid color type")),"colorFormat"in M&&(w=M.colorFormat,c.indexOf(w)>=0?x=!0:u.indexOf(w)>=0?x=!1:x?T.oneOf(M.colorFormat,c,"invalid color format for texture"):T.oneOf(M.colorFormat,u,"invalid color format for renderbuffer"))),("depthTexture"in M||"depthStencilTexture"in M)&&(O=!(!M.depthTexture&&!M.depthStencilTexture),T(!O||n.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in M&&("boolean"==typeof M.depth?d=M.depth:(S=M.depth,b=!1)),"stencil"in M&&("boolean"==typeof M.stencil?b=M.stencil:(k=M.stencil,d=!1)),"depthStencil"in M&&("boolean"==typeof M.depthStencil?d=b=M.depthStencil:(E=M.depthStencil,d=!1,b=!1))}else a=p=1;var D=null,z=null,F=null,I=null;if(Array.isArray(y))D=y.map(m);else if(y)D=[m(y)];else for(D=new Array(j),i=0;i<j;++i)D[i]=v(a,p,x,w,C);T(n.webgl_draw_buffers||D.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),T(D.length<=r.maxColorAttachments,"too many color attachments, not supported"),a=a||D[0].width,p=p||D[0].height,S?z=m(S):d&&!b&&(z=v(a,p,O,"depth","uint32")),k?F=m(k):b&&!d&&(F=v(a,p,!1,"stencil","uint8")),E?I=m(E):!S&&!k&&b&&d&&(I=v(a,p,O,"depth stencil","depth stencil")),T(!!S+!!k+!!E<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var B=null;for(i=0;i<D.length;++i)if(h(D[i],a,p),T(!D[i]||D[i].texture&&On.indexOf(D[i].texture._texture.format)>=0||D[i].renderbuffer&&Fn.indexOf(D[i].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+i+" is invalid"),D[i]&&D[i].texture){var R=Mn[D[i].texture._texture.format]*Pn[D[i].texture._texture.type];null===B?B=R:T(B===R,"all color attachments much have the same number of bits per pixel.")}return h(z,a,p),T(!z||z.texture&&z.texture._texture.format===En||z.renderbuffer&&z.renderbuffer._renderbuffer.format===Tn,"invalid depth attachment for framebuffer object"),h(F,a,p),T(!F||F.renderbuffer&&F.renderbuffer._renderbuffer.format===Dn,"invalid stencil attachment for framebuffer object"),h(I,a,p),T(!I||I.texture&&I.texture._texture.format===zn||I.renderbuffer&&I.renderbuffer._renderbuffer.format===zn,"invalid depth-stencil attachment for framebuffer object"),_(o),o.width=a,o.height=p,o.colorAttachments=D,o.depthAttachment=z,o.stencilAttachment=F,o.depthStencilAttachment=I,l.color=D.map(g),l.depth=g(z),l.stencil=g(F),l.depthStencil=g(I),l.width=o.width,l.height=o.height,A(o),l}return a.framebufferCount++,l(e,i),t(l,{resize:function(e,t){T(s.next!==o,"can not resize a framebuffer which is currently in use");var n=Math.max(0|e,1),r=Math.max(0|t||n,1);if(n===o.width&&r===o.height)return l;for(var i=o.colorAttachments,a=0;a<i.length;++a)b(i[a],n,r);return b(o.depthAttachment,n,r),b(o.stencilAttachment,n,r),b(o.depthStencilAttachment,n,r),o.width=l.width=n,o.height=l.height=r,A(o),l},_reglType:"framebuffer",_framebuffer:o,destroy:function(){C(o),_(o)},use:function(e){s.setFBO({framebuffer:l},e)}})}return t(s,{getFramebuffer:function(e){if("function"==typeof e&&"framebuffer"===e._reglType){var t=e._framebuffer;if(t instanceof w)return t}return null},create:j,createCube:function(e){var o=Array(6);function a(e){var r;T(o.indexOf(s.next)<0,"can not update framebuffer which is currently in use");var u,l={color:null},p=0,h=null,d="rgba",m="uint8",v=1;if("number"==typeof e)p=0|e;else if(e){T.type(e,"object","invalid arguments for framebuffer");var g=e;if("shape"in g){var b=g.shape;T(Array.isArray(b)&&b.length>=2,"invalid shape for framebuffer"),T(b[0]===b[1],"cube framebuffer must be square"),p=b[0]}else"radius"in g&&(p=0|g.radius),"width"in g?(p=0|g.width,"height"in g&&T(g.height===p,"must be square")):"height"in g&&(p=0|g.height);("color"in g||"colors"in g)&&(h=g.color||g.colors,Array.isArray(h)&&T(1===h.length||n.webgl_draw_buffers,"multiple render targets not supported")),h||("colorCount"in g&&(v=0|g.colorCount,T(v>0,"invalid color buffer count")),"colorType"in g&&(T.oneOf(g.colorType,f,"invalid color type"),m=g.colorType),"colorFormat"in g&&(d=g.colorFormat,T.oneOf(g.colorFormat,c,"invalid color format for texture"))),"depth"in g&&(l.depth=g.depth),"stencil"in g&&(l.stencil=g.stencil),"depthStencil"in g&&(l.depthStencil=g.depthStencil)}else p=1;if(h)if(Array.isArray(h))for(u=[],r=0;r<h.length;++r)u[r]=h[r];else u=[h];else{u=Array(v);var y={radius:p,format:d,type:m};for(r=0;r<v;++r)u[r]=i.createCube(y)}for(l.color=Array(u.length),r=0;r<u.length;++r){var x=u[r];T("function"==typeof x&&"textureCube"===x._reglType,"invalid cube map"),p=p||x.width,T(x.width===p&&x.height===p,"invalid cube map shape"),l.color[r]={target:_n,data:u[r]}}for(r=0;r<6;++r){for(var w=0;w<u.length;++w)l.color[w].target=_n+r;r>0&&(l.depth=o[0].depth,l.stencil=o[0].stencil,l.depthStencil=o[0].depthStencil),o[r]?o[r](l):o[r]=j(l)}return t(a,{width:p,height:p,color:u})}return a(e),t(a,{faces:o,resize:function(e){var t,n=0|e;if(T(n>0&&n<=r.maxCubeMapSize,"invalid radius for cube fbo"),n===a.width)return a;var i=a.color;for(t=0;t<i.length;++t)i[t].resize(n);for(t=0;t<6;++t)o[t].resize(n);return a.width=a.height=n,a},_reglType:"framebufferCube",destroy:function(){o.forEach(function(e){e.destroy()})}})},clear:function(){re(x).forEach(C)},restore:function(){s.cur=null,s.next=null,s.dirty=!0,re(x).forEach(function(t){t.framebuffer=e.createFramebuffer(),A(t)})}})}(i,p,b,C,A,l),S=Qi(i,f,p,b,x,w,0,j,{},y,_,{elements:null,primitive:4,count:-1,offset:0,instances:-1},g,h,r),k=qn(i,j,S.procs.poll,g,o,p,b),E=S.next,O=i.canvas,M=[],P=[],D=[],z=[r.onDestroy],F=null;function I(){if(0===M.length)return h&&h.update(),void(F=null);F=L.next(I),Z();for(var e=M.length-1;e>=0;--e){var t=M[e];t&&t(g,null,0)}i.flush(),h&&h.update()}function B(){!F&&M.length>0&&(F=L.next(I))}function W(){F&&(L.cancel(I),F=null)}function N(e){e.preventDefault(),a=!0,W(),P.forEach(function(e){e()})}function G(e){i.getError(),a=!1,s.restore(),_.restore(),x.restore(),C.restore(),A.restore(),j.restore(),h&&h.restore(),S.procs.refresh(),B(),D.forEach(function(e){e()})}function K(e){function n(e){var t={},n={};return Object.keys(e).forEach(function(r){var i=e[r];R.isDynamic(i)?n[r]=R.unbox(i,r):t[r]=i}),{dynamic:n,static:t}}T(!!e,"invalid args to regl({...})"),T.type(e,"object","invalid args to regl({...})");var r=n(e.context||{}),i=n(e.uniforms||{}),o=n(e.attributes||{}),s=n(function(e){var n=t({},e);function r(e){if(e in n){var t=n[e];delete n[e],Object.keys(t).forEach(function(r){n[e+"."+r]=t[r]})}}return delete n.uniforms,delete n.attributes,delete n.context,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),r("blend"),r("depth"),r("cull"),r("stencil"),r("polygonOffset"),r("scissor"),r("sample"),n}(e)),c={gpuTime:0,cpuTime:0,count:0},u=S.compile(s,o,i,r,c),f=u.draw,l=u.batch,p=u.scope,h=[];return t(function(e,t){var n;if(a&&T.raise("context lost"),"function"==typeof e)return p.call(this,null,e,0);if("function"==typeof t){if("number"==typeof e){for(n=0;n<e;++n)p.call(this,null,t,n);return}if(Array.isArray(e)){for(n=0;n<e.length;++n)p.call(this,e[n],t,n);return}return p.call(this,e,t,0)}if("number"==typeof e){if(e>0)return l.call(this,function(e){for(;h.length<e;)h.push(null);return h}(0|e),0|e)}else{if(!Array.isArray(e))return f.call(this,e);if(e.length)return l.call(this,e,e.length)}},{stats:c})}O&&(O.addEventListener(so,N,!1),O.addEventListener(co,G,!1));var V=j.setFBO=K({framebuffer:R.define.call(null,uo,"framebuffer")});function q(e,t){var n=0;S.procs.poll();var r=t.color;r&&(i.clearColor(+r[0]||0,+r[1]||0,+r[2]||0,+r[3]||0),n|=ro),"depth"in t&&(i.clearDepth(+t.depth),n|=io),"stencil"in t&&(i.clearStencil(0|t.stencil),n|=oo),T(!!n,"called regl.clear with no buffer specified"),i.clear(n)}function $(e){return T.type(e,"function","regl.frame() callback must be a function"),M.push(e),B(),{cancel:function(){var t=po(M,e);T(t>=0,"cannot cancel a frame twice"),M[t]=function e(){var t=po(M,e);M[t]=M[M.length-1],M.length-=1,M.length<=0&&W()}}}}function Y(){var e=E.viewport,t=E.scissor_box;e[0]=e[1]=t[0]=t[1]=0,g.viewportWidth=g.framebufferWidth=g.drawingBufferWidth=e[2]=t[2]=i.drawingBufferWidth,g.viewportHeight=g.framebufferHeight=g.drawingBufferHeight=e[3]=t[3]=i.drawingBufferHeight}function Z(){g.tick+=1,g.time=Q(),Y(),S.procs.poll()}function X(){Y(),S.procs.refresh(),h&&h.update()}function Q(){return(H()-d)/1e3}X();var J=t(K,{clear:function(e){if(T("object"==typeof e&&e,"regl.clear() takes an object as input"),"framebuffer"in e)if(e.framebuffer&&"framebufferCube"===e.framebuffer_reglType)for(var n=0;n<6;++n)V(t({framebuffer:e.framebuffer.faces[n]},e),q);else V(e,q);else q(null,e)},prop:R.define.bind(null,uo),context:R.define.bind(null,fo),this:R.define.bind(null,lo),draw:K({}),buffer:function(e){return x.create(e,ao,!1,!1)},elements:function(e){return w.create(e,!1)},texture:C.create2D,cube:C.createCube,renderbuffer:A.create,framebuffer:j.create,framebufferCube:j.createCube,attributes:o,frame:$,on:function(e,t){var n;switch(T.type(t,"function","listener callback must be a function"),e){case"frame":return $(t);case"lost":n=P;break;case"restore":n=D;break;case"destroy":n=z;break;default:T.raise("invalid event, must be one of frame,lost,restore,destroy")}return n.push(t),{cancel:function(){for(var e=0;e<n.length;++e)if(n[e]===t)return n[e]=n[n.length-1],void n.pop()}}},limits:b,hasExtension:function(e){return b.extensions.indexOf(e.toLowerCase())>=0},read:k,destroy:function(){M.length=0,W(),O&&(O.removeEventListener(so,N),O.removeEventListener(co,G)),_.clear(),j.clear(),A.clear(),C.clear(),w.clear(),x.clear(),h&&h.clear(),z.forEach(function(e){e()})},_gl:i,_refresh:X,poll:function(){Z(),h&&h.update()},now:Q,stats:l});return r.onDone(null,J),J}}()}),qo=function(e,t,n,r){var i=n?n.call(r,e,t):void 0;if(void 0!==i)return!!i;if(e===t)return!0;if("object"!=typeof e||!e||"object"!=typeof t||!t)return!1;var o=Object.keys(e),a=Object.keys(t);if(o.length!==a.length)return!1;for(var s=Object.prototype.hasOwnProperty.bind(t),c=0;c<o.length;c++){var u=o[c];if(!s(u))return!1;var f=e[u],l=t[u];if(!1===(i=n?n.call(r,f,l,u):void 0)||void 0===i&&f!==l)return!1}return!0};var $o=function(e){var t=null==e?0:e.length;return t?e[t-1]:void 0};class Yo{constructor(){i(this,"_objectsByObjectHitmapIdMap",{}),i(this,"_commandsByObjectMap",new Map),i(this,"_nextObjectHitmapId",1),i(this,"_instanceIndexByObjectHitmapIdMap",{}),i(this,"assignNextColors",(e,t,n)=>{if(n<1)throw new Error("Must get at least 1 id");const r=function(e,t){return new Array(t).fill(0).map((t,n)=>e+n)}(this._nextObjectHitmapId,n);this._nextObjectHitmapId=$o(r)+1,n>1&&r.forEach((e,t)=>{this._instanceIndexByObjectHitmapIdMap[e]=t});for(const e of r)this._objectsByObjectHitmapIdMap[e]=t;return this._commandsByObjectMap.set(t,e),r.map(e=>Ti(e))}),i(this,"getObjectByObjectHitmapId",e=>({object:this._objectsByObjectHitmapIdMap[e],instanceIndex:this._instanceIndexByObjectHitmapIdMap[e]})),i(this,"getCommandForObject",e=>this._commandsByObjectMap.get(e))}}function Zo(e){let t=!1;const n=[];function r(...i){if(t){const e=function(){let e,t;const n=new Promise((n,r)=>{e=n,t=r});return n.resolve=e,n.reject=t,n}();return n.push({args:i,promise:e}),e}return function i(...o){t=!0;const a=e(...o).finally(()=>{if(t=!1,r.currentPromise=void 0,n.length){const{promise:e,args:t}=n.shift();i(...t).then(t=>e.resolve(t)).catch(t=>e.reject(t))}});r.currentPromise=a;return a}(...i)}return r}function Xo(e,t){const n=t(e);return"function"==typeof n?n:e(n)}class Qo{constructor({dimension:e,canvasBackgroundColor:t,cameraState:n,onCameraStateChange:r,contextAttributes:a}){i(this,"_commands",new Set),i(this,"_compiled",new Map),i(this,"_drawCalls",new Map),i(this,"_frame",void 0),i(this,"_needsPaint",!1),i(this,"_paintCalls",new Map),i(this,"_hitmapObjectIdManager",new Yo),i(this,"_cachedReadHitmapCall",void 0),i(this,"reglCommandObjects",[]),i(this,"counters",{}),i(this,"dimension",void 0),i(this,"onDirty",void 0),i(this,"cameraStore",void 0),i(this,"canvasBackgroundColor",[0,0,0,1]),i(this,"initializedData",void 0),i(this,"contextAttributes",void 0),i(this,"raycast",(e,t)=>{if(!this.initializedData)return;const{width:n,height:r}=this.dimension;return Wo(this.initializedData.camera,{clientX:e,clientY:t,width:n,height:r})}),i(this,"onDirty",()=>{void 0===this._frame?this._frame=requestAnimationFrame(()=>this.paint()):this._needsPaint=!0}),i(this,"readHitmap",Zo((e,t,n,r)=>{if(!this.initializedData)return Promise.reject(new Error("regl data not initialized yet"));const i=[e,t,n,r],a=this._cachedReadHitmapCall;if(a){if(qo(a.arguments,i)){const e=a.result.map(([e,t])=>[o({},e),t]);return Promise.resolve(e)}this._cachedReadHitmapCall=void 0}const{regl:s,camera:c,_fbo:u}=this.initializedData,{width:f,height:l}=this.dimension,p=e,h=l-t;return u.resize(Math.floor(f),Math.floor(l)),new Promise(e=>{s({framebuffer:u})(()=>{s.clear({color:Ti(0),depth:1});let t=0;const o=[],a=[];let u=0;c.draw(this.cameraStore.state,()=>{do{if(u>=r){console.error(`Hit ${r} iterations. There is either a bug or that number of rendered hitmap layers under the mouse cursor.`);break}if(u++,s.clear({color:Ti(0),depth:1}),this._drawInput(!0,o),p<Math.floor(f)&&h<Math.floor(l)&&p>=0&&h>=0){const e=new Uint8Array(4);s.read({x:p,y:h,width:1,height:1,data:e}),t=Di(e);const n=this._hitmapObjectIdManager.getObjectByObjectHitmapId(t);if(t>0&&!n&&console.error(`Clicked on an unknown object with id ${t}. This likely means that a command is painting an incorrect color into the hitmap.`),o.some(({object:e,instanceIndex:t})=>e===n.object&&t===n.instanceIndex)){console.error("Saw object twice when reading from hitmap. There is likely an error in getHitmapFromChildren",n);break}if(t>0&&n.object){const e=this._hitmapObjectIdManager.getCommandForObject(n.object);o.push(n),e&&a.push([n,e])}}}while(0!==t&&n);this._cachedReadHitmapCall={arguments:i,result:a},e(a)})})})})),i(this,"_drawInput",(e,t)=>{e&&(this._hitmapObjectIdManager=new Yo),Array.from(this._drawCalls.values()).sort((e,t)=>(e.layerIndex||0)-(t.layerIndex||0)).forEach(n=>{const{reglCommand:r,children:i,instance:o,getChildrenForHitmap:a}=n;if(!i)return console.debug(`${e?"hitmap":""} draw skipped, props was falsy`,n);const s=this._compiled.get(r);if(!s)return console.warn("could not find draw command for",o?o.constructor.displayName:"Unknown");if(e&&a){const e=a(i,(...e)=>this._hitmapObjectIdManager.assignNextColors(o,...e),t||[]);e&&s(e,!0)}else e||s(i,!1)})}),i(this,"_clearCanvas",e=>{e.poll(),e.clear({color:this.canvasBackgroundColor,depth:1})}),this.dimension=e,this.canvasBackgroundColor=t,this.contextAttributes=a,this.cameraStore=new Qi(e=>{r?r(e):this.paint()},n)}initialize(e){if(this.initializedData)throw new Error("can not initialize regl twice");const t=this._instrumentCommands(Vo({canvas:e,attributes:this.contextAttributes||{},extensions:["angle_instanced_arrays","oes_texture_float","oes_element_index_uint","oes_standard_derivatives"],profile:"production"!==Bo()}));this._commands.forEach(e=>{const n=Xo(t,e);this._compiled.set(e,n)});const n=new(Xo(t,vo)),r=t.framebuffer({width:Math.round(this.dimension.width),height:Math.round(this.dimension.height)});this.initializedData={_fbo:r,camera:n,regl:t}}destroy(){this.initializedData&&this.initializedData.regl.destroy(),this._frame&&cancelAnimationFrame(this._frame)}onMount(e,t){const{initializedData:n}=this;n&&!this._commands.has(t)&&(this._commands.add(t),this._compiled.set(t,Xo(n.regl,t)))}onUnmount(e){this._drawCalls.delete(e)}unregisterPaintCallback(e){this._paintCalls.delete(e)}registerDrawCall(e){this._drawCalls.set(e.instance,e)}registerPaintCallback(e){this._paintCalls.set(e,e)}setDimension(e){this.dimension=e}paint(){try{this._paint()}catch(e){if("(regl) context lost"!==e.message)throw e;console.warn(e)}}_paint(){this._needsPaint=!1;const e=Date.now();if(this.reglCommandObjects.forEach(e=>e.stats.count=0),!this.initializedData)return;this._cachedReadHitmapCall=null;const{regl:t,camera:n}=this.initializedData;this._clearCanvas(t),n.draw(this.cameraStore.state,()=>{const e=Date.now();this._drawInput(),this.counters.paint=Date.now()-e}),this._paintCalls.forEach(e=>{e()}),this.counters.render=Date.now()-e,this._needsPaint?this._frame=requestAnimationFrame(()=>this.paint()):this._frame=void 0}_instrumentCommands(e){return"production"===Bo()?e:new Proxy(e,{apply:(e,t,n)=>{const r=e(...n);return"object"==typeof r.stats&&this.reglCommandObjects.push(r),r}})}}const Jo=[0,0,0,1],ea=3;function ta(e,t,n,r){const i={ray:t,objects:e};try{r(n,i)}catch(e){console.error("Error during mouse handler",e)}}class na extends t.Component{constructor(e){super(e),i(this,"_canvas",t.createRef()),i(this,"_cameraListener",t.createRef()),i(this,"_tick",void 0),i(this,"_dragStartPos",null),i(this,"handleOffscreenMouseEvent",(e,t)=>{"onDoubleClick"===t?this._onDoubleClick(e,!0):"onMouseDown"===t?this._onMouseDown(e,!0):"onMouseMove"===t?this._onMouseMove(e,!0):"onMouseUp"===t&&this._onMouseUp(e,!0)}),i(this,"_onDoubleClick",(e,t)=>{this._onMouseInteraction(e,"onDoubleClick",t)}),i(this,"_onMouseDown",(e,t)=>{this._dragStartPos={x:e.clientX,y:e.clientY},this._onMouseInteraction(e,"onMouseDown",t)}),i(this,"_onMouseMove",(e,t)=>{this._onMouseInteraction(e,"onMouseMove",t)}),i(this,"_onMouseUp",(e,t)=>{this._onMouseInteraction(e,"onMouseUp",t);const{_dragStartPos:n}=this;if(n){const r=e.clientX-n.x,i=e.clientY-n.y;Math.sqrt(r*r+i*i)<ea&&this._onMouseInteraction(e,"onClick",t),this._dragStartPos=null}}),i(this,"_onMouseInteraction",(e,t,n)=>{const{worldviewContext:r}=this.state,i=this.props[t];if(!(n||e.target instanceof window.HTMLElement&&0===e.button))return;const{top:o,left:a}=e.target.getBoundingClientRect(),{clientX:s,clientY:c}=e,u=s-a,f=c-o,l=r.raycast(u,f);if(!l)return;const{hitmapOnMouseMove:p,disableHitmapForEvents:h=(p?[]:["onMouseMove"])}=this.props;if(h.includes(t))return i?ta([],l,e,i):void 0;e.persist(),r.readHitmap(u,f,!!this.props.enableStackedObjectEvents,this.props.maxStackedObjectCount).then(n=>{const r=function(e){const t=new Map;return e.forEach(([e,n])=>{const r=t.get(n)||[];r.push(e),t.has(n)||t.set(n,r)}),t}(n);for(const[n,i]of r.entries())if(n.handleMouseEvent(i,l,e,t),e.isPropagationStopped())break;if(i&&!e.isPropagationStopped()){ta(n.map(([e])=>e),l,e,i)}}).catch(e=>{console.error(e)})});const{width:n,height:r,top:o,left:a,backgroundColor:s,onCameraStateChange:c,cameraState:u,defaultCameraState:f,hitmapOnMouseMove:l,disableHitmapForEvents:p,canvas:h}=e;if(h&&(this._canvas.current=h),c?(u||console.warn("You provided `onCameraStateChange` without `cameraState`. Use Worldview as a controlled component with `cameraState` and `onCameraStateChange`, or uncontrolled with `defaultCameraState`."),u&&f&&console.warn("You provided both `cameraState` and `defaultCameraState`. `defaultCameraState` will be ignored.")):u&&console.warn("You provided `cameraState` without an `onCameraStateChange` handler. This will prevent moving the camera. If the camera should be movable, use `defaultCameraState`, otherwise set `onCameraStateChange`."),l){if(p)throw new Error("Property 'hitmapOnMouseMove' is deprectated and will be ignored when used along with 'disableHitmapForEvents'.");console.warn("Property 'hitmapOnMouseMove' is deprectated. Please use 'disableHitmapForEvents' property instead.")}this.state={worldviewContext:new Qo({dimension:{width:n,height:r,top:o,left:a},canvasBackgroundColor:s||Jo,cameraState:e.cameraState||e.defaultCameraState||Xi,onCameraStateChange:e.onCameraStateChange||void 0,contextAttributes:e.contextAttributes||{}})}}static getDerivedStateFromProps({width:e,height:t,top:n,left:r},{worldviewContext:i}){return i.setDimension({width:e,height:t,top:n,left:r}),null}componentDidMount(){if(!this._canvas.current)return console.warn("missing canvas element");const{worldviewContext:e}=this.state;e.initialize(this._canvas.current),this.setState({}),e.paint()}componentWillUnmount(){this._tick&&cancelAnimationFrame(this._tick),this.state.worldviewContext.destroy()}componentDidUpdate(){const{worldviewContext:e}=this.state;this.props.cameraState&&e.cameraStore.setCameraState(this.props.cameraState),e.onDirty()}focus(){this._cameraListener.current&&this._cameraListener.current.focus()}_renderDebug(){const{worldviewContext:e}=this.state,n=e.initializedData;if("production"===Bo()||!n)return null;const{regl:r}=n,i=window.performance.memory,{counters:o,reglCommandObjects:a}=e,s=ir(o,e=>`${e} ms`);if(s["draw calls"]=a.reduce((e,t)=>e+t.stats.count,0),i&&(s["heap used"]=`${(i.usedJSHeapSize/i.jsHeapSizeLimit*100).toFixed(3)}%`),Object.assign(s,vr(r.stats,e=>"number"==typeof e&&0!==e)),r.stats.bufferCount>1e3)throw new Error("Memory leak: Buffer count > 1000.");const c=Object.keys(s).map(e=>t.createElement("tr",{key:e,style:{backgroundColor:"transparent",border:"none"}},t.createElement("td",{style:{paddingRight:10,border:"none"}},e),t.createElement("td",{style:{width:"100%",border:"none"}},s[e])));return t.createElement("table",{style:{bottom:5,right:10,width:200,position:"absolute",backgroundColor:"rgba(0, 0, 0, 0.5)",color:"white",fontFamily:"monospace",fontSize:10}},t.createElement("tbody",null,c))}render(){const{width:e,height:n,showDebug:r,keyMap:i,shiftKeys:a,style:s,cameraState:c,onCameraStateChange:u,resolutionScale:f,canvas:l}=this.props,{worldviewContext:p}=this.state,h=c&&!u,d=f||1,m=l?null:t.createElement(t.Fragment,null,t.createElement("canvas",{style:{width:e,height:n,maxWidth:"100%",maxHeight:"100%"},width:e*d,height:n*d,ref:this._canvas,onMouseUp:this._onMouseUp,onMouseDown:this._onMouseDown,onDoubleClick:this._onDoubleClick,onMouseMove:this._onMouseMove}),r&&this._renderDebug());return t.createElement("div",{style:o({position:"relative",overflow:"hidden"},s)},h?m:t.createElement(Io,{cameraStore:p.cameraStore,keyMap:i,shiftKeys:a,ref:e=>this._cameraListener.current=e},m),p.initializedData&&t.createElement(No.Provider,{value:p},this.props.children))}}i(na,"defaultProps",{maxStackedObjectCount:100,backgroundColor:Jo,shiftKeys:!0,style:{},resolutionScale:1});const ra=t.forwardRef((e,n)=>t.createElement(Ko,null,({width:i,height:o,left:a,top:s})=>t.createElement(na,r({width:i,height:o,left:a,top:s,ref:n},e))));ra.displayName="Worldview";class ia{constructor(){i(this,"min",void 0),i(this,"max",void 0),this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER}update(e){this.min=Math.min(this.min,e),this.max=Math.max(this.max,e)}}const oa=[0,0,0,0,0,0,0,0,0];var aa=(e,t)=>n=>{const r=Float32Array.from([].concat(...e));if(t.some(e=>e.some(e=>e<0||e>=65536)))throw new Error("Element index out of bounds for Uint16");const i=Uint16Array.from([].concat(...t)),o=n.buffer({usage:"dynamic",data:[]}),a=Mi(n);return Ei({vert:"\n    precision mediump float;\n    attribute vec3 point;\n    attribute vec3 offset;\n    attribute vec4 color;\n    uniform mat4 projection, view;\n    uniform vec3 scale;\n    varying vec4 vColor;\n\n    #WITH_POSE\n\n    void main () {\n      vec3 p = applyPose(scale * point) + offset;\n      vColor = color;\n      gl_Position = projection * view * vec4(p, 1);\n    }\n    ",frag:"\n    precision mediump float;\n    varying vec4 vColor;\n    void main () {\n      gl_FragColor = vColor;\n    }",attributes:{point:r,color:(e,t)=>a(t.color,t.colors,t.points?t.points.length:1),offset:(e,t)=>{const n=Pi(t.points)?t.points.map(pi):t.points||[0,0,0];return{buffer:o({usage:"dynamic",data:n}),divisor:1}}},elements:i,depth:ji,blend:Si,uniforms:{scale:(e,t)=>Pi(t.scale)?pi(t.scale):t.scale},count:i.length,instances:(e,t)=>t.points?t.points.length:1})};async function sa(e){const t=new DataView(e);let n=0;function r(){const e=t.getUint32(n,!0);return n+=4,e}const i=r();if(1179937895!==i)throw new Error(`incorrect magic value 0x${i.toString(16)}`);const o=r();if(2!==o)throw new Error(`incorrect version ${o}`);const a=r();if(a!==t.byteLength)throw new Error(`length ${a} doesn't match response length ${t.byteLength}`);function s(e){do{const i=r();if(r()===e){const e=new DataView(t.buffer,n,i);return n+=i,e}n+=i}while(n<a)}const c=s(1313821514);if(!c)throw new Error("no JSON chunk found");const u=JSON.parse((new TextDecoder).decode(c)),f=s(5130562);if(!f)return{json:u};if(void 0!==u.buffers[0].uri)throw new Error("expected GLB-stored buffer");const l=u.accessors.map(e=>{let t,n;switch(e.componentType){case WebGLRenderingContext.BYTE:t=Int8Array;break;case WebGLRenderingContext.UNSIGNED_BYTE:t=Uint8Array;break;case WebGLRenderingContext.SHORT:t=Int16Array;break;case WebGLRenderingContext.UNSIGNED_SHORT:t=Uint16Array;break;case WebGLRenderingContext.UNSIGNED_INT:t=Uint32Array;break;case WebGLRenderingContext.FLOAT:t=Float32Array;break;default:throw new Error(`unrecognized componentType ${e.componentType}`)}switch(e.type){case"SCALAR":n=1;break;case"VEC2":n=2;break;case"VEC3":n=3;break;case"VEC4":case"MAT2":n=4;break;case"MAT3":n=9;break;case"MAT4":n=16;break;default:throw new Error(`unrecognized type ${e.type}`)}const r=u.bufferViews[e.bufferView];if(0!==r.buffer)throw new Error("only GLB-stored buffers are supported");if(r.byteLength%t.BYTES_PER_ELEMENT!=0)throw new Error("bufferView.byteLength mismatch");return new t(f.buffer,f.byteOffset+(r.byteOffset||0)+(e.byteOffset||0),e.count*n)}),p=u.images&&await Promise.all(u.images.map(e=>{const t=u.bufferViews[e.bufferView],n=new DataView(f.buffer,f.byteOffset+t.byteOffset,t.byteLength);return self.createImageBitmap(new Blob([n],{type:e.mimeType}))}));return{json:u,accessors:l,images:p}}var ca=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r&&!1!==t(e[n],n,e););return e};var ua=function(e,t,n,r){var i=!n;n||(n={});for(var o=-1,a=t.length;++o<a;){var s=t[o],c=r?r(n[s],e[s],s,n,e):void 0;void 0===c&&(c=e[s]),i?K(n,s,c):ar(n,s,c)}return n};var fa=function(e,t){return e&&ua(t,Ae(t),e)};var la=function(e,t){return e&&ua(t,dr(t),e)},pa=s(function(e,t){var n=t&&!t.nodeType&&t,r=n&&e&&!e.nodeType&&e,i=r&&r.exports===n?f.Buffer:void 0,o=i?i.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,r=o?o(n):new e.constructor(n);return e.copy(r),r}});var ha=function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t};var da=function(e,t){return ua(e,qt(e),t)};var ma=function(e,t){return ua(e,fr(e),t)},va=Object.prototype.hasOwnProperty;var ga=function(e){var t=e.length,n=new e.constructor(t);return t&&"string"==typeof e[0]&&va.call(e,"index")&&(n.index=e.index,n.input=e.input),n};var ba=function(e){var t=new e.constructor(e.byteLength);return new _t(t).set(new _t(e)),t};var ya=function(e,t){var n=t?ba(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)},xa=/\w*$/;var wa=function(e){var t=new e.constructor(e.source,xa.exec(e));return t.lastIndex=e.lastIndex,t},_a=l?l.prototype:void 0,Ca=_a?_a.valueOf:void 0;var Aa=function(e){return Ca?Object(Ca.call(e)):{}};var ja=function(e,t){var n=t?ba(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)},Sa="[object Boolean]",ka="[object Date]",Ea="[object Map]",Oa="[object Number]",Ma="[object RegExp]",Pa="[object Set]",Ta="[object String]",Da="[object Symbol]",za="[object ArrayBuffer]",Fa="[object DataView]",Ia="[object Float32Array]",Ba="[object Float64Array]",Ra="[object Int8Array]",La="[object Int16Array]",Ha="[object Int32Array]",Wa="[object Uint8Array]",Na="[object Uint8ClampedArray]",Ua="[object Uint16Array]",Ga="[object Uint32Array]";var Ka=function(e,t,n){var r=e.constructor;switch(t){case za:return ba(e);case Sa:case ka:return new r(+e);case Fa:return ya(e,n);case Ia:case Ba:case Ra:case La:case Ha:case Wa:case Na:case Ua:case Ga:return ja(e,n);case Ea:return new r;case Oa:case Ta:return new r(e);case Ma:return wa(e);case Pa:return new r;case Da:return Aa(e)}},Va=Object.create,qa=function(){function e(){}return function(t){if(!C(t))return{};if(Va)return Va(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();var $a=function(e){return"function"!=typeof e.constructor||be(e)?{}:qa(ur(e))},Ya="[object Map]";var Za=function(e){return $(e)&&un(e)==Ya},Xa=pe&&pe.isMap,Qa=Xa?le(Xa):Za,Ja="[object Set]";var es=function(e){return $(e)&&un(e)==Ja},ts=pe&&pe.isSet,ns=ts?le(ts):es,rs=1,is=2,os=4,as="[object Arguments]",ss="[object Function]",cs="[object GeneratorFunction]",us="[object Object]",fs={};fs[as]=fs["[object Array]"]=fs["[object ArrayBuffer]"]=fs["[object DataView]"]=fs["[object Boolean]"]=fs["[object Date]"]=fs["[object Float32Array]"]=fs["[object Float64Array]"]=fs["[object Int8Array]"]=fs["[object Int16Array]"]=fs["[object Int32Array]"]=fs["[object Map]"]=fs["[object Number]"]=fs[us]=fs["[object RegExp]"]=fs["[object Set]"]=fs["[object String]"]=fs["[object Symbol]"]=fs["[object Uint8Array]"]=fs["[object Uint8ClampedArray]"]=fs["[object Uint16Array]"]=fs["[object Uint32Array]"]=!0,fs["[object Error]"]=fs[ss]=fs["[object WeakMap]"]=!1;var ls=function e(t,n,r,i,o,a){var s,c=n&rs,u=n&is,f=n&os;if(r&&(s=o?r(t,i,o,a):r(t)),void 0!==s)return s;if(!C(t))return t;var l=te(t);if(l){if(s=ga(t),!c)return ha(t,s)}else{var p=un(t),h=p==ss||p==cs;if(re(t))return pa(t,c);if(p==us||p==as||h&&!o){if(s=u||h?{}:$a(t),!c)return u?ma(t,la(s,t)):da(t,fa(s,t))}else{if(!fs[p])return o?t:{};s=Ka(t,p,c)}}a||(a=new lt);var d=a.get(t);if(d)return d;if(a.set(t,s),ns(t))return t.forEach(function(i){s.add(e(i,n,r,i,t,a))}),s;if(Qa(t))return t.forEach(function(i,o){s.set(o,e(i,n,r,o,t,a))}),s;var m=f?u?mr:$t:u?keysIn:Ae,v=l?void 0:m(t);return ca(v||t,function(i,o){v&&(i=t[o=i]),ar(s,o,e(i,n,r,o,t,a))}),s};var ps=function(e,t,n){var r=-1,i=e.length;t<0&&(t=-t>i?0:i+t),(n=n>i?i:n)<0&&(n+=i),i=t>n?0:n-t>>>0,t>>>=0;for(var o=Array(i);++r<i;)o[r]=e[r+t];return o};var hs=function(e,t){return t.length<2?e:Kn(e,ps(t,0,-1))};var ds=function(e,t){return t=Nn(t,e),null==(e=hs(e,t))||delete e[Gn($o(t))]},ms="[object Object]",vs=Function.prototype,gs=Object.prototype,bs=vs.toString,ys=gs.hasOwnProperty,xs=bs.call(Object);var ws=function(e){if(!$(e)||_(e)!=ms)return!1;var t=ur(e);if(null===t)return!0;var n=ys.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&bs.call(n)==xs};var _s=function(e){return ws(e)?void 0:e},Cs=l?l.isConcatSpreadable:void 0;var As=function(e){return te(e)||ee(e)||!!(Cs&&e&&e[Cs])};var js=function e(t,n,r,i,o){var a=-1,s=t.length;for(r||(r=As),o||(o=[]);++a<s;){var c=t[a];n>0&&r(c)?n>1?e(c,n-1,r,i,o):Wt(o,c):i||(o[o.length]=c)}return o};var Ss=function(e){return null!=e&&e.length?js(e,1):[]};var ks=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)},Es=Math.max;var Os=function(e,t,n){return t=Es(void 0===t?e.length-1:t,0),function(){for(var r=arguments,i=-1,o=Es(r.length-t,0),a=Array(o);++i<o;)a[i]=r[t+i];i=-1;for(var s=Array(t+1);++i<t;)s[i]=r[i];return s[t]=n(a),ks(e,this,s)}};var Ms=function(e){return function(){return e}},Ps=G?function(e,t){return G(e,"toString",{configurable:!0,enumerable:!1,value:Ms(t),writable:!0})}:Jn,Ts=800,Ds=16,zs=Date.now;var Fs=function(e){var t=0,n=0;return function(){var r=zs(),i=Ds-(r-n);if(n=r,i>0){if(++t>=Ts)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}(Ps);var Is=function(e){return Fs(Os(e,void 0,Ss),e+"")}(function(e,t){var n={};if(null==e)return n;var r=!1;t=In(t,function(t){return t=Nn(t,e),r||(r=t.length>1),t}),ua(e,mr(e),n),r&&(n=ls(n,7,_s));for(var i=t.length;i--;)ds(n,t[i]);return n});function Bs(e,t,n,r=!1){const i=r?e.originalMarker:e;if(n.some(({object:e})=>e===i))return null;const a=o({},e),[s]=t(i,1);return a.color=s,a.colors&&a.points&&a.points.length&&(a.colors=new Array(a.points.length).fill(s)),a}const Rs=(e,t,n)=>Array.isArray(e)?e.map(e=>Bs(e,t,n)).filter(Boolean):Bs(e,t,n),Ls=(e,t,n)=>Array.isArray(e)?e.map(e=>Bs(e,t,n,!0)).filter(Boolean):Bs(e,t,n,!0);function Hs(e,t,n,r){const i=n.filter(({object:t,instanceIndex:n})=>t===e),a=i.map(({object:e,instanceIndex:t})=>t).filter(e=>"number"==typeof e),s=o({},e),c=s.points&&Math.ceil(s.points.length/r)||1,u=t(e,c),f=u[0];if(s.points&&s.points.length){const e=new Array(s.points.length).fill().map(()=>f);for(let t=0;t<c;t++)for(let n=0;n<r;n++){const i=t*r+n;i<e.length&&(e[i]=u[t])}if(s.colors=e,a.length)s.points=s.points.filter((e,t)=>!a.includes(Math.floor(t/r))),s.colors=s.colors.filter((e,t)=>!a.includes(Math.floor(t/r)));else if(i.length)return null}else if(s.color=f,i.length)return null;return s}const Ws=e=>(t,n,r)=>Array.isArray(t)?t.map(t=>Hs(t,n,r,e)).filter(Boolean):Hs(t,n,r,e),Ns=e=>t=>{const n=e(t),r=Pn(e=>{const{depth:r,blend:i}=e;return t(o({},n,{depth:r,blend:i}))},(...e)=>JSON.stringify(e)),i=e=>{var t,i;const o=e.depth||(null===(t=e.originalMarker)||void 0===t?void 0:t.depth)||n.depth||Ai,a=e.blend||(null===(i=e.originalMarker)||void 0===i?void 0:i.blend)||n.blend||Ci;r({depth:o,blend:a})(e)};return e=>{Array.isArray(e)?e.forEach(i):i(e)}};function Us(e,t){const n=[[0,0,.5],[0,0,-.5]],r=[],i=[];for(let o=0;o<e;o++){const a=2*Math.PI*o/e,s=.5*Math.cos(a),c=.5*Math.sin(a);n.push([s,c,.5],[s,c,-.5]);const u=n.length-1,f=t?0:o+1===e?2:n.length,l=o+1===e?3:n.length+1;if(r.push([u,f,l]),i.push([u,l,1]),!t){const e=n.length-2;r.push([e,u,f]),i.push([e,f,0])}}return{points:n,sideFaces:r,endCapFaces:i}}const{points:Gs,sideFaces:Ks,endCapFaces:Vs}=Us(30,!1),qs=Ns(aa(Gs,Ks.concat(Vs))),$s=Ws(1);function Ys(e){return t.createElement(Uo,r({getChildrenForHitmap:$s},e,{reglCommand:qs}))}const{points:Zs,sideFaces:Xs,endCapFaces:Qs}=Us(30,!0),Js=Ns(aa(Zs,Xs.concat(Qs))),ec=Ws(1);function tc(e){return t.createElement(Uo,r({getChildrenForHitmap:ec},e,{reglCommand:Js}))}const nc=Object.freeze([0,0,1]),rc=e=>{const t=[],n=[];for(const r of e){let e,i,o,a,s,c,u,f,l;if(r.points&&2===r.points.length){const[t,n]=r.points;u=[t.x,t.y,t.z];const p=[n.x,n.y,n.z],h=Fr(u,p);Br(l=Dr([0,0,0],p,u),l),f=ni([0,0,0,0],nc,l),a=s=r.scale.y,c=r.scale.z||.3*h,e=i=r.scale.x,o=h-c}else u=pi(r.pose.position),Vr(f=hi(r.pose.orientation),f,Math.PI/2),l=Wr([0,0,0],nc,f),e=r.scale.y||1,i=r.scale.z||1,a=2*e,s=2*i,c=.23*(r.scale.x||1),o=.77*(r.scale.x||1);const p=zr([0,0,0],u,l,o/2),h=zr([0,0,0],u,l,o+c/2);t.push({originalMarker:r,scale:{x:e,y:i,z:o},color:r.color,pose:{position:di(p),orientation:mi(f)}}),n.push({originalMarker:r,scale:{x:a,y:s,z:c},color:r.color,pose:{position:di(h),orientation:mi(f)}})}return{cones:n,cylinders:t}};var ic=t.memo(function(e){const i=Is(e,"children"),{cylinders:o,cones:a}=rc(e.children);return n.createElement(t.Fragment,null,n.createElement(Ys,r({getChildrenForHitmap:Ls},i),o),n.createElement(tc,r({getChildrenForHitmap:Ls},i),a))});const oc=Float32Array.BYTES_PER_ELEMENT,ac=3*oc,sc=[1,1,1,.2],cc={BL:0,TR:1,BR:2,TL:3},uc=Object.keys(cc).length,fc=`\nprecision mediump float;\n\nattribute float pointType;\n\n// per-instance attributes\nattribute vec4 colorB;\nattribute vec4 colorC;\nattribute vec3 positionA;\nattribute vec3 positionB;\nattribute vec3 positionC;\nattribute vec3 positionD;\n// per-instance pose attributes\nattribute vec3 posePosition;\nattribute vec4 poseRotation;\n\nuniform mat4 projection, view;\nuniform float viewportWidth;\nuniform float viewportHeight;\nuniform float alpha;\nuniform float thickness;\nuniform bool joined;\nuniform bool scaleInvariant;\n\nvarying vec4 vColor;\n\n${Object.keys(cc).map(e=>`const float POINT_${e} = ${cc[e]}.0;`).join("\n")}\n\n#WITH_POSE\n\nvec3 applyPoseInstance(vec3 point, vec4 rotation, vec3 position) {\n  // rotate the point and then add the position of the pose\n  // this function is defined in WITH_POSE\n  return rotate(point, rotation) + position;\n}\n\nvec2 rotateCCW(vec2 v) {\n  return vec2(-v.y, v.x);\n}\n\nvec2 normalizeOrZero(vec2 v) {\n  return length(v) < 0.00001 ? vec2(0, 0) : normalize(v);\n}\n\nvoid setPosition(vec4 proj, vec2 offset) {\n  gl_Position = proj;\n\n  offset *= thickness / 2.;\n\n  if (scaleInvariant) {\n    // The given thickness is a number of pixels on screen. Divide x by width/2 and\n    // y by height/2 so that they correspond to pixel distances when scaled from clip space to NDC.\n    offset.x /= viewportWidth / 2.0;\n    offset.y /= viewportHeight / 2.0;\n    // Compensate for automatic division by w\n    offset *= proj.w;\n  } else {\n    // The line thickness should be scaled the same way the camera scales other distances.\n    // projection[0].xyz is the result of projecting a unit x-vector, so its length represents\n    // how much distances are scaled by the camera projection.\n    offset *= length(projection[0].xyz);\n    offset.y *= viewportWidth / viewportHeight;\n  }\n\n  gl_Position.xy += offset;\n}\n\nvoid main () {\n  bool isStart = positionA == positionB;\n  bool isEnd = positionC == positionD;\n  bool isLeft = (pointType == POINT_TL || pointType == POINT_BL);\n  bool isTop = (pointType == POINT_TL || pointType == POINT_TR);\n  bool isEndpoint = isLeft ? isStart : isEnd;\n\n  float scale = isTop ? 1. : -1.;\n\n  mat4 projView = projection * view;\n  vec4 projA = projView * vec4(applyPose(applyPoseInstance(positionA, poseRotation, posePosition)), 1);\n  vec4 projB = projView * vec4(applyPose(applyPoseInstance(positionB, poseRotation, posePosition)), 1);\n  vec4 projC = projView * vec4(applyPose(applyPoseInstance(positionC, poseRotation, posePosition)), 1);\n  vec4 projD = projView * vec4(applyPose(applyPoseInstance(positionD, poseRotation, posePosition)), 1);\n\n  vec2 aspectVec = vec2(viewportWidth / viewportHeight, 1.0);\n  vec2 screenA = projA.xy / projA.w * aspectVec;\n  vec2 screenB = projB.xy / projB.w * aspectVec;\n  vec2 screenC = projC.xy / projC.w * aspectVec;\n  vec2 screenD = projD.xy / projD.w * aspectVec;\n\n  vec2 dirAB = normalizeOrZero(screenB - screenA);\n  vec2 dirBC = normalizeOrZero(screenC - screenB);\n  vec2 dirCD = normalizeOrZero(screenD - screenC);\n\n  vec2 perpAB = rotateCCW(dirAB); // vector perpendicular to AB\n  vec2 perpBC = rotateCCW(dirBC); // vector perpendicular to BC\n\n  vColor = isLeft ? colorB : colorC;\n  vColor.a *= alpha;\n\n  vec4 proj = isLeft ? projB : projC;\n\n  // simple case: non-joined line list\n  if (!joined || isEndpoint) {\n    setPosition(proj, scale * perpBC);\n    return;\n  }\n\n  // clamp to prevent rounding errors from breaking the sqrt()s below\n  float cosB = clamp(-dot(dirAB, dirBC), -1., 1.);\n  float cosC = clamp(-dot(dirBC, dirCD), -1., 1.);\n\n  bool tooSharpB = cosB > 0.01;\n  bool tooSharpC = cosC > 0.01;\n  bool tooSharp = isLeft ? tooSharpB : tooSharpC;\n\n  bool turningRightB = dot(dirAB, rotateCCW(dirBC)) > 0.;\n  bool turningRightC = dot(dirBC, rotateCCW(dirCD)) > 0.;\n  bool turningRight = isLeft ? turningRightB : turningRightC;\n\n  if (tooSharp) {\n    // "fold join"\n    vec2 perp = isLeft ? perpAB : perpBC;\n    vec2 dir = isLeft ? dirAB : dirBC;\n    float scalePerp = isLeft ? -1. : 1.;\n    float scaleDir = (turningRight == isLeft) ? 1. : -1.;\n    float tanHalfB = sqrt((1. - cosB) / (1. + cosB));\n    float tanHalfC = sqrt((1. - cosC) / (1. + cosC));\n    float tanHalf = isLeft ? tanHalfB : tanHalfC;\n    setPosition(proj, scale * (scalePerp * perp + scaleDir * dir * tanHalf));\n  } else {\n    // miter join\n    vec2 bisectorB = rotateCCW(normalize(dirAB + dirBC)); // angle bisector of ABC\n    vec2 bisectorC = rotateCCW(normalize(dirBC + dirCD)); // angle bisector of BCD\n    vec2 bisector = isLeft ? bisectorB : bisectorC;\n    float sinHalfB = sqrt((1. - cosB) / 2.);\n    float sinHalfC = sqrt((1. - cosC) / 2.);\n    float sinHalf = isLeft ? sinHalfB : sinHalfC;\n    setPosition(proj, scale * bisector / sinHalf);\n  }\n}\n`;const lc=e=>{const t=e.buffer({type:"uint16",usage:"static",data:[cc.TL,cc.BL,cc.TR,cc.BR]}),n=e.buffer({type:"float",usage:"static",data:[[0,1,1,1],[1,0,0,1],[0,1,0,1],[1,0,1,1]]}),r=e.buffer({type:"float",usage:"static",data:Ss(new Array(uc).fill([0,0,0]))}),i=e.buffer({type:"float",usage:"static",data:Ss(new Array(uc).fill([0,0,0,1]))}),o=e.buffer({type:"float"}),a=e.buffer({type:"float"}),s=e.buffer({type:"float"}),c=e.buffer({type:"float"}),u=e.buffer({type:"float"}),f=e(Ei({vert:fc,frag:"\nprecision mediump float;\nvarying vec4 vColor;\nvoid main () {\n  gl_FragColor = vColor;\n}\n",blend:Si,uniforms:{thickness:e.prop("scale.x"),viewportWidth:e.context("viewportWidth"),viewportHeight:e.context("viewportHeight"),alpha:e.prop("alpha"),joined:e.prop("joined"),scaleInvariant:e.prop("scaleInvariant")},attributes:{pointType:t,colorB:(e,{joined:t,monochrome:r,debug:i})=>({buffer:i?n:o,offset:0,stride:4*(t||r||i?1:2)*oc,divisor:r||i?0:1}),colorC:(e,{joined:t,monochrome:r,debug:i})=>({buffer:i?n:o,offset:r||i?0:4*oc,stride:4*(t||r||i?1:2)*oc,divisor:r||i?0:1}),positionA:(e,{joined:t})=>({buffer:a,offset:0,stride:(t?1:2)*ac,divisor:1}),positionB:(e,{joined:t})=>({buffer:a,offset:ac,stride:(t?1:2)*ac,divisor:1}),positionC:(e,{joined:t})=>({buffer:s,offset:2*ac,stride:(t?1:2)*ac,divisor:1}),positionD:(e,{joined:t})=>({buffer:s,offset:3*ac,stride:(t?1:2)*ac,divisor:1}),posePosition:(e,{hasInstancedPoses:t})=>({buffer:t?c:r,divisor:t?1:0}),poseRotation:(e,{hasInstancedPoses:t})=>({buffer:t?u:i,divisor:t?1:0})},count:uc,instances:e.prop("instances"),primitive:e.prop("primitive")}));let l=new Float32Array(4*uc),p=new Float32Array(0),h=0,d=new Float32Array(0),m=new Float32Array(0);function v(e){return Pi(e)?e.map(gi):e}const g=Pn(t=>{const{depth:n=Ai,blend:r=Ci}=t;return e({depth:n,blend:r})},(...e)=>JSON.stringify(e)),b=(e,t)=>{const{debug:n}=e;n?g({depth:{enable:!1}})(t):g(e)(t)};function y(e){const{debug:t,primitive:n="lines",scaleInvariant:r=!1,depth:i,blend:g}=e,y=e.points.length;if(y<2)return;const x=y>2&&function(e,t){const[n,r,i]=Pi(e)?pi(e):e,[o,a,s]=Pi(t)?pi(t):t;return n===o&&r===a&&i===s}(e.points[0],e.points[y-1]),w=!x&&e.closed,_=function(e,t,n){const r=e.length+(n?3:2);h<r&&(p=new Float32Array(3*r),h=r),e.forEach((e,t)=>{const[n,r,i]=Pi(e)?pi(e):e,o=3+3*t;p[o+0]=n,p[o+1]=r,p[o+2]=i});const i=3*r;return t?(p.copyWithin(0,i-9,i-6),p.copyWithin(i-3,6,9)):n?(p.copyWithin(0,i-9,i-6),p.copyWithin(i-6,3,9)):(p.copyWithin(0,3,6),p.copyWithin(i-3,i-6,i-3)),p.subarray(0,i)}(e.points,x,w);a({data:_,usage:"dynamic"}),s({data:_,usage:"dynamic"});const C=!(e.colors&&e.colors.length),A=function(e,t,n,r){if(n){l.length<4*uc&&(l=new Float32Array(4*uc));const t=e||sc,[n]=v([t]),[r,i,o,a]=n;for(let e=0;e<uc;e++){const t=4*e;l[t+0]=r,l[t+1]=i,l[t+2]=o,l[t+3]=a}return l.subarray(0,4*uc)}if(t){const e=r?t.length+1:t.length;l.length<4*e&&(l=new Float32Array(4*e));const n=v(t);for(let e=0;e<n.length;e++){const t=4*e,[r,i,o,a]=n[e];l[t+0]=r,l[t+1]=i,l[t+2]=o,l[t+3]=a}if(r){const[t,r,i,o]=n[0],a=e-1;l[4*a+0]=t,l[4*a+1]=r,l[4*a+2]=i,l[4*a+3]=o}return l.subarray(0,4*e)}throw new Error("Impossible: !monochrome implies !!colors.")}(e.color,e.colors,C,w);o({data:A,usage:"dynamic"});const j="line strip"===n,S=y+(w?1:0),k=j?S-1:Math.floor(S/2),{poses:E}=e,O=!!E&&E.length>0;if(O&&E){if(k!==E.length)return void console.error(`Expected ${k} poses but given ${E.length} poses: will result in webgl error.`);const{positionData:e,rotationData:t}=function(e,t){d.length<3*e&&(d=new Float32Array(3*e),m=new Float32Array(4*e));for(let e=0;e<t.length;e++){const n=3*e,r=4*e,{position:i,orientation:o}=t[e],a=Array.isArray(i)?i:pi(i);d[n+0]=a[0],d[n+1]=a[1],d[n+2]=a[2];const s=Array.isArray(o)?o:[o.x,o.y,o.z,o.w];m[r+0]=s[0],m[r+1]=s[1],m[r+2]=s[2],m[r+3]=s[3]}return{positionData:d.subarray(0,3*e),rotationData:m.subarray(0,4*e)}}(k,E);c({data:e,usage:"dynamic"}),u({data:t,usage:"dynamic"})}b({debug:t,depth:i,blend:g},()=>{f(Object.assign({},e,{joined:j,primitive:"triangle strip",alpha:t?.2:1,monochrome:C,instances:k,scaleInvariant:r,hasInstancedPoses:O})),t&&f(Object.assign({},e,{joined:j,primitive:"line strip",alpha:1,monochrome:C,instances:k,scaleInvariant:r,hasInstancedPoses:O}))})}return e=>{Array.isArray(e)?e.forEach(y):y(e)}};function pc(e){return t.createElement(Uo,r({getChildrenForHitmap:Rs},e,{reglCommand:lc}))}const hc=e=>({x:e[0],y:e[1],z:e[2]}),dc=100,mc={orientation:{x:0,y:0,z:0,w:0},position:{x:0,y:0,z:0}};class vc extends n.Component{render(){return n.createElement(pc,null,this.props.children)}}i(vc,"defaultProps",{children:[{pose:mc,points:[[-dc,0,0],[dc,0,0]].map(hc),scale:{x:.5,y:.5,z:.5},color:{r:.95,g:.26,b:.4,a:1}},{pose:mc,points:[[0,-100,0],[0,100,0]].map(hc),scale:{x:.5,y:.5,z:.5},color:{r:.02,g:.82,b:.49,a:1}},{pose:mc,points:[[0,0,-100],[0,0,100]].map(hc),scale:{x:.5,y:.5,z:.5},color:{r:.11,g:.51,b:.92,a:1}}]});const gc=Ns(aa([[-.5,-.5,-.5],[-.5,.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,-.5,.5],[-.5,.5,.5],[.5,-.5,.5],[.5,.5,.5]],[[0,1,2],[1,2,3],[4,5,6],[5,6,7],[0,2,4],[2,4,6],[1,3,5],[3,5,7],[2,3,6],[3,6,7],[0,1,4],[1,4,5]])),bc=Ws(1);const yc=[[0,0,.5],[0,0,-.5]],xc=[];for(let e=0;e<15;e++){for(let t=0;t<15;t++){const n=(e+1)/16*Math.PI,r=.5*Math.cos(n),i=.5*Math.sin(n),o=2*t*Math.PI/15,a=i*Math.cos(o),s=i*Math.sin(o);if(yc.push([a,s,r]),t>0){const t=0===e?0:yc.length-1-15;xc.push([yc.length-2,yc.length-1,t]),e>0&&xc.push([yc.length-2,t-1,t])}}const t=0===e?0:yc.length-30;xc.push([yc.length-1,yc.length-15,t]),e>0&&xc.push([yc.length-1,yc.length-15-1,t])}for(let e=0;e<15;e++){const t=yc.length-15+e,n=0===e?yc.length-1:t-1;xc.push([t,n,1])}const wc=Ns(aa(yc,xc)),_c=Ws(1);function Cc(e){return t.createElement(Uo,r({getChildrenForHitmap:_c},e,{reglCommand:wc}))}function Ac(e,t){return{x:e.x*t,y:e.y*t,z:e.z*t}}const jc=[1,1,1,1],Sc=[.8,0,.8,1],kc=[1,.2,1,1],Ec="line strip",Oc={x:.1,y:.1,z:.1},Mc=Ac(Oc,1.3),Pc={x:.5,y:.5,z:.5},Tc=Ac(Pc,1.3),Dc={position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:0}};let zc=1;class Fc{constructor(e){i(this,"id",void 0),i(this,"point",void 0),i(this,"active",!1),this.id=zc++,this.point=e}}class Ic{constructor(e=""){i(this,"id",void 0),i(this,"name",void 0),i(this,"points",[]),i(this,"active",!1),this.name=e,this.id=zc++}}const Bc=(e,t,n)=>e.map(e=>{if(n.some(({object:t})=>t===e))return null;const r=o({},e),[i]=t(e.originalMarker,1);return r.scale=Pc,r.color=i,r.colors&&r.points&&r.points.length&&(r.colors=new Array(r.points.length).fill(i)),r}).filter(Boolean);class Rc extends n.Component{render(){const e=this.props.children,t=[];for(const n of e){const e=n.active?Sc:jc,r=n.points.map(({point:e})=>di(e));t.push({primitive:Ec,pose:Dc,points:r,scale:Oc,color:bi(e),originalMarker:n})}return n.createElement(pc,{getChildrenForHitmap:Bc},t)}}const Lc=(e,t,n)=>e.map(e=>{if(n.some(({object:t})=>t===e))return null;const r=o({},e);return r.colors=r.colors.map((n,r)=>t(e.originalMarkers[r],1)),r.scale=Tc,r}).filter(Boolean);class Hc extends n.Component{render(){const e=this.props.children,t=[],r=[],i=[];for(const n of e){const e=n.active?Sc:jc;for(const o of n.points){const n=di(o.point);t.push(n),r.push(o.active?kc:e),i.push(o)}}const o={points:t,colors:r,pose:Dc,scale:Mc,originalMarkers:i};return n.createElement(Cc,{getChildrenForHitmap:Lc},[o])}}function Wc(e,t,n,r,i,o,a){var s;i?(s=((o-e)*n+(a-t)*r)/i)<0?s=0:s>1&&(s=1):s=0;var c=o-(e+s*n),u=a-(t+s*r);return c*c+u*u}function Nc(e,t,n,r,i,o){var a=n-e,s=r-t;return Wc(e,t,a,s,a*a+s*s,i,o)}function Uc(e,t,n,r,i,o){return Math.sqrt(Nc(e,t,n,r,i,o))}Uc.squared=Nc,Uc.squaredWithPrecalc=Wc;var Gc=Uc;function Kc(e,t){const[n,r,i]=e.point,[o,a,s]=t.point;return n===o&&r===a&&i===s}function Vc(e){const{points:t}=e;for(let e=0;e<t.length-1;e++)if(Kc(t[e],t[e+1]))return!0;return Kc(t[0],t[t.length-1])}function qc(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var $c=Zc,Yc=Zc;function Zc(e,t,n){n=n||2;var r,i,o,a,s,c,u,f=t&&t.length,l=f?t[0]*n:e.length,p=Xc(e,0,l,n,!0),h=[];if(!p||p.next===p.prev)return h;if(f&&(p=function(e,t,n,r){var i,o,a,s,c,u=[];for(i=0,o=t.length;i<o;i++)a=t[i]*r,s=i<o-1?t[i+1]*r:e.length,(c=Xc(e,a,s,r,!1))===c.next&&(c.steiner=!0),u.push(su(c));for(u.sort(iu),i=0;i<u.length;i++)ou(u[i],n),n=Qc(n,n.next);return n}(e,t,p,n)),e.length>80*n){r=o=e[0],i=a=e[1];for(var d=n;d<l;d+=n)(s=e[d])<r&&(r=s),(c=e[d+1])<i&&(i=c),s>o&&(o=s),c>a&&(a=c);u=0!==(u=Math.max(o-r,a-i))?1/u:0}return Jc(p,h,n,r,i,u),h}function Xc(e,t,n,r,i){var o,a;if(i===bu(e,t,n,r)>0)for(o=t;o<n;o+=r)a=mu(o,e[o],e[o+1],a);else for(o=n-r;o>=t;o-=r)a=mu(o,e[o],e[o+1],a);return a&&lu(a,a.next)&&(vu(a),a=a.next),a}function Qc(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!lu(r,r.next)&&0!==fu(r.prev,r,r.next))r=r.next;else{if(vu(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function Jc(e,t,n,r,i,o,a){if(e){!a&&o&&function(e,t,n,r){var i=e;do{null===i.z&&(i.z=au(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,o,a,s,c,u=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,r=n,s=0,t=0;t<u&&(s++,r=r.nextZ);t++);for(c=u;s>0||c>0&&r;)0!==s&&(0===c||!r||n.z<=r.z)?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,c--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}o.nextZ=null,u*=2}while(a>1)}(i)}(e,r,i,o);for(var s,c,u=e;e.prev!==e.next;)if(s=e.prev,c=e.next,o?tu(e,r,i,o):eu(e))t.push(s.i/n),t.push(e.i/n),t.push(c.i/n),vu(e),e=c.next,u=c.next;else if((e=c)===u){a?1===a?Jc(e=nu(e,t,n),t,n,r,i,o,2):2===a&&ru(e,t,n,r,i,o):Jc(Qc(e),t,n,r,i,o,1);break}}}function eu(e){var t=e.prev,n=e,r=e.next;if(fu(t,n,r)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(cu(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&fu(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function tu(e,t,n,r){var i=e.prev,o=e,a=e.next;if(fu(i,o,a)>=0)return!1;for(var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,c=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,f=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,l=au(s,c,t,n,r),p=au(u,f,t,n,r),h=e.prevZ,d=e.nextZ;h&&h.z>=l&&d&&d.z<=p;){if(h!==e.prev&&h!==e.next&&cu(i.x,i.y,o.x,o.y,a.x,a.y,h.x,h.y)&&fu(h.prev,h,h.next)>=0)return!1;if(h=h.prevZ,d!==e.prev&&d!==e.next&&cu(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&fu(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;h&&h.z>=l;){if(h!==e.prev&&h!==e.next&&cu(i.x,i.y,o.x,o.y,a.x,a.y,h.x,h.y)&&fu(h.prev,h,h.next)>=0)return!1;h=h.prevZ}for(;d&&d.z<=p;){if(d!==e.prev&&d!==e.next&&cu(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&fu(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function nu(e,t,n){var r=e;do{var i=r.prev,o=r.next.next;!lu(i,o)&&pu(i,r,r.next,o)&&hu(i,o)&&hu(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),vu(r),vu(r.next),r=e=o),r=r.next}while(r!==e);return r}function ru(e,t,n,r,i,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&uu(a,s)){var c=du(a,s);return a=Qc(a,a.next),c=Qc(c,c.next),Jc(a,t,n,r,i,o),void Jc(c,t,n,r,i,o)}s=s.next}a=a.next}while(a!==e)}function iu(e,t){return e.x-t.x}function ou(e,t){if(t=function(e,t){var n,r=t,i=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&s>a){if(a=s,s===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===a)return n.prev;var c,u=n,f=n.x,l=n.y,p=1/0;r=n.next;for(;r!==u;)i>=r.x&&r.x>=f&&i!==r.x&&cu(o<l?i:a,o,f,l,o<l?a:i,o,r.x,r.y)&&((c=Math.abs(o-r.y)/(i-r.x))<p||c===p&&r.x>n.x)&&hu(r,e)&&(n=r,p=c),r=r.next;return n}(e,t)){var n=du(t,e);Qc(n,n.next)}}function au(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function su(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function cu(e,t,n,r,i,o,a,s){return(i-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(r-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(i-a)*(r-s)>=0}function uu(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&pu(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&hu(e,t)&&hu(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)}function fu(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function lu(e,t){return e.x===t.x&&e.y===t.y}function pu(e,t,n,r){return!!(lu(e,t)&&lu(n,r)||lu(e,r)&&lu(n,t))||fu(e,t,n)>0!=fu(e,t,r)>0&&fu(n,r,e)>0!=fu(n,r,t)>0}function hu(e,t){return fu(e.prev,e,e.next)<0?fu(e,t,e.next)>=0&&fu(e,e.prev,t)>=0:fu(e,t,e.prev)<0||fu(e,e.next,t)<0}function du(e,t){var n=new gu(e.i,e.x,e.y),r=new gu(t.i,t.x,t.y),i=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function mu(e,t,n,r){var i=new gu(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function vu(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function gu(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function bu(e,t,n,r){for(var i=0,o=t,a=n-r;o<n;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}Zc.deviation=function(e,t,n,r){var i=t&&t.length,o=i?t[0]*n:e.length,a=Math.abs(bu(e,0,o,n));if(i)for(var s=0,c=t.length;s<c;s++){var u=t[s]*n,f=s<c-1?t[s+1]*n:e.length;a-=Math.abs(bu(e,u,f,n))}var l=0;for(s=0;s<r.length;s+=3){var p=r[s]*n,h=r[s+1]*n,d=r[s+2]*n;l+=Math.abs((e[p]-e[d])*(e[h+1]-e[p+1])-(e[p]-e[h])*(e[d+1]-e[p+1]))}return 0===a&&0===l?0:Math.abs((l-a)/a)},Zc.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<t;a++)n.vertices.push(e[i][o][a]);i>0&&(r+=e[i-1].length,n.holes.push(r))}return n},$c.default=Yc;const yu=!0,xu=!1,wu=!0,_u=!0,Cu=e=>Ei({primitive:"triangles",vert:"\n  precision mediump float;\n\n  attribute vec3 point;\n\n  uniform mat4 projection, view;\n\n  #WITH_POSE\n\n  void main () {\n    vec3 pos = applyPose(point);\n    gl_Position = projection * view * vec4(pos, 1);\n  }\n  ",frag:"\n  precision mediump float;\n  uniform vec4 color;\n  void main () {\n    gl_FragColor = color;\n  }\n  ",attributes:{point:(e,t)=>Pi(t.points)?vi(t.points):t.points},uniforms:{color:(e,t)=>Pi(t.color)?gi(t.color):t.color},depth:{enable:(e,t)=>t.depth&&t.depth.enable||yu,mask:(e,t)=>t.depth&&t.depth.mask||xu},blend:Si,count:(e,t)=>t.points.length}),Au=e=>Ei({primitive:"triangles",vert:"\n  precision mediump float;\n\n  attribute vec3 point;\n  attribute vec4 color;\n\n  uniform mat4 projection, view;\n\n  varying vec4 vColor;\n\n  #WITH_POSE\n\n  void main () {\n    vec3 pos = applyPose(point);\n    vColor = color;\n    gl_Position = projection * view * vec4(pos, 1);\n  }\n  ",frag:"\n  precision mediump float;\n  varying vec4 vColor;\n  void main () {\n    gl_FragColor = vColor;\n  }\n  ",attributes:{point:(e,t)=>Pi(t.points)?vi(t.points):t.points,color:(e,t)=>{if(!t.colors||!t.colors.length)throw new Error('Invalid empty or null prop "colors" when rendering triangles using vertex colors');return Pi(t.colors)?Oi(t):t.colors}},depth:{enable:(e,t)=>t.depth&&t.depth.enable||wu,mask:(e,t)=>t.depth&&t.depth.mask||_u},blend:Si,count:(e,t)=>t.points.length}),ju=e=>{const t=Ns(Cu)(e),n=Ns(Au)(e);return(e,r)=>{const i=Array.isArray(e)?e:[e],o=[],a=[];i.forEach(e=>{!r&&e.onlyRenderInHitmap||(e.colors&&e.colors.length?a.push(e):o.push(e))}),t(o),n(a)}},Su=()=>ju,ku=Ws(3);function Eu(e){return t.createElement(Uo,r({getChildrenForHitmap:ku},e,{reglCommand:ju}))}const Ou={position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:0}},Mu={x:1,y:1,z:1};function Pu(e){const t=function(e){const t=new Float32Array(3*e.length);for(let n=0;n<e.length;n++){const[r,i,o]=e[n];t[3*n]=r,t[3*n+1]=i,t[3*n+2]=o}return t}(e),n=$c(t,null,3),r=[];for(let t=0;t<n.length;t++){const i=n[t];r.push(e[i])}return r}const Tu=e=>e.map(e=>{const t=Pi(e.points)?e.points.map(pi):e.points,n=e.pose?e.pose:Ou;return o({},e,{points:Pu(t),pose:n,scale:Mu,originalMarker:e})});var Du=Iu,zu=Iu,Fu=1e20;function Iu(e,t,n,r,i,o){this.fontSize=e||24,this.buffer=void 0===t?3:t,this.cutoff=r||.25,this.fontFamily=i||"sans-serif",this.fontWeight=o||"normal",this.radius=n||8;var a=this.size=this.fontSize+2*this.buffer;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.d=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Int16Array(a),this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function Bu(e,t,n,r,i,o,a){for(var s=0;s<t;s++){for(var c=0;c<n;c++)r[c]=e[c*t+s];for(Ru(r,i,o,a,n),c=0;c<n;c++)e[c*t+s]=i[c]}for(c=0;c<n;c++){for(s=0;s<t;s++)r[s]=e[c*t+s];for(Ru(r,i,o,a,t),s=0;s<t;s++)e[c*t+s]=Math.sqrt(i[s])}}function Ru(e,t,n,r,i){n[0]=0,r[0]=-Fu,r[1]=+Fu;for(var o=1,a=0;o<i;o++){for(var s=(e[o]+o*o-(e[n[a]]+n[a]*n[a]))/(2*o-2*n[a]);s<=r[a];)a--,s=(e[o]+o*o-(e[n[a]]+n[a]*n[a]))/(2*o-2*n[a]);n[++a]=o,r[a]=s,r[a+1]=+Fu}for(o=0,a=0;o<i;o++){for(;r[a+1]<o;)a++;t[o]=(o-n[a])*(o-n[a])+e[n[a]]}}Iu.prototype.draw=function(e){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.fillText(e,this.buffer,this.middle);for(var t=this.ctx.getImageData(0,0,this.size,this.size),n=new Uint8ClampedArray(this.size*this.size),r=0;r<this.size*this.size;r++){var i=t.data[4*r+3]/255;this.gridOuter[r]=1===i?0:0===i?Fu:Math.pow(Math.max(0,.5-i),2),this.gridInner[r]=1===i?Fu:0===i?0:Math.pow(Math.max(0,i-.5),2)}for(Bu(this.gridOuter,this.size,this.size,this.f,this.d,this.v,this.z),Bu(this.gridInner,this.size,this.size,this.f,this.d,this.v,this.z),r=0;r<this.size*this.size;r++){var o=this.gridOuter[r]-this.gridInner[r];n[r]=Math.max(0,Math.min(255,Math.round(255-255*(o/this.radius+this.cutoff))))}return n},Du.default=zu;var Lu=function(e,t,n,r){for(var i=e.length,o=n+(r?1:-1);r?o--:++o<i;)if(t(e[o],o,e))return o;return-1};var Hu=function(e){return e!=e};var Wu=function(e,t,n){for(var r=n-1,i=e.length;++r<i;)if(e[r]===t)return r;return-1};var Nu=function(e,t,n){return t==t?Wu(e,t,n):Lu(e,Hu,n)};var Uu=function(e,t){return!(null==e||!e.length)&&Nu(e,t,0)>-1};var Gu=function(e,t,n){for(var r=-1,i=null==e?0:e.length;++r<i;)if(n(t,e[r]))return!0;return!1},Ku=200;var Vu=function(e,t,n,r){var i=-1,o=Uu,a=!0,s=e.length,c=[],u=t.length;if(!s)return c;n&&(t=In(t,le(n))),r?(o=Gu,a=!1):t.length>=Ku&&(o=bt,a=!1,t=new vt(t));e:for(;++i<s;){var f=e[i],l=null==n?f:n(f);if(f=r||0!==f?f:0,a&&l==l){for(var p=u;p--;)if(t[p]===l)continue e;c.push(f)}else o(t,l,r)||c.push(f)}return c};var qu=function(e){return $(e)&&Ce(e)},$u=function(e,t){return Fs(Os(e,t,Jn),e+"")}(function(e,t){return qu(e)?Vu(e,js(t,1,qu,!0)):[]});function Yu(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function Zu(e,t){var n;void 0===t&&(t=Yu);var r,i=[],o=!1;return function(){for(var a=[],s=0;s<arguments.length;s++)a[s]=arguments[s];return o&&n===this&&t(a,i)?r:(r=e.apply(this,a),o=!0,n=this,i=a,r)}}const Xu="#ffffff",Qu="rgba(0,0,0,0.8)",Ju=128,ef={r:1,g:1,b:1,a:1},tf={r:0,g:0,b:0,a:.8};let nf=!1;function rf({r:e,g:t,b:n}){return 54.213*e+182.376*t+18.411*n<Ju}function of(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}class af{constructor(){i(this,"wrapper",document.createElement("span")),i(this,"_inner",document.createElement("span")),i(this,"_text",document.createTextNode("")),i(this,"_prevTextColor",ef),i(this,"_prevBgColor",tf),i(this,"_prevAutoBackgroundColor",null),function(){if(nf)return;const e=document.createElement("style");e.innerHTML="\n    .regl-worldview-text-wrapper {\n      position: absolute;\n      white-space: nowrap;\n      z-index: 100;\n      pointer-events: none;\n      top: 0;\n      left: 0;\n      will-change: transform;\n    }\n    .regl-worldview-text-inner {\n      position: relative;\n      left: -50%;\n      top: -0.5em;\n      white-space: pre-line;\n    }\n  ",document.body&&document.body.appendChild(e),nf=!0}(),this.wrapper.className="regl-worldview-text-wrapper",this._inner.className="regl-worldview-text-inner",this.wrapper.appendChild(this._inner),this._inner.appendChild(this._text),this.wrapper.style.color=xi(ef)}update(e,t,n,r){this.wrapper.style.transform=`translate(${t.toFixed()}px,${n.toFixed()}px)`;const{color:i,colors:o=[]}=e,a=o.length>=2,s=yi(a?o[0]:i||[0,0,0,1]);if(s){const e=yi(o[1]);if(of(this._prevTextColor,s)||(this._prevTextColor=s,this.wrapper.style.color=xi(s)),r||r===this._prevAutoBackgroundColor)if(r&&(!this._prevBgColor||this._prevBgColor&&!of(s,this._prevBgColor))){this._prevBgColor=s;const e=rf(s)?Xu:Qu;this._inner.style.background=e}else a&&this._prevBgColor&&!of(e,this._prevBgColor)&&(this._prevBgColor=e,this._inner.style.background=xi(e));else this._inner.style.background="transparent",this._prevBgColor=null}this._prevAutoBackgroundColor=r,this._text.textContent!==e.text&&(this._text.textContent=e.text||"")}}class sf extends n.Component{constructor(...e){super(...e),i(this,"_context",void 0),i(this,"_textComponents",new Map),i(this,"_textContainerRef",n.createRef()),i(this,"componentWillUnmount",()=>{this._context&&this._context.unregisterPaintCallback(this.paint)}),i(this,"paint",()=>{const e=this._context,t=this._textComponents,{children:n,autoBackgroundColor:r}=this.props,{current:i}=this._textContainerRef,o=e&&e.initializedData;if(!i||!e||!o)return;const{dimension:a,dimension:{width:s,height:c}}=e,{camera:u}=o,f=new Set(t.keys());for(const e of n){const{pose:n,name:o}=e,{position:l}=n,p=this.project(l,u,a);if(!p)continue;const[h,d]=p;if(h<-10||d<-10||h>s+10||d>c+10)continue;let m=t.get(o||e);m?f.delete(o||e):(m=new af,t.set(o||e,m),i.appendChild(m.wrapper)),m.update(e,h,d,r)}for(const e of f){const n=t.get(e);n&&(n.wrapper.remove(),t.delete(e))}}),i(this,"project",(e,t,n)=>{const r=[e.x,e.y,e.z],{left:i,top:o,width:a,height:s}=n,c=[i,o,a,s];return t.toScreenCoord(c,r)})}componentDidMount(){this._context&&this._context.registerPaintCallback(this.paint)}render(){return n.createElement(n.Fragment,null,n.createElement("div",{ref:this._textContainerRef}),n.createElement(No.Consumer,null,e=>(e&&(this._context=e),null)))}}i(sf,"defaultProps",{children:[]});const cf=.25,uf=10,ff=Object.freeze({r:1,g:1,b:1,a:1}),lf=Object.freeze({r:0,g:0,b:0,a:1}),pf=Zu(e=>{const t=document.createElement("canvas").getContext("2d");return t.font=e,t}),hf=e=>{const{x:t,y:n,z:r}=e.pose.position;return`x${t}y${n}z${r}`},df=(e,t)=>e.get(hf(t))||0,mf=(e,t,n)=>{e.set(hf(t),n)},vf=()=>Zu((e,t,n,r)=>{const i=new Du(n,uf,8,cf,"sans-serif","normal"),o=pf(`${n}px sans-serif`);let a=0;const s=n+2*uf,c={};let u=0,f=0;for(const t of e){const e=o.measureText(t).width,n=Math.ceil(e)+2*uf;u+n>r&&(u=0,f+=s),c[t]={x:u,y:f,width:e},u+=n,a=Math.max(a,u)}const l=f+s,p=new Uint8Array(a*l);for(const t of e){const{x:e,y:n}=c[t],r=i.draw(t);for(let t=0;t<i.size;t++)for(let o=0;o<i.size;o++)e+o<a&&(p[a*(n+t)+e+o]=r[t*i.size+o])}return{charInfo:c,textureWidth:a,textureHeight:l,textureData:p}}),gf=()=>Zu((e,t)=>{t({data:e.textureData,width:e.textureWidth,height:e.textureHeight,format:"alpha",wrap:"clamp",mag:"linear",min:"linear"})}),bf="\n  precision mediump float;\n\n  uniform mat4 projection, view, billboardRotation;\n  uniform float fontSize;\n  uniform vec2 atlasSize;\n  uniform bool scaleInvariant;\n  uniform float scaleInvariantSize;\n  uniform float viewportHeight;\n  uniform float viewportWidth;\n  uniform bool isPerspective;\n  uniform float cameraFovY;\n\n  // per-vertex attributes\n  attribute vec2 texCoord;\n  attribute vec2 position;\n\n  // per-instance (character) attributes\n  attribute vec2 srcOffset;\n  attribute float srcWidth;\n  attribute vec2 destOffset;\n\n  // per-marker attributes\n  attribute vec3 scale;\n  attribute float billboard;\n  attribute vec2 alignmentOffset;\n  attribute float enableBackground;\n  attribute float enableHighlight;\n  attribute vec4 foregroundColor;\n  attribute vec4 backgroundColor;\n  attribute vec4 highlightColor;\n  attribute vec3 posePosition;\n  attribute vec4 poseOrientation;\n\n  varying vec2 vTexCoord;\n  varying float vEnableBackground;\n  varying vec4 vForegroundColor;\n  varying vec4 vBackgroundColor;\n  varying vec4 vHighlightColor;\n  varying float vEnableHighlight;\n  varying float vBillboard;\n\n  // rotate a 3d point v by a rotation quaternion q\n  // like applyPose(), but we need to use a custom per-instance pose\n  vec3 rotate(vec3 v, vec4 q) {\n    vec3 temp = cross(q.xyz, v) + q.w * v;\n    return v + (2.0 * cross(q.xyz, temp));\n  }\n\n  vec4 computeVertexPosition(vec3 markerPos) {\n    vec3 pos;\n    if (billboard == 1.0) {\n      pos = (billboardRotation * vec4(markerPos, 1.0)).xyz + posePosition;\n    } else {\n      pos = rotate(markerPos, poseOrientation) + posePosition;\n    }\n    return projection * view * vec4(pos, 1.0);\n  }\n\n  void main () {\n    // Scale invariance only works for billboards\n    bool scaleInvariantEnabled = scaleInvariant && billboard == 1.0;\n\n    vec2 srcSize = vec2(srcWidth, fontSize);\n    vec3 markerSpacePos = vec3((destOffset + position * srcSize + alignmentOffset) / fontSize, 0);\n\n    if (!scaleInvariantEnabled) {\n      // Apply marker scale only when scale invariance is disabled\n      markerSpacePos *= scale;\n    } else {\n      // If scale invariance is enabled, the text will be rendered at a constant\n      // scale regardless of the zoom level.\n      // The given scaleInvariantSize is in pixels. We need to scale it based on\n      // the current canvas resolution to get the proper dimensions later in NDC\n      float scaleInvariantFactor = scaleInvariantSize / viewportHeight;\n      if (isPerspective) {\n        // When using a perspective projection, the effect is achieved by using\n        // the w-component for scaling, which is obtained by first projecting\n        // the marker position into clip space.\n        gl_Position = computeVertexPosition(markerSpacePos);\n        scaleInvariantFactor *= gl_Position.w;\n        // We also need to take into account the camera's half vertical FOV\n        scaleInvariantFactor *= cameraFovY;\n      } else {\n        // Compute inverse aspect ratio\n        float invAspect = viewportHeight / viewportWidth;\n        // When using orthographic projection, the scaling factor is obtain from\n        // the camera projection itself.\n        // We also need applied the inverse aspect ratio\n        scaleInvariantFactor *= 2.0 * invAspect / length(projection[0].xyz);\n      }\n      // Apply scale invariant factor\n      markerSpacePos *= scaleInvariantFactor;\n    }\n\n    // Compute final vertex position\n    gl_Position = computeVertexPosition(markerSpacePos);\n\n    vTexCoord = (srcOffset + texCoord * srcSize) / atlasSize;\n    vEnableBackground = enableBackground;\n    vForegroundColor = foregroundColor;\n    vBackgroundColor = backgroundColor;\n    vHighlightColor = highlightColor;\n    vEnableHighlight = enableHighlight;\n    vBillboard = billboard;\n  }\n",yf='\n  #extension GL_OES_standard_derivatives : enable\n  precision mediump float;\n  uniform mat4 projection;\n  uniform sampler2D atlas;\n  uniform float cutoff;\n  uniform bool scaleInvariant;\n  uniform float scaleInvariantSize;\n  uniform bool isHitmap;\n\n  varying vec2 vTexCoord;\n  varying float vEnableBackground;\n  varying vec4 vForegroundColor;\n  varying vec4 vBackgroundColor;\n  varying vec4 vHighlightColor;\n  varying float vEnableHighlight;\n  varying float vBillboard;\n\n  void main() {\n    float dist = texture2D(atlas, vTexCoord).a;\n\n    // fwidth(dist) is used to provide some anti-aliasing. However it\'s currently only used\n    // when the solid background is enabled, because the alpha blending and\n    // depth test don\'t work together nicely for partially-transparent pixels.\n    float edgeStep = smoothstep(1.0 - cutoff - fwidth(dist), 1.0 - cutoff, dist);\n\n    if (scaleInvariant && vBillboard == 1.0 && scaleInvariantSize <= 20.0) {\n      // If scale invariant is enabled and scaleInvariantSize is "too small", do not interpolate\n      // the raw distance value since at such small scale, the SDF approach causes some\n      // visual artifacts.\n      // The value used for checking if scaleInvariantSize is "too small" is arbitrary and\n      // was defined after some experimentation.\n      edgeStep = dist;\n    }\n\n    if (isHitmap) {\n      // When rendering for the hitmap buffer, we draw flat polygons using the foreground color\n      // instead of the actual glyphs. This way we increase the selection range and provide a\n      // better user experience.\n      gl_FragColor = vForegroundColor;\n    } else if (vEnableHighlight > 0.5) {\n      gl_FragColor = mix(vHighlightColor, vec4(0, 0, 0, 1), edgeStep);\n    } else if (vEnableBackground > 0.5) {\n      gl_FragColor = mix(vBackgroundColor, vForegroundColor, edgeStep);\n    } else {\n      gl_FragColor = vForegroundColor;\n      gl_FragColor.a *= edgeStep;\n    }\n\n    if (gl_FragColor.a == 0.) {\n      discard;\n    }\n  }\n';const xf=e=>{var t;const n=function(e){const t=new Set(e||[]),n=vf(),r=gf(),i=e=>{const o=e.texture(),a=e({depth:{enable:(e,t)=>!t.scaleInvariant&&ji.enable(e,t),mask:(e,t)=>!t.scaleInvariant&&ji.mask(e,t)},blend:Si,primitive:"triangle strip",vert:bf,frag:yf,uniforms:{atlas:o,atlasSize:()=>[o.width,o.height],fontSize:e.prop("resolution"),cutoff:cf,scaleInvariant:e.prop("scaleInvariant"),scaleInvariantSize:e.prop("scaleInvariantSize"),isHitmap:e.prop("isHitmap"),viewportHeight:e.context("viewportHeight"),viewportWidth:e.context("viewportWidth"),isPerspective:e.context("isPerspective"),cameraFovY:e.context("fovy")},instances:e.prop("instances"),count:4,attributes:{position:[[0,0],[0,-1],[1,0],[1,-1]],texCoord:[[0,0],[0,1],[1,0],[1,1]],srcOffset:(e,t)=>({buffer:t.srcOffsets,divisor:1}),destOffset:(e,t)=>({buffer:t.destOffsets,divisor:1}),srcWidth:(e,t)=>({buffer:t.srcWidths,divisor:1}),scale:(e,t)=>({buffer:t.scale,divisor:1}),alignmentOffset:(e,t)=>({buffer:t.alignmentOffset,divisor:1}),billboard:(e,t)=>({buffer:t.billboard,divisor:1}),foregroundColor:(e,t)=>({buffer:t.foregroundColor,divisor:1}),backgroundColor:(e,t)=>({buffer:t.backgroundColor,divisor:1}),highlightColor:(e,t)=>({buffer:t.highlightColor,divisor:1}),enableBackground:(e,t)=>({buffer:t.enableBackground,divisor:1}),enableHighlight:(e,t)=>({buffer:t.enableHighlight,divisor:1}),posePosition:(e,t)=>({buffer:t.posePosition,divisor:1}),poseOrientation:(e,t)=>({buffer:t.poseOrientation,divisor:1})}});return(s,c)=>{let u=0;for(const e of s){const{text:n}=e;if("string"!=typeof n)throw new Error(`Expected typeof 'text' to be a string. But got type '${typeof n}' instead.`);for(const e of n)++u,t.add(e)}let f=i.textAtlas;const l=f?Object.keys(f.charInfo):[],p=Array.from(t),h=0===$u(p,l).length;if(!f||!h){const r=e.limits.maxTextureSize||2048;f=n(t,t.size,i.resolution,r)}r(f,o);const d=new Float32Array(2*u),m=new Float32Array(u),v=new Float32Array(2*u),g=new Float32Array(2*u),b=new Float32Array(3*u),y=new Float32Array(4*u),x=new Float32Array(4*u),w=new Float32Array(4*u),_=new Float32Array(u),C=new Float32Array(u),A=new Float32Array(3*u),j=new Float32Array(4*u),S=new Float32Array(u);let k=0;const E=new Map;for(const e of s){var O,M,P;let t=0,n=0,r=df(E,e),o=0,a=1;const s=yi(c?e.color||[0,0,0,1]:(null===(O=e.colors)||void 0===O?void 0:O[0])||e.color||ff),u=null!=(null===(M=e.colors)||void 0===M?void 0:M[1])||i.autoBackgroundColor,l=yi((null===(P=e.colors)||void 0===P?void 0:P[1])||(i.autoBackgroundColor&&rf(s)?ff:lf)),p=(null==e?void 0:e.highlightColor)||{r:1,b:0,g:1,a:1};for(let c=0;c<e.text.length;c++){var T;const h=e.text[c];if("\n"===h){n=0,r+=i.resolution,a++;continue}const g=f.charInfo[h],E=k+o;d[2*E+0]=n,d[2*E+1]=-r,v[2*E+0]=g.x+uf,v[2*E+1]=g.y+uf+.05*i.resolution,m[E]=g.width,n+=g.width,t=Math.max(t,n),C[E]=null===(T=e.billboard)||void 0===T||T?1:0,b[3*E+0]=e.scale.x,b[3*E+1]=e.scale.y,b[3*E+2]=e.scale.z,A[3*E+0]=e.pose.position.x,A[3*E+1]=e.pose.position.y,A[3*E+2]=e.pose.position.z,j[4*E+0]=e.pose.orientation.x,j[4*E+1]=e.pose.orientation.y,j[4*E+2]=e.pose.orientation.z,j[4*E+3]=e.pose.orientation.w,y[4*E+0]=s.r,y[4*E+1]=s.g,y[4*E+2]=s.b,y[4*E+3]=s.a,x[4*E+0]=l.r,x[4*E+1]=l.g,x[4*E+2]=l.b,x[4*E+3]=l.a,w[4*E+0]=p.r,w[4*E+1]=p.g,w[4*E+2]=p.b,w[4*E+3]=p.a,S[E]=e.highlightedIndices&&e.highlightedIndices.includes(c)?1:0,_[E]=u?1:0,++o}const h=r+i.resolution;for(let e=0;e<o;e++)g[2*(k+e)+0]=-t/2,g[2*(k+e)+1]=h/2;mf(E,e,h+a*i.resolution),k+=o}a({instances:k,isHitmap:!!c,scaleInvariant:i.scaleInvariant,resolution:i.resolution,scaleInvariantSize:i.scaleInvariantSize,srcOffsets:v,destOffsets:d,srcWidths:m,alignmentOffset:g,billboard:C,enableBackground:_,enableHighlight:S,foregroundColor:y,backgroundColor:x,highlightColor:w,poseOrientation:j,posePosition:A,scale:b})}};return i.autoBackgroundColor=!1,i}(e.alphabet);return n.autoBackgroundColor=e.autoBackgroundColor,n.resolution=Math.max(40,e.resolution||160),n.scaleInvariant=null!=e.scaleInvariantFontSize,n.scaleInvariantSize=null!==(t=e.scaleInvariantFontSize)&&void 0!==t?t:0,n.textAtlas=e.textAtlas,n};function wf(e){return"object"!=typeof e&&"function"!=typeof e||null===e}function _f(){this.childBranches=new WeakMap,this.primitiveKeys=new Map,this.hasValue=!1,this.value=void 0}_f.prototype.has=function(e){var t=wf(e)?this.primitiveKeys.get(e):e;return!!t&&this.childBranches.has(t)},_f.prototype.get=function(e){var t=wf(e)?this.primitiveKeys.get(e):e;return t?this.childBranches.get(t):void 0},_f.prototype.resolveBranch=function(e){if(this.has(e))return this.get(e);var t=new _f,n=this.createKey(e);return this.childBranches.set(n,t),t},_f.prototype.setValue=function(e){return this.hasValue=!0,this.value=e},_f.prototype.createKey=function(e){if(wf(e)){var t={};return this.primitiveKeys.set(e,t),t}return e},_f.prototype.clear=function(){if(0===arguments.length)this.childBranches=new WeakMap,this.primitiveKeys.clear(),this.hasValue=!1,this.value=void 0;else if(1===arguments.length){var e=arguments[0];if(wf(e)){var t=this.primitiveKeys.get(e);t&&(this.childBranches.delete(t),this.primitiveKeys.delete(e))}else this.childBranches.delete(e)}else{var n=arguments[0];if(this.has(n)){var r=this.get(n);r.clear.apply(r,Array.prototype.slice.call(arguments,1))}}};var Cf=function(e){var t=new _f;function n(){var n=Array.prototype.slice.call(arguments),r=n.reduce(function(e,t){return e.resolveBranch(t)},t);if(r.hasValue)return r.value;var i=e.apply(null,n);return r.setValue(i)}return n.clear=t.clear.bind(t),n};function Af(e){if(void 0!==e){switch(e){case WebGLRenderingContext.NEAREST:return"nearest";case WebGLRenderingContext.LINEAR:return"linear";case WebGLRenderingContext.NEAREST_MIPMAP_NEAREST:return"nearest mipmap nearest";case WebGLRenderingContext.NEAREST_MIPMAP_LINEAR:return"nearest mipmap linear";case WebGLRenderingContext.LINEAR_MIPMAP_NEAREST:return"linear mipmap nearest";case WebGLRenderingContext.LINEAR_MIPMAP_LINEAR:return"linear mipmap linear";case WebGLRenderingContext.REPEAT:return"repeat";case WebGLRenderingContext.CLAMP_TO_EDGE:return"clamp";case WebGLRenderingContext.MIRRORED_REPEAT:return"mirror"}throw new Error(`unhandled constant value ${JSON.stringify(e)}`)}}const jf=e=>{const t=e({primitive:"triangles",blend:Si,uniforms:{globalAlpha:e.context("globalAlpha"),poseMatrix:e.context("poseMatrix"),baseColorTexture:e.prop("baseColorTexture"),baseColorFactor:e.prop("baseColorFactor"),nodeMatrix:e.prop("nodeMatrix"),"light.direction":[0,0,-1],"light.ambientIntensity":.5,"light.diffuseIntensity":.5,hitmapColor:e.context("hitmapColor"),isHitmap:e.context("isHitmap")},attributes:{position:e.prop("positions"),normal:e.prop("normals"),texCoord:e.prop("texCoords")},elements:e.prop("indices"),vert:"\n  uniform mat4 projection, view;\n  uniform mat4 nodeMatrix;\n  uniform mat4 poseMatrix;\n  attribute vec3 position, normal;\n  varying vec3 vNormal;\n  attribute vec2 texCoord;\n  varying vec2 vTexCoord;\n\n  void main() {\n    // using the projection matrix for normals breaks lighting for orthographic mode\n    mat4 mv = view * poseMatrix * nodeMatrix;\n    vNormal = normalize((mv * vec4(normal, 0)).xyz);\n    vTexCoord = texCoord;\n    gl_Position = projection * mv * vec4(position, 1);\n  }\n  ",frag:"\n  precision mediump float;\n  uniform bool isHitmap;\n  uniform vec4 hitmapColor;\n  uniform float globalAlpha;\n  uniform sampler2D baseColorTexture;\n  uniform vec4 baseColorFactor;\n  varying mediump vec2 vTexCoord;\n  varying mediump vec3 vNormal;\n\n  // Basic directional lighting from:\n  // http://ogldev.atspace.co.uk/www/tutorial18/tutorial18.html\n  struct DirectionalLight {\n    mediump vec3 direction;\n    lowp float ambientIntensity;\n    lowp float diffuseIntensity;\n  };\n  uniform DirectionalLight light;\n\n  void main() {\n    vec4 baseColor = texture2D(baseColorTexture, vTexCoord) * baseColorFactor;\n    float diffuse = light.diffuseIntensity * max(0.0, dot(vNormal, -light.direction));\n    gl_FragColor = isHitmap ? hitmapColor : vec4((light.ambientIntensity + diffuse) * baseColor.rgb, baseColor.a * globalAlpha);\n  }\n  "}),n=e.buffer([0,0]),r=e.texture({data:[255,255,255,255],width:1,height:1}),i=Cf(t=>{const{accessors:i}=t,o=t.json.textures&&t.json.textures.map(n=>{const r=n.sampler?t.json.samplers[n.sampler]:(()=>({minFilter:WebGLRenderingContext.NEAREST_MIPMAP_LINEAR,magFilter:WebGLRenderingContext.LINEAR,wrapS:WebGLRenderingContext.REPEAT,wrapT:WebGLRenderingContext.REPEAT}))(),i=t.images&&t.images[n.source];return e.texture({data:i,min:Af(r.minFilter),mag:Af(r.magFilter),wrapS:Af(r.wrapS),wrapT:Af(r.wrapT)})});t.images&&t.images.forEach(e=>e.close());const a=[];function s(e,c){const u=e.matrix?(f=e.matrix,(l=new br(16))[0]=f[0],l[1]=f[1],l[2]=f[2],l[3]=f[3],l[4]=f[4],l[5]=f[5],l[6]=f[6],l[7]=f[7],l[8]=f[8],l[9]=f[9],l[10]=f[10],l[11]=f[11],l[12]=f[12],l[13]=f[13],l[14]=f[14],l[15]=f[15],l):kr(yr(),e.rotation||[0,0,0,1],e.translation||[0,0,0],e.scale||[1,1,1]);var f,l;if(Or(u,c,u),null!=e.mesh&&function(e,s){for(const c of e.primitives){const e=t.json.materials[c.material],u=e.pbrMetallicRoughness.baseColorTexture;if(!i)throw new Error("Error decoding GLB model: Missing `accessors` in JSON data");a.push({indices:i[c.indices],positions:i[c.attributes.POSITION],normals:i[c.attributes.NORMAL],texCoords:u?i[c.attributes[`TEXCOORD_${u.texCoord||0}`]]:{divisor:1,buffer:n},baseColorTexture:u?o[u.index]:r,baseColorFactor:e.pbrMetallicRoughness.baseColorFactor||[1,1,1,1],nodeMatrix:s})}}(t.json.meshes[e.mesh],u),e.children)for(const n of e.children)s(t.json.nodes[n],u)}for(const e of t.json.scenes[(({json:e})=>{var t;if(null!=e.scene)return e.scene;const n=Object.keys(null!==(t=e.scenes)&&void 0!==t?t:{});if(0===n.length)throw new Error("No scenes to render");return n[0]})(t)].nodes){const n=yr();Ar(n,n,Math.PI/2),jr(n,n,Math.PI/2),s(t.json.nodes[e],n)}return a}),a=e({context:{poseMatrix:(e,t)=>kr(yr(),hi(t.pose.orientation),pi(t.pose.position),t.scale?pi(t.scale):[1,1,1]),globalAlpha:(e,t)=>null==t.alpha?1:t.alpha,hitmapColor:(e,t)=>t.color||[0,0,0,1],isHitmap:(e,t)=>!!t.isHitmap}});return(e,n)=>{const r=i(e.model);a(n?o({},e,{isHitmap:n}):e,()=>{t(r)})}};function Sf(e){return t.useDebugValue(e),function(e,n){const[r,i]=t.useState();return t.useEffect(t.useCallback(()=>{let t=!1;return e().then(e=>{t||i(e)}),()=>{t=!0,i(void 0)}},n||[e]),n||[e]),r}(async()=>{if("function"==typeof e)return e();if("string"==typeof e){const t=await fetch(e);if(!t.ok)throw new Error(`failed to fetch GLTF model: ${t.status}`);return sa(await t.arrayBuffer())}throw new Error(`unsupported model prop: ${typeof e}`)},[e])}const kf=[.3,.3,.3,1];function Ef(){return Ei({vert:"\n    precision mediump float;\n    uniform mat4 projection, view;\n\n    attribute vec3 point;\n    attribute vec4 color;\n    varying vec4 fragColor;\n\n    void main () {\n      fragColor = color;\n      vec3 p = point;\n      gl_Position = projection * view * vec4(p, 1);\n    }\n    ",frag:"\n      precision mediump float;\n      varying vec4 fragColor;\n      void main () {\n        gl_FragColor = fragColor;\n      }\n    ",primitive:"lines",attributes:{point:(e,t)=>{const n=[],r=t.count;for(let e=-t.count;e<t.count;e++)n.push([-r,e,0]),n.push([r,e,0]),n.push([e,-r,0]),n.push([e,r,0]);return n},color:(e,t)=>{const n=t.color||kf;return new Array(4*t.count*2).fill(n)}},count:(e,t)=>{return 4*t.count*2}})}function Of(e){let{count:t}=e,i=qc(e,["count"]);const o={count:t};return n.createElement(Uo,r({getChildrenForHitmap:Rs},i,{reglCommand:Ef}),o)}Of.defaultProps={count:6};const Mf=({useWorldSpaceSize:e})=>t=>{const[n,r]=t.limits.pointSizeDims;return Ei({primitive:"points",vert:"\n    precision mediump float;\n\n    #WITH_POSE\n\n    uniform mat4 projection, view;\n    uniform float pointSize;\n    uniform bool useWorldSpaceSize;\n    uniform float viewportWidth;\n    uniform float viewportHeight;\n    uniform float minPointSize;\n    uniform float maxPointSize;\n\n    attribute vec3 point;\n    attribute vec4 color;\n    varying vec4 fragColor;\n    void main () {\n      vec3 pos = applyPose(point);\n      gl_Position = projection * view * vec4(pos, 1);\n      fragColor = color;\n\n      if (useWorldSpaceSize) {\n        // Calculate the point size based on world dimensions:\n        // First, we need to compute a new point that is one unit away from\n        // the center of the current point being rendered. We do it in view space\n        // in order to make sure the new point is always one unit up and it's not\n        // affected by view rotation.\n        vec4 up = projection * (view * vec4(pos, 1.0) + vec4(0.0, 1.0, 0.0, 0.0));\n\n        // Then, we compute the distance between both points in clip space, dividing\n        // by the w-component to account for distance in perspective projection.\n        float d = length(up.xyz / up.w - gl_Position.xyz / gl_Position.w);\n\n        // Finally, the point size is calculated using the size of the render target\n        // and it's aspect ratio. We multiply it by 0.5 since distance in clip space\n        // is in range [0, 2] (because clip space's range is [-1, 1]) and\n        // we need it to be [0, 1].\n        float invAspect = viewportHeight / viewportWidth;\n        gl_PointSize = pointSize * 0.5 * d * viewportWidth * invAspect;\n      } else {\n        gl_PointSize = pointSize;\n      }\n\n      // Finally, ensure the calculated point size is within the limits.\n      gl_PointSize = min(maxPointSize, max(minPointSize, gl_PointSize));\n    }\n    ",frag:"\n    precision mediump float;\n    varying vec4 fragColor;\n    void main () {\n      gl_FragColor = vec4(fragColor.x, fragColor.y, fragColor.z, 1);\n    }\n    ",attributes:{point:(e,t)=>t.points.map(e=>Array.isArray(e)?e:pi(e)),color:(e,t)=>{return Oi(t)}},uniforms:{pointSize:(e,t)=>t.scale.x||1,useWorldSpaceSize:!!e,viewportWidth:t.context("viewportWidth"),viewportHeight:t.context("viewportHeight"),minPointSize:n,maxPointSize:r},count:t.prop("points.length")})},Pf=Ws(1);return e.Worldview=ra,e.OffscreenWorldview=na,e.default=ra,e.Bounds=class{constructor(){i(this,"x",void 0),i(this,"y",void 0),i(this,"z",void 0),this.x=new ia,this.y=new ia,this.z=new ia}update(e){this.x.update(e.x),this.y.update(e.y),this.z.update(e.z)}},e.camera=vo,e.cameraStateSelectors=$i,e.CameraStore=Qi,e.DEFAULT_CAMERA_STATE=Xi,e.CameraListener=Io,e.eulerFromQuaternion=function(e,t){const n=function(e,t){var n=t[0],r=t[1],i=t[2],o=t[3],a=n+n,s=r+r,c=i+i,u=n*a,f=r*a,l=r*s,p=i*a,h=i*s,d=i*c,m=o*a,v=o*s,g=o*c;return e[0]=1-l-d,e[3]=f-g,e[6]=p+v,e[1]=f+g,e[4]=1-u-d,e[7]=h-m,e[2]=p-v,e[5]=h+m,e[8]=1-u-l,e}(oa,t),r=n[0],i=n[3],o=n[6],a=n[4],s=n[7],c=n[5],u=n[8];return e[1]=Math.asin(o<-1?-1:o>1?1:o),Math.abs(o)<.99999?(e[0]=Math.atan2(-s,u),e[2]=Math.atan2(-i,r)):(e[0]=Math.atan2(c,a),e[2]=0),e},e.fromGeometry=aa,e.parseGLB=sa,e.WorldviewReactContext=No,e.pointToVec3=pi,e.orientationToVec4=hi,e.vec3ToPoint=di,e.vec4ToOrientation=mi,e.pointToVec3Array=vi,e.toRGBA=gi,e.vec4ToRGBA=bi,e.toColor=yi,e.getCSSColor=xi,e.defaultReglBlend=Ci,e.defaultReglDepth=Ai,e.defaultDepth=ji,e.defaultBlend=Si,e.blend=ki,e.withPose=Ei,e.getVertexColors=Oi,e.colorBuffer=Mi,e.shouldConvert=Pi,e.intToRGB=Ti,e.getIdFromColor=function(e){const t=255*e[0],n=255*e[1];return 255*e[2]|n<<8|t<<16},e.getIdFromPixel=Di,e.fromSpherical=zi,e.Ray=Ho,e.getRayFromClick=Wo,e.Arrows=ic,e.makeArrowsCommand=(()=>e=>{const t=qs(e),n=Js(e);return e=>{const{cylinders:r,cones:i}=rc(e);t(r),n(i)}}),e.Axes=vc,e.Command=Uo,e.SUPPORTED_MOUSE_EVENTS=["onClick","onMouseUp","onMouseMove","onMouseDown","onDoubleClick"],e.Cones=tc,e.cones=Js,e.Cubes=function(e){return t.createElement(Uo,r({getChildrenForHitmap:bc},e,{reglCommand:gc}))},e.cubes=gc,e.Cylinders=Ys,e.cylinders=qs,e.DrawPolygons=function({children:e=[]}){return 0===e.length?null:n.createElement(n.Fragment,null,n.createElement(Rc,null,e),n.createElement(Hc,null,e))},e.Polygon=Ic,e.PolygonPoint=Fc,e.PolygonBuilder=class{constructor(e=[]){i(this,"mouseDown",!1),i(this,"polygons",void 0),i(this,"onChange",()=>{}),i(this,"activePolygon",void 0),i(this,"activePoint",void 0),i(this,"mouseDownPoint",void 0),i(this,"onMouseMove",(e,t)=>{if(this.activePolygon&&(e.preventDefault(),e.stopPropagation()),!this.mouseDown)return;if(!t)return;if(!this.activePoint&&!this.activePolygon)return;const{ray:n}=t,r=n.planeIntersection([0,0,0],[0,0,1]);if(!r)return;const{activePolygon:i}=this;if(this.activePoint)this.updateActivePoint(r);else if(i&&this.mouseDownPoint){const[e,t]=r,[n,o]=this.mouseDownPoint,a=e-n,s=t-o;this.mouseDownPoint=r;const c=i.points.reduce((e,t)=>(e.includes(t)||e.push(t),e),[]);for(const e of c){const{point:t}=e;t[0]=t[0]+a,t[1]=t[1]+s}this.onChange()}}),i(this,"onKeyDown",e=>{const{activePolygon:t}=this;if(t)switch(e.key){case"Delete":case"Backspace":this.activePoint?this.deletePoint(this.activePoint):this.deletePolygon(t),this.onChange()}}),i(this,"onMouseUp",(e,t)=>{e.ctrlKey||(this.mouseDown=!1)}),i(this,"onDoubleClick",(e,t)=>{if(!t)return;if(!t.objects.length)return;if(this.selectObject(t.objects[0].object),this.activePoint)return void this.deletePoint(this.activePoint);const{activePolygon:n}=this;if(!n)return;let r=Number.MAX_SAFE_INTEGER,i=-1;const{ray:o}=t,a=o.planeIntersection([0,0,0],[0,0,1]);if(!a)return;const[s,c]=a,{points:u}=n;for(let e=0;e<u.length-1;e++){const t=u[e],n=u[e+1],[o,a]=t.point,[f,l]=n.point,p=Gc.squared(o,a,f,l,s,c);p<r&&(r=p,i=e)}if(i>-1){const e=new Fc(a);n.points.splice(i+1,0,e),this.activePoint=e}this.onChange()}),i(this,"onMouseDown",(e,t)=>{if(!t)return;const{ray:n}=t,r=n.planeIntersection([0,0,0],[0,0,1]);if(!r)return;const i=!this.mouseDown;this.mouseDown=!0,this.mouseDownPoint=r;const o=e.ctrlKey;if(i&&!o){const e=t.objects[0];return this.selectObject(e&&e.object),this.onChange()}return o?(this.pushPoint(r),this.onChange()):(this.closeActivePolygon(),this.onChange())}),this.polygons=e}isActivePolygonClosed(){return!!this.activePolygon&&Vc(this.activePolygon)}addPolygon(e){const{points:t,name:n}=e;if(t.length<3)return;this.selectObject();const r=new Ic(n);r.points=t.map(e=>new Fc([e.x,e.y,e.z||0])),Vc(r)||r.points.push(r.points[0]),this.polygons.push(r)}pushPoint(e){const{activePolygon:t}=this;if(t&&!Vc(t)){const n=new Fc(e);return t.points.push(n),void this.selectObject(n)}const n=new Ic;n.points.push(new Fc(e));const r=new Fc(e);n.points.push(r),this.polygons.push(n),this.selectObject(r),this.onChange()}updateActivePoint(e){this.activePoint&&(this.activePoint.point=e,this.onChange())}closeActivePolygon(){const e=this.activePolygon;e&&(2===e.points.length?this.deletePolygon(e):e.points.push(e.points[0]),this.onChange())}deletePolygon(e){this.polygons=this.polygons.filter(t=>t!==e),this.activePolygon=null}deletePoint(e){const{activePolygon:t}=this;if(!t)return;const n=t.points.filter(t=>t.id!==e.id);n.length===t.points.length-2&&n.push(n[0]),t.points=n,this.activePoint=null,t.points.length<4&&this.deletePolygon(t),this.onChange()}selectObject(e){this.activePolygon=null,this.activePoint&&(this.activePoint.active=!1),this.activePoint=null;for(const t of this.polygons){let n=t===e;t.active=n,n&&(this.activePolygon=t);for(const r of t.points)r===e&&(this.activePoint=r,r.active=!0,t.active=!0,this.activePolygon=t,n=!0)}this.onChange()}},e.FilledPolygons=function(e){let{children:t=[]}=e,i=qc(e,["children"]);const o=Tu(t);return n.createElement(Eu,r({getChildrenForHitmap:Ls},i),o)},e.makeFilledPolygonsCommand=(()=>e=>{const t=Su()(e);return e=>{t(Tu(e),!1)}}),e.GLText=function(e){const[i]=t.useState(()=>xf(e)),o=Ws(1);return n.createElement(Uo,r({getChildrenForHitmap:o,reglCommand:i},e))},e.makeGLTextCommand=xf,e.GLTFScene=function(e){const{children:i,model:a}=e,s=qc(e,["children","model"]),c=t.useContext(No),u=Sf(a);return t.useEffect(()=>{c&&c.onDirty()},[c,u]),u?n.createElement(Uo,r({},s,{reglCommand:jf,getChildrenForHitmap:Ls}),o({},i,{model:u,originalMarker:i})):null},e.Grid=Of,e.Lines=pc,e.lines=lc,e.Overlay=class extends t.Component{constructor(...e){super(...e),i(this,"_context",void 0),i(this,"state",{items:[]}),i(this,"componentWillUnmount",()=>{this._context&&this._context.unregisterPaintCallback(this.paint)}),i(this,"paint",()=>{const e=this._context,t=e&&e.dimension,{renderItem:n,children:r}=this.props;if(!e||!t)return;const i=r.map((r,i)=>{const o=this.project(r.pose.position,e);return n({item:r,index:i,coordinates:o,dimension:t})});this.setState({items:i})}),i(this,"project",(e,t)=>{if(!t||!t.initializedData)return;const{dimension:n}=t,{camera:r}=t.initializedData,i=[e.x,e.y,e.z],{left:o,top:a,width:s,height:c}=n,u=[o,a,s,c];return r.toScreenCoord(u,i)})}componentDidMount(){this._context&&this._context.registerPaintCallback(this.paint)}render(){return t.createElement(t.Fragment,null,t.createElement(No.Consumer,null,e=>(e&&(this._context=e),this.state.items)))}},e.Points=function(e){const[i]=t.useState(()=>Mf(e));return n.createElement(Uo,r({getChildrenForHitmap:Pf},e,{reglCommand:i}))},e.makePointsCommand=Mf,e.Spheres=Cc,e.spheres=wc,e.Text=sf,e.Triangles=Eu,e.makeTrianglesCommand=Su,e.nonInstancedGetChildrenForHitmap=Rs,e.getChildrenForHitmapWithOriginalMarker=Ls,e.createInstancedGetChildrenForHitmap=Ws,e}({},React);
//# sourceMappingURL=index.umd.js.map
